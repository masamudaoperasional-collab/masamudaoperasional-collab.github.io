<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Keuangan Terpadu</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- Import Font dari Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        /* --- CSS Variables untuk Tema yang Konsisten --- */
        :root {
            --primary-color: #4361ee;
            --primary-light: #4895ef;
            --secondary-color: #3f37c9;
            --background-color: #f8f9fa;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --text-dark: #212529;
            --text-light: #6c757d;
            --border-color: #e9ecef;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;

            --font-family: 'Poppins', sans-serif;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
            --transition-speed: 0.3s ease;
        }

        /* --- Reset & Gaya Global --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* --- Struktur Layout Utama --- */
        .app-layout { 
            display: none; /* Sembunyikan dulu, akan ditampilkan setelah login */
            display: flex; /* Ubah ini menjadi flex */
            min-height: 100vh; 
        }

        /* --- Sidebar Navigasi --- */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            transition: width var(--transition-speed);
        }
        .sidebar-header { padding: 0 24px; margin-bottom: 24px; }
        .sidebar-header h3 { font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 10px;}
        .sidebar-nav { display: flex; flex-direction: column; gap: 8px; padding: 0 16px; flex: 1; }
        .nav-link {
            display: flex; align-items: center; gap: 16px; padding: 12px 16px;
            border-radius: 8px; color: var(--text-light); text-decoration: none;
            font-weight: 500; transition: var(--transition-speed); cursor: pointer;
        }
        .nav-link i { width: 20px; text-align: center; }
        .nav-link:hover { background-color: rgba(67, 97, 238, 0.08); color: var(--primary-color); }
        .nav-link.active { background-color: var(--primary-color); color: white; font-weight: 600; }

        /* --- Konten Utama --- */
        .main-content { flex-grow: 1; padding: 24px; overflow-y: auto; }
        .content-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; flex-wrap: wrap; gap: 16px;
        }
        #page-title { font-size: 1.8rem; font-weight: 700; }
        .filter-container { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .date-filter { display: flex; align-items: center; gap: 8px; }
        #custom-date-filter { display: none; }

        /* --- Sistem Halaman (Pages) --- */
        .page { display: none; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Komponen UI Reusable --- */
        .card {
            background-color: var(--card-bg); border-radius: var(--border-radius);
            box-shadow: var(--card-shadow); margin-bottom: 24px;
        }
        .card-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); font-size: 1.1rem; font-weight: 600; }
        .card-body { padding: 24px; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; font-family: var(--font-family);
            font-weight: 500; cursor: pointer; transition: var(--transition-speed);
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(67, 97, 238, 0.2); }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .form-control {
            padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px;
            font-family: var(--font-family); font-size: 0.95rem;
        }
        .form-control:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        .commission-input {
            width: 70px;
            padding: 6px 8px;
            text-align: right;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        /* --- Tabel --- */
        .table-responsive { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .table th { background-color: #f1f5fd; font-weight: 600; }
        .table tbody tr { transition: background-color 0.2s; }
        .table tbody tr:not(.no-hover):hover { background-color: #f8fafd; cursor: pointer; }
        .table .action-btn { 
            background: none; border: none; cursor: pointer; 
            color: var(--primary-color); font-size: 1rem; padding: 4px 8px;
        }
        .table .action-btn:hover { color: var(--secondary-color); background-color: rgba(67, 97, 238, 0.1); border-radius: 4px; }

        /* --- Grid Layouts --- */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .analysis-grid {
            display: grid;
            grid-template-columns: 55% 45%;
            gap: 24px;
            align-items: start;
        }

        /* --- Komponen Spesifik --- */
        .metric-item { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 24px; transition: transform 0.2s; }
        .metric-item:hover { transform: translateY(-4px); }
        .metric-item p { font-size: 0.9rem; color: var(--text-light); margin-bottom: 8px; }
        .metric-item h2 { font-size: 1.8rem; font-weight: 700; word-break: break-all;}
        .category-list-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .category-list-item:hover { background-color: #f8fafd; }
        .category-name { font-weight: 500; }
        .category-amount { font-weight: 600; color: var(--primary-color); }

        /* --- Placeholder Loading --- */
        .loading-placeholder {
            background-color: #e0e0e0; border-radius: 6px;
            min-height: 28px; width: 60%;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- Accordion Styling --- */
        .accordion-item { border-bottom: 1px solid var(--border-color); }
        .accordion-header {
            width: 100%; background: none; border: none; text-align: left;
            padding: 16px; font-size: 1rem; font-weight: 600; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .accordion-header:hover { background-color: #f8fafd; }
        .accordion-header::after { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; transition: transform 0.2s; }
        .accordion-header.active::after { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #fafbff; }
        
        /* --- Modal/Popup Styling --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: #fff; margin: auto; padding: 0;
            border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%; max-width: 900px; animation: slideIn 0.3s;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-light); }
        .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Detail View Styling --- */
        .detail-section { margin-bottom: 20px; padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fafbff; }
        .detail-section h4 { margin-bottom: 12px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { font-size: 0.8rem; color: var(--text-light); margin-bottom: 4px; }
        .detail-value { font-weight: 500; }

        /* --- Helper Classes --- */
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .placeholder-text { color: var(--text-light); font-style: italic; text-align: center; padding: 20px;}
        
        /* --- Loading Overlay --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column; gap: 16px;
        }
        .loading-spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Notification Styling --- */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.warning { background-color: var(--warning-color); color: var(--text-dark); }

        /* --- Login Page Styling --- */
        .login-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            font-family: var(--font-family);
        }
        .login-container { width: 100%; max-width: 400px; padding: 20px; }
        .login-card {
            background-color: var(--card-bg); border-radius: var(--border-radius);
            box-shadow: var(--card-shadow); padding: 40px 30px; text-align: center;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .login-header { margin-bottom: 30px; }
        .login-header i { font-size: 3rem; color: var(--primary-color); margin-bottom: 15px; }
        .login-header h2 { color: var(--text-dark); margin-bottom: 10px; font-weight: 700; }
        .login-header p { color: var(--text-light); font-size: 0.9rem; }
        .login-form { text-align: left; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); }
        .password-input-container { position: relative; display: flex; align-items: center; }
        .password-input-container .form-control { padding-right: 45px; width: 100%; }
        .toggle-password {
            position: absolute; right: 12px; background: none; border: none;
            color: var(--text-light); cursor: pointer; padding: 5px; border-radius: 4px; transition: color 0.2s;
        }
        .toggle-password:hover { color: var(--primary-color); background-color: rgba(67, 97, 238, 0.1); }
        .login-btn { width: 100%; padding: 12px; font-size: 1rem; margin-top: 10px; }
        .error-message {
            background-color: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.2);
            border-radius: 8px; padding: 12px; margin-top: 15px; display: flex;
            align-items: center; gap: 10px; color: var(--danger-color); font-size: 0.9rem;
        }
        .error-message i { font-size: 1rem; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s ease-in-out; }

        /* --- Media Queries --- */
        @media (max-width: 1200px) { .chart-grid, .analysis-grid { grid-template-columns: 1fr; } }
        @media (max-width: 992px) {
            .app-layout { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; border-right: none; border-bottom: 1px solid var(--border-color); padding: 8px 16px; align-items: center; }
            .sidebar-header { margin-bottom: 0; }
            .sidebar-header h3 { font-size: 1.2rem; }
            .sidebar-nav { flex-direction: row; gap: 0; overflow-x: auto; }
            .nav-link span { display: none; }
            .main-content { padding: 16px; }
        }
        @media (max-width: 768px) {
            .content-header { flex-direction: column; align-items: flex-start; }
            .filter-container { width: 100%; flex-direction: column; align-items: stretch; }
            .detail-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .login-container { padding: 15px; }
            .login-card { padding: 30px 20px; }
            .login-header h2 { font-size: 1.5rem; }
        }
        
        /* --- Tombol Print --- */
        .print-btn {
            background-color: #17a2b8; color: white;
        }
        .print-btn:hover {
            background-color: #138496;
        }

        /* --- === PRINT STYLES === --- */
        .print-header, .watermark, .financial-highlights, .executive-summary {
            display: none; /* Sembunyikan secara default */
        }

        @media print {
            /* Aturan @page untuk header dan footer */
            @page {
                size: A4 portrait;
                margin: 20mm 15mm;
                
                @top-center {
                    content: "Laporan Keuangan Internal";
                    font-size: 9pt; color: #666;
                    font-family: 'Arial', sans-serif;
                }
                @bottom-right {
                    content: "Halaman " counter(page) " dari " counter(pages);
                    font-size: 9pt; color: #666;
                    font-family: 'Arial', sans-serif;
                }
            }

            /* Reset & Gaya Body untuk Print */
            body {
                font-family: "Arial", "Helvetica", sans-serif !important;
                font-size: 10pt; line-height: 1.4; color: #000 !important;
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Sembunyikan elemen yang tidak perlu */
            .sidebar, .content-header, .nav-link, .btn, .notification, .modal, .login-page, .loading-overlay {
                display: none !important;
            }

            /* Tampilkan layout utama dengan benar */
            .app-layout, .main-content {
                display: block !important;
                padding: 0 !important; margin: 0 !important;
                width: 100% !important;
            }

            /* Tampilkan header cetak */
            .print-header {
                display: block !important; text-align: center;
                margin-bottom: 25px; padding-bottom: 15px;
                border-bottom: 3px double #333;
            }
            .print-title { font-size: 20pt; font-weight: bold; margin-bottom: 8px; color: #2c3e50 !important; }
            .print-subtitle { font-size: 14pt; margin-bottom: 8px; color: #34495e !important; }
            .print-date { font-size: 10pt; color: #7f8c8d !important; font-style: italic; }
            .print-summary { background: #f8f9fa !important; border: 1px solid #ddd !important; padding: 15px; margin: 15px 0; border-radius: 5px; page-break-inside: avoid; }

            /* Watermark */
            .watermark {
                display: block !important; position: fixed;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 70pt; color: rgba(0, 0, 0, 0.08);
                z-index: -1; pointer-events: none; font-weight: bold;
            }
            
            /* Executive Summary & Highlights */
            .executive-summary, .financial-highlights { display: block !important; page-break-inside: avoid; }
            .executive-summary { background: #f8f9fa !important; border-left: 5px solid #3498db !important; padding: 15px; margin: 20px 0; }
            .executive-summary h4 { color: #2c3e50 !important; margin-bottom: 10px; font-size: 12pt; }
            .financial-highlights { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
            .highlight-item { text-align: center; padding: 15px; border: 1px solid #bdc3c7; border-radius: 8px; background: white; }
            .highlight-value { font-size: 14pt; font-weight: bold; color: #2c3e50; margin: 8px 0; }
            .highlight-label { font-size: 9pt; color: #7f8c8d; text-transform: uppercase; font-weight: 600; }

            /* Styling Card */
            .card {
                box-shadow: none !important; border: 1px solid #333 !important;
                margin-bottom: 20px !important; page-break-inside: avoid; break-inside: avoid;
                background: white !important;
            }
            .card-header {
                background: #e9ecef !important; color: #000 !important;
                border-bottom: 2px solid #000 !important; font-size: 12pt !important;
                font-weight: bold; padding: 10px 15px !important;
            }
            .card-body { padding: 15px !important; }

            /* Styling Grid */
            .card-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 15px !important; }
            .chart-grid { grid-template-columns: 1fr !important; gap: 20px !important; }

            /* Styling Metric Item */
            .metric-item {
                border: 1px solid #bdc3c7 !important; padding: 15px !important;
            }
            .metric-item p { font-size: 10pt !important; font-weight: 600; }
            .metric-item h2 { font-size: 16pt !important; }

            /* Styling Tabel */
            .table { border: 1px solid #333 !important; font-size: 9pt !important; }
            .table th { background: #f1f1f1 !important; color: #000 !important; border-bottom: 2px solid #000 !important; font-weight: bold; padding: 8px !important; }
            .table td { border: 1px solid #ddd !important; padding: 6px !important; }
            .table tbody tr:nth-child(even) { background-color: #f8f9fa !important; }
            
            /* Tweak warna agar terbaca */
            .text-success, .text-danger { color: #000 !important; font-weight: bold; }
        }

    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Memuat data...</p>
    </div>

    <div id="notification" class="notification"></div>
    
    <!-- Halaman Login -->
    <div id="login-page" class="login-page">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <i class="fas fa-lock"></i>
                    <h2>Dashboard Keuangan Terpadu</h2>
                    <p>Masukkan password untuk mengakses sistem</p>
                </div>
                <form id="login-form" class="login-form">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
                            <button type="button" id="toggle-password" class="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary login-btn">
                        <i class="fas fa-sign-in-alt"></i> Masuk
                    </button>
                </form>
                <div id="login-error" class="error-message" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Password salah. Silakan coba lagi.</span>
                </div>
                <div style="margin-top: 20px; font-size: 0.8rem; color: var(--text-light);">
                    <p>Password default: <strong>admin123</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout Dashboard -->
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-chart-pie"></i> <span>Analisis Keuangan</span></h3>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i><span>Dashboard Utama</span></a>
                <a class="nav-link" data-page="neraca"><i class="fas fa-balance-scale fa-fw"></i><span>Neraca</span></a>
                <a class="nav-link" data-page="arus-kas"><i class="fas fa-money-bill-wave fa-fw"></i><span>Arus Kas</span></a>
                <a class="nav-link" data-page="transaksi-bank"><i class="fas fa-landmark fa-fw"></i><span>Transaksi Bank</span></a>
                <a class="nav-link" data-page="pengeluaran"><i class="fas fa-receipt fa-fw"></i><span>Pengeluaran</span></a>
                <a class="nav-link" data-page="detail-pengeluaran"><i class="fas fa-clipboard-list fa-fw"></i><span>Detail Pengeluaran</span></a>
                <a class="nav-link" id="logout-btn" style="margin-top: auto;">
                    <i class="fas fa-sign-out-alt fa-fw"></i><span>Logout</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="content-header">
                <h1 id="page-title">Dashboard Utama</h1>
                <div class="filter-container">
                    <select id="date-range-selector" class="form-control">
                        <option value="all" selected>Semua Waktu</option>
                        <option value="30d">30 Hari Terakhir</option>
                        <option value="15d">15 Hari Terakhir</option>
                        <option value="7d">7 Hari Terakhir</option>
                        <option value="this_month">Bulan Ini</option>
                        <option value="last_month">Bulan Lalu</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div id="custom-date-filter" class="date-filter">
                        <input type="date" id="start-date" class="form-control">
                        <input type="date" id="end-date" class="form-control">
                    </div>
                    <button id="apply-filter" class="btn btn-primary"><i class="fas fa-filter"></i> Terapkan</button>
                    <button id="refresh-data" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Refresh</button>
                    <button id="print-page" class="btn print-btn" style="display: none;"><i class="fas fa-print"></i> Print Laporan</button>
                </div>
            </header>

            <div id="error-container"></div>

            <div class="page-container">
                <!-- Semua div .page akan diisi oleh JavaScript -->
                <div id="page-dashboard" class="page active">
                    <section class="card-grid" id="dashboard-kpi-container"></section>
                    <div class="chart-grid">
                        <section class="card"><div class="card-header"><h3>Komposisi Pengeluaran</h3></div><div class="card-body" id="dashboard-expense-category-chart"></div></section>
                        <section class="card"><div class="card-header"><h3>Tren Laba/Rugi Harian</h3></div><div class="card-body" id="dashboard-profit-trend-chart"></div></section>
                    </div>
                    <section class="card"><div class="card-header"><h3>Pengeluaran Berdasarkan Kategori</h3></div><div id="dashboard-top-expenses-table"></div></section>
                </div>
                <div id="page-neraca" class="page">
                    <section class="card"><div class="card-header"><h3>Ringkasan Keuangan</h3></div><div class="card-body card-grid" id="neraca-summary-section1"></div></section>
                    <section class="card"><div class="card-header"><h3>Ringkasan Aliran Kas Bank</h3></div><div class="card-body card-grid" id="neraca-summary-section2"></div></section>
                    <section class="card"><div class="card-header"><h3>Perbandingan Pendapatan vs Kas Masuk Bank (Harian)</h3></div><div class="card-body" id="neraca-settlement-chart-container"></div></section>
                    <section class="card"><div class="card-header"><h3>Grafik Neraca Keuangan (Akumulatif)</h3></div><div class="card-body" id="neraca-chart-section3"></div></section>
                </div>
                <div id="page-arus-kas" class="page">
                    <section class="card"><div class="card-header"><h3>Grafik Tren Penjualan vs Aliran Kas Harian</h3></div><div class="card-body" id="arus-kas-chart-container"></div></section>
                    <section class="card"><div class="card-header"><h3>Ringkasan Metode Pembayaran & Kalkulator Komisi</h3></div><div class="card-body" id="payment-method-summary-container"></div></section>
                    <section class="card"><div class="card-header"><h3>Tabel Data Penjualan (Closing Sales)</h3></div><div class="table-responsive" id="arus-kas-table-container"></div></section>
                </div>
                <div id="page-transaksi-bank" class="page">
                    <section class="card"><div class="card-header"><h3>Ringkasan Kredit/Debit/Balance</h3></div><div class="card-body card-grid" id="transaksi-bank-summary-container"></div></section>
                    <section class="card"><div class="card-header"><h3>Pengelompokan Berdasarkan Tipe</h3></div><div class="card-body" id="transaksi-bank-grouped-container"></div></section>
                    <section class="card"><div class="card-header"><h3>Tabel Data E-Statement</h3></div><div class="table-responsive" id="transaksi-bank-table-container"></div></section>
                </div>
                <div id="page-pengeluaran" class="page">
                    <section class="card"><div class="card-header"><h3>Pengelompokan per Penerima</h3></div><div class="card-body" id="pengeluaran-grouped-container"></div></section>
                    <section class="card"><div class="card-header"><h3>Tabel Data Pengeluaran (Bank Transaction)</h3></div><div class="table-responsive" id="pengeluaran-table-container"></div></section>
                </div>
                <div id="page-detail-pengeluaran" class="page">
                    <section class="card"><div class="card-header"><h3>Kategori Pengeluaran</h3></div><div class="card-body" id="detail-pengeluaran-summary-container"></div></section>
                    <section class="card"><div class="card-header"><h3>Tabel Data Detail Pengeluaran (Expense Match)</h3></div><div class="table-responsive" id="detail-pengeluaran-table-container"></div></section>
                </div>
            </div>
        </main>
    </div>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Detail</h3>
                <button id="modal-close-btn" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- KODE JAVASCRIPT AKAN DITEMPATKAN DI SINI -->
    <script>
document.addEventListener('DOMContentLoaded', () => {
    // =================================================================================
    // --- PENGATURAN UTAMA & STATE APLIKASI ---
    // =================================================================================
    const WEBHOOK_URLS = {
        sales: 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/closing-sales-summary',
        estatement: 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/e_statement',
        bankTransaction: 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/hookbanktransaction',
        expenseMatch: 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/read-output-formexpense-match'
    };
    
    let masterData = {};
    let filteredData = {};
    let chartInstances = {};
    let currentPaymentSummary = {};
    const VALID_PASSWORD = "admin123";

    // =================================================================================
    // --- SISTEM AUTENTIKASI ---
    // =================================================================================
    function setupAuth() {
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password');
        const errorDiv = document.getElementById('login-error');
        const toggleBtn = document.getElementById('toggle-password');

        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.querySelector('i').className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
            });
        }
        
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (passwordInput.value === VALID_PASSWORD) {
                    sessionStorage.setItem('isAuthenticated', 'true');
                    document.getElementById('login-page').style.display = 'none';
                    document.querySelector('.app-layout').style.display = 'flex';
                    showNotification('Login berhasil!', 'success');
                    await initializeMainApp();
                } else {
                    errorDiv.style.display = 'flex';
                    loginForm.classList.add('shake');
                    setTimeout(() => loginForm.classList.remove('shake'), 500);
                }
            });
        }
    }

    function checkAuthStatus() {
        if (sessionStorage.getItem('isAuthenticated') === 'true') {
            document.getElementById('login-page').style.display = 'none';
            document.querySelector('.app-layout').style.display = 'flex';
            initializeMainApp();
        } else {
            document.getElementById('login-page').style.display = 'flex';
            document.querySelector('.app-layout').style.display = 'none';
        }
    }

    function logout() {
        sessionStorage.removeItem('isAuthenticated');
        checkAuthStatus();
        showNotification('Anda telah logout', 'warning');
    }

    // =================================================================================
    // --- INISIALISASI APLIKASI UTAMA ---
    // =================================================================================
    async function initializeMainApp() {
        showLoading(true);
        setupEventListeners();
        handleDateRangeChange(); // Set tanggal default
        await fetchAllData();
        applyFiltersAndRender();
        showLoading(false);
    }

    function setupEventListeners() {
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.id !== 'logout-btn') {
                link.addEventListener('click', e => navigateTo(e.currentTarget.dataset.page));
            }
        });
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('date-range-selector').addEventListener('change', handleDateRangeChange);
        document.getElementById('apply-filter').addEventListener('click', applyFiltersAndRender);
        document.getElementById('refresh-data').addEventListener('click', async () => {
            await fetchAllData();
            applyFiltersAndRender();
        });
        document.getElementById('print-page').addEventListener('click', handlePrint);
        
        document.body.addEventListener('click', handleDynamicClicks);
        document.body.addEventListener('input', e => {
            if (e.target.classList.contains('commission-input')) handleCommissionInputChange(e);
        });

        const modal = document.getElementById('modal');
        document.getElementById('modal-close-btn').addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('show'); });
    }

    // =================================================================================
    // --- FETCH & PARSE DATA ---
    // =================================================================================
    async function fetchData(url) {
        try {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            return Array.isArray(data) ? data : data.data || [data];
        } catch (e) {
            console.error(`Fetch error dari ${url}:`, e);
            showNotification(`Gagal memuat dari ${url}`, 'error');
            return [];
        }
    }

    async function fetchAllData() {
        showLoading(true);
        const [sales, estatement, bankTransaction, expenseMatch] = await Promise.all([
            fetchData(WEBHOOK_URLS.sales), fetchData(WEBHOOK_URLS.estatement),
            fetchData(WEBHOOK_URLS.bankTransaction), fetchData(WEBHOOK_URLS.expenseMatch)
        ]);
        masterData = {
            sales: parseSalesData(sales), estatement: parseEstatementData(estatement),
            bankTransaction: parseBankTransactionData(bankTransaction), expenseMatch: parseExpenseMatchData(expenseMatch),
        };
        showNotification('Data berhasil dimuat ulang', 'success');
        showLoading(false);
    }
    
    // Fungsi-fungsi parsing (parseSalesData, parseEstatementData, dll.)
    const parseCurrency = val => parseFloat(String(val).replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
    const parseDate = dateStr => {
        if (!dateStr || typeof dateStr !== 'string') return null;
        const [y, m, d] = dateStr.split('T')[0].split('-').map(p => parseInt(p, 10));
        return (!isNaN(y) && !isNaN(m) && !isNaN(d)) ? new Date(Date.UTC(y, m - 1, d)) : null;
    };

    function parseSalesData(data) {
        return (data || []).map(item => ({...item, date: parseDate(item.tanggal), total_penjualan: parseCurrency(item.total_penjualan), total_diharapkan: parseCurrency(item.total_diharapkan), kas_masukkeluar: parseCurrency(item['kas_ masukkeluar']), diskon_bill: parseCurrency(item.diskon_bill), kas_akhir: parseCurrency(item.kas_akhir), metode_pembayaran_parsed: JSON.parse(item.metode_pembayaran_json || '[]'), item_aruskas_parsed: JSON.parse(item.item_aruskas || '[]') }));
    }
    function parseEstatementData(data) {
        return (data || []).map(item => ({...item, date: parseDate(item.date), amount_numeric: parseCurrency(item.amount_numeric || item.amount), balance_numeric: parseCurrency(item.balance_numeric) }));
    }
    function parseBankTransactionData(data) {
        return (data || []).map(item => ({...item, date: parseDate(item.tanggal), nominal_transfer: parseCurrency(item.nominal_transfer), biaya_transfer: parseCurrency(item.biaya_transfer), total_transaksi: parseCurrency(item.total_transaksi) }));
    }
    function parseExpenseMatchData(data) {
        return (data || []).map(item => ({...item, date: parseDate(item.trx_date), displayAmount: parseCurrency(item.exp_total_amount) || parseCurrency(item.trx_amount), parsedItems: JSON.parse(item.exp_items_json || '[]'), displayCategory: item.exp_category || 'Lainnya' }));
    }

    // =================================================================================
    // --- LOGIKA UTAMA APLIKASI (Filter, Navigasi, Render) ---
    // =================================================================================
    function handleDateRangeChange() {
        const selector = document.getElementById('date-range-selector');
        document.getElementById('custom-date-filter').style.display = selector.value === 'custom' ? 'flex' : 'none';
        if (selector.value === 'custom') return;

        let startDate = new Date();
        let endDate = new Date();
        if (selector.value === '7d') startDate.setDate(startDate.getDate() - 7);
        else if (selector.value === '30d') startDate.setDate(startDate.getDate() - 30);
        else if (selector.value === 'this_month') startDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
        else if (selector.value === 'last_month') {
            startDate = new Date(startDate.getFullYear(), startDate.getMonth() - 1, 1);
            endDate = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
        } else if (selector.value === 'all') {
            startDate = new Date('2000-01-01');
        }
        document.getElementById('start-date').valueAsDate = startDate;
        document.getElementById('end-date').valueAsDate = endDate;
    }

    function applyFiltersAndRender() {
        const startDate = document.getElementById('start-date').valueAsDate;
        const endDate = document.getElementById('end-date').valueAsDate;
        if (!startDate || !endDate) return;
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
        
        filteredData = {};
        for (const key in masterData) {
            filteredData[key] = (masterData[key] || []).filter(item => item.date && item.date >= startDate && item.date <= endDate);
        }
        renderActivePage();
    }

    function navigateTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
        document.getElementById('page-title').textContent = document.querySelector(`.nav-link.active span`)?.textContent || "Dashboard";
        togglePrintButton();
        renderActivePage();
    }
        
    function renderActivePage() {
        const activePageId = document.querySelector('.page.active')?.id;
        if (!activePageId) return;

        const pageRenderers = {
            'page-dashboard': renderDashboardPage, 'page-neraca': renderNeracaPage,
            'page-arus-kas': renderArusKasPage, 'page-transaksi-bank': renderTransaksiBankPage,
            'page-pengeluaran': renderPengeluaranPage, 'page-detail-pengeluaran': renderDetailPengeluaranPage,
        };

        if (pageRenderers[activePageId]) {
            pageRenderers[activePageId]();
        }
    }

    // =================================================================================
    // --- FUNGSI-FUNGSI RENDER HALAMAN ---
    // =================================================================================
    function renderDashboardPage() {
        const totalPendapatan = filteredData.sales?.reduce((s, i) => s + i.total_diharapkan, 0) || 0;
        const totalPengeluaran = filteredData.expenseMatch?.reduce((s, i) => s + i.displayAmount, 0) || 0;
        const labaRugi = totalPendapatan - totalPengeluaran;
        const arusKasBersih = (filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'CR').reduce((s, t) => s + t.amount_numeric, 0) || 0) - (filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'DB').reduce((s, t) => s + t.amount_numeric, 0) || 0);

        document.getElementById('dashboard-kpi-container').innerHTML = `
            <div class="metric-item"><p>Total Pendapatan</p><h2>${formatCurrency(totalPendapatan)}</h2></div>
            <div class="metric-item"><p>Total Pengeluaran</p><h2>${formatCurrency(totalPengeluaran)}</h2></div>
            <div class="metric-item"><p>Laba / Rugi</p><h2 class="${labaRugi >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(labaRugi)}</h2></div>
            <div class="metric-item"><p>Arus Kas Bersih (Bank)</p><h2 class="${arusKasBersih >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(arusKasBersih)}</h2></div>`;

        const expenseByCategory = (filteredData.expenseMatch || []).reduce((acc, item) => {
            acc[item.displayCategory] = (acc[item.displayCategory] || 0) + item.displayAmount;
            return acc;
        }, {});
        
        createOrUpdateChart('dashboard-expense-category-chart', 'doughnut', { labels: Object.keys(expenseByCategory), datasets: [{ data: Object.values(expenseByCategory) }] });
        
        const dailyProfit = {};
        (filteredData.sales || []).forEach(s => { const k = s.date.toISOString().split('T')[0]; dailyProfit[k] = (dailyProfit[k] || 0) + s.total_diharapkan; });
        (filteredData.expenseMatch || []).forEach(e => { const k = e.date.toISOString().split('T')[0]; dailyProfit[k] = (dailyProfit[k] || 0) - e.displayAmount; });
        const sortedDates = Object.keys(dailyProfit).sort();
        createOrUpdateChart('dashboard-profit-trend-chart', 'line', { labels: sortedDates.map(d => new Date(d).toLocaleDateString('id-ID', {timeZone: 'UTC'})), datasets: [{ label: 'Laba/Rugi Harian', data: sortedDates.map(d => dailyProfit[d]) }] });
        
        const sortedCategories = Object.entries(expenseByCategory).sort(([,a], [,b]) => b - a);
        document.getElementById('dashboard-top-expenses-table').innerHTML = sortedCategories.map(([cat, amount]) => `
            <div class="category-list-item" data-action="view-category-expenses" data-category="${cat}">
                <span class="category-name">${cat}</span><span class="category-amount">${formatCurrency(amount)}</span>
            </div>`).join('');
    }
    
    function renderNeracaPage() {
        const totalPendapatan = filteredData.sales?.reduce((s, i) => s + i.total_diharapkan, 0) || 0;
        const totalPengeluaran = filteredData.expenseMatch?.reduce((s, i) => s + i.displayAmount, 0) || 0;
        const totalKredit = filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'CR').reduce((s, t) => s + t.amount_numeric, 0) || 0;
        const totalDebit = filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'DB').reduce((s, t) => s + t.amount_numeric, 0) || 0;
        const latestBalance = filteredData.estatement?.sort((a,b) => b.date - a.date)[0]?.balance_numeric || 0;

        document.getElementById('neraca-summary-section1').innerHTML = `<div class="metric-item"><p>Pendapatan</p><h2 class="text-success">${formatCurrency(totalPendapatan)}</h2></div><div class="metric-item"><p>Pengeluaran</p><h2 class="text-danger">${formatCurrency(totalPengeluaran)}</h2></div><div class="metric-item"><p>Laba/Rugi</p><h2 class="${(totalPendapatan-totalPengeluaran) >= 0 ? 'text-success':'text-danger'}">${formatCurrency(totalPendapatan-totalPengeluaran)}</h2></div>`;
        document.getElementById('neraca-summary-section2').innerHTML = `<div class="metric-item"><p>Kas Masuk Bank</p><h2 class="text-success">${formatCurrency(totalKredit)}</h2></div><div class="metric-item"><p>Kas Keluar Bank</p><h2 class="text-danger">${formatCurrency(totalDebit)}</h2></div><div class="metric-item"><p>Saldo Bank</p><h2>${formatCurrency(latestBalance)}</h2></div>`;
        
        const dailyComparison = {};
        (filteredData.sales || []).forEach(s => { const k = s.date.toISOString().split('T')[0]; dailyComparison[k] = {...(dailyComparison[k] || {}), sales: (dailyComparison[k]?.sales || 0) + s.total_diharapkan }; });
        (filteredData.estatement || []).filter(e => e.type?.toUpperCase() === 'CR').forEach(e => { const k = e.date.toISOString().split('T')[0]; dailyComparison[k] = {...(dailyComparison[k] || {}), bankInflow: (dailyComparison[k]?.bankInflow || 0) + e.amount_numeric }; });
        const sortedDates = Object.keys(dailyComparison).sort();
        createOrUpdateChart('neraca-settlement-chart-container', 'line', { labels: sortedDates.map(d => new Date(d).toLocaleDateString('id-ID', {timeZone: 'UTC'})), datasets: [{ label: 'Pendapatan', data: sortedDates.map(d => dailyComparison[d].sales || 0) }, { label: 'Kas Masuk Bank', data: sortedDates.map(d => dailyComparison[d].bankInflow || 0) }] });

        let cumulativeProfit = 0;
        const cumulativeData = {};
        const allDates = [...new Set([...(filteredData.sales||[]).map(s=>s.date.toISOString().split('T')[0]), ...(filteredData.expenseMatch||[]).map(e=>e.date.toISOString().split('T')[0])])].sort();
        allDates.forEach(d => {
            const sales = (filteredData.sales||[]).filter(s=>s.date.toISOString().split('T')[0]===d).reduce((sum,s)=>sum+s.total_diharapkan,0);
            const expenses = (filteredData.expenseMatch||[]).filter(e=>e.date.toISOString().split('T')[0]===d).reduce((sum,e)=>sum+e.displayAmount,0);
            cumulativeProfit += sales - expenses;
            cumulativeData[d] = cumulativeProfit;
        });
        createOrUpdateChart('neraca-chart-section3', 'line', { labels: Object.keys(cumulativeData), datasets: [{ label: 'Akumulasi Laba/Rugi', data: Object.values(cumulativeData) }] });
    }

    // Render functions lainnya (ArusKas, TransaksiBank, dll. sama seperti sebelumnya)
    function renderArusKasPage() { createOrUpdateChart('arus-kas-chart-container', 'bar', { labels: filteredData.sales.map(s => s.date.toLocaleDateString('id-ID',{timeZone:'UTC'})), datasets: [{label: 'Total Penjualan', data: filteredData.sales.map(s => s.total_diharapkan)}, {label:'Kas Masuk', data: filteredData.sales.map(s=>s.kas_masukkeluar)}]}); currentPaymentSummary = (filteredData.sales||[]).reduce((acc, sale) => {(sale.metode_pembayaran_parsed || []).forEach(p => { acc[p.method] = (acc[p.method] || 0) + parseCurrency(p.amount); }); return acc; }, {}); const summaryContainer = document.getElementById('payment-method-summary-container'); if (Object.keys(currentPaymentSummary).length > 0) { summaryContainer.innerHTML = `<div class="analysis-grid"><div id="payment-method-chart-container"></div><div id="payment-method-calculator-container"></div></div>`; renderPaymentMethodCalculator(currentPaymentSummary); renderPaymentMethodChart(currentPaymentSummary);} else { summaryContainer.innerHTML = createPlaceholder();} document.getElementById('arus-kas-table-container').innerHTML = createTable(['Tanggal', 'Outlet', 'Total Penjualan', 'Kas Akhir', 'Aksi'], filteredData.sales, i => [i.date.toLocaleDateString('id-ID',{timeZone:'UTC'}), i.outlet, formatCurrency(i.total_penjualan), formatCurrency(i.kas_akhir), `<button class="btn action-btn" data-action="view-sales-detail" data-aruskas='${encodeURIComponent(JSON.stringify(i.item_aruskas_parsed))}' data-pembayaran='${encodeURIComponent(JSON.stringify(i.metode_pembayaran_parsed))}'><i class="fas fa-eye"></i></button>`]); }
    function renderTransaksiBankPage() { const totalKredit = filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'CR').reduce((s, t) => s + t.amount_numeric, 0) || 0; const totalDebit = filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'DB').reduce((s, t) => s + t.amount_numeric, 0) || 0; const latestBalance = filteredData.estatement?.sort((a,b) => b.date - a.date)[0]?.balance_numeric || 0; document.getElementById('transaksi-bank-summary-container').innerHTML = `<div class="metric-item"><p>Total Kredit</p><h2 class="text-success">${formatCurrency(totalKredit)}</h2></div><div class="metric-item"><p>Total Debit</p><h2 class="text-danger">${formatCurrency(totalDebit)}</h2></div><div class="metric-item"><p>Saldo Akhir</p><h2>${formatCurrency(latestBalance)}</h2></div>`; const grouped = {'Kredit': filteredData.estatement.filter(i=>i.type?.toUpperCase()==='CR'), 'Debit': filteredData.estatement.filter(i=>i.type?.toUpperCase()==='DB')}; document.getElementById('transaksi-bank-grouped-container').innerHTML = Object.entries(grouped).map(([type, items]) => createAccordionItem(type, createTable(['Tgl','Deskripsi','Jumlah'], items, i=>[i.date.toLocaleDateString('id-ID',{timeZone:'UTC'}), i.description, formatCurrency(i.amount_numeric)]))).join(''); document.getElementById('transaksi-bank-table-container').innerHTML = createTable(['Tgl', 'Deskripsi', 'Tipe', 'Jumlah', 'Saldo'], filteredData.estatement, i => [i.date.toLocaleDateString('id-ID',{timeZone:'UTC'}), i.description, `<span class="${i.type?.toUpperCase()==='CR'?'text-success':'text-danger'}">${i.type}</span>`, formatCurrency(i.amount_numeric), formatCurrency(i.balance_numeric)]);}
    function renderPengeluaranPage() {const grouped = (filteredData.bankTransaction||[]).reduce((acc, i)=>{ (acc[i.penerima] = acc[i.penerima] || []).push(i); return acc;}, {}); document.getElementById('pengeluaran-grouped-container').innerHTML = Object.entries(grouped).map(([penerima, items])=> createAccordionItem(penerima, createTable(['Tgl','Nominal','Total'], items, i=>[i.date.toLocaleDateString('id-ID',{timeZone:'UTC'}), formatCurrency(i.nominal_transfer), formatCurrency(i.total_transaksi)]))).join(''); document.getElementById('pengeluaran-table-container').innerHTML = createTable(['Tanggal', 'Penerima', 'Nominal', 'Total'], filteredData.bankTransaction, i => [i.date.toLocaleDateString('id-ID',{timeZone:'UTC'}), i.penerima, formatCurrency(i.nominal_transfer), formatCurrency(i.total_transaksi)]);}
    function renderDetailPengeluaranPage() {const byCategory = (filteredData.expenseMatch||[]).reduce((acc, item) => { acc[item.displayCategory] = (acc[item.displayCategory] || 0) + item.displayAmount; return acc; }, {}); createOrUpdateChart('detail-pengeluaran-summary-container', 'pie', {labels: Object.keys(byCategory), datasets: [{data: Object.values(byCategory)}]}); document.getElementById('detail-pengeluaran-table-container').innerHTML = createTable(['Tgl', 'Kategori', 'Jumlah'], filteredData.expenseMatch, i => [i.date.toLocaleDateString('id-ID',{timeZone:'UTC'}), i.displayCategory, formatCurrency(i.displayAmount)]);}

    // =================================================================================
    // --- FUNGSI-FUNGSI PRINT (BARU & DIPERBAIKI) ---
    // =================================================================================
    function togglePrintButton() {
        const activePageId = document.querySelector('.page.active')?.id;
        const printButton = document.getElementById('print-page');
        const printablePages = ['page-dashboard', 'page-neraca']; // Tentukan halaman mana yang bisa di-print
        
        printButton.style.display = printablePages.includes(activePageId) ? 'inline-flex' : 'none';
    }

    function handlePrint() {
        const activePageId = document.querySelector('.page.active')?.id;
        if (activePageId === 'page-dashboard') {
            printDashboard();
        } else if (activePageId === 'page-neraca') {
            printNeraca();
        }
    }

    function printWithSetup(pageElement, title, subtitle, summary, watermarkText) {
        const originalDocTitle = document.title;
        document.title = `${title} - ${new Date().toLocaleDateString('id-ID')}`;

        // Buat dan tambahkan elemen-elemen print
        const printHeader = createPrintHeader(title, subtitle, summary);
        const watermark = createWatermark(watermarkText);
        const executiveSummary = createExecutiveSummary();
        const financialHighlights = createFinancialHighlights();

        pageElement.prepend(printHeader);
        pageElement.prepend(financialHighlights);
        pageElement.prepend(executiveSummary);
        document.body.appendChild(watermark);

        // Tunggu sebentar agar DOM update, lalu print
        setTimeout(() => {
            window.print();
            
            // Cleanup setelah print
            document.title = originalDocTitle;
            printHeader.remove();
            watermark.remove();
            executiveSummary.remove();
            financialHighlights.remove();
        }, 500);
    }

    function printDashboard() {
        const totalPendapatan = filteredData.sales?.reduce((s, i) => s + i.total_diharapkan, 0) || 0;
        const totalPengeluaran = filteredData.expenseMatch?.reduce((s, i) => s + i.displayAmount, 0) || 0;
        const labaRugi = totalPendapatan - totalPengeluaran;
        const margin = totalPendapatan > 0 ? ((labaRugi / totalPendapatan) * 100).toFixed(1) : 0;
        const summary = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 10pt;">
                <div><strong>Total Pendapatan:</strong> ${formatCurrency(totalPendapatan)}</div>
                <div><strong>Total Pengeluaran:</strong> ${formatCurrency(totalPengeluaran)}</div>
                <div><strong>Laba/Rugi Bersih:</strong> <strong class="${labaRugi >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(labaRugi)}</strong></div>
                <div><strong>Margin Profit:</strong> <strong class="${margin >= 0 ? 'text-success' : 'text-danger'}">${margin}%</strong></div>
            </div>`;
        printWithSetup(document.getElementById('page-dashboard'), 'Laporan Dashboard Keuangan', 'Ringkasan Kinerja Utama', summary, 'DASHBOARD');
    }

    function printNeraca() {
        const totalPendapatan = filteredData.sales?.reduce((s, i) => s + i.total_diharapkan, 0) || 0;
        const totalPengeluaran = filteredData.expenseMatch?.reduce((s, i) => s + i.displayAmount, 0) || 0;
        const arusKasBersih = (filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'CR').reduce((s, t) => s + t.amount_numeric, 0) || 0) - (filteredData.estatement?.filter(t => t.type?.toUpperCase() === 'DB').reduce((s, t) => s + t.amount_numeric, 0) || 0);
        const summary = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 10pt;">
                <div><strong>Laba/Rugi Operasional:</strong> ${formatCurrency(totalPendapatan - totalPengeluaran)}</div>
                <div><strong>Arus Kas Bersih (Bank):</strong> ${formatCurrency(arusKasBersih)}</div>
            </div>`;
        printWithSetup(document.getElementById('page-neraca'), 'Laporan Neraca Keuangan', 'Analisis Posisi Keuangan', summary, 'NERACA');
    }

    // =================================================================================
    // --- HELPER UI (Print, Modal, Tabel, Chart, Notifikasi, dll.) ---
    // =================================================================================
    const formatCurrency = amount => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0);
    const showLoading = show => document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    const createPlaceholder = (text = "Tidak ada data untuk ditampilkan.") => `<div class="placeholder-text">${text}</div>`;
    function createTable(headers, data, rowMapper) { if (!data || data.length === 0) return createPlaceholder(); return `<div class="table-responsive"><table class="table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.map(item => `<tr>${rowMapper(item).map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`; }
    function createAccordionItem(header, content) { return `<div class="accordion-item"><button class="accordion-header" data-action="toggle-accordion">${header}</button><div class="accordion-content">${content}</div></div>`; }
    
    // Helper untuk membuat elemen print
    function createPrintHeader(title, subtitle, summary) {
        const header = document.createElement('div');
        header.className = 'print-header';
        header.innerHTML = `<div class="print-title">${title}</div><div class="print-subtitle">${subtitle}</div><div class="print-date">Periode: ${document.getElementById('start-date').value} s/d ${document.getElementById('end-date').value}</div>${summary ? `<div class="print-summary">${summary}</div>` : ''}`;
        return header;
    }
    function createWatermark(text) { const el = document.createElement('div'); el.className = 'watermark'; el.textContent = text; return el; }
    function createExecutiveSummary() { const el = document.createElement('div'); el.className = 'executive-summary'; el.innerHTML = `<h4>Ringkasan Eksekutif</h4><p>Laporan ini merangkum kinerja keuangan perusahaan berdasarkan data yang tersedia untuk periode yang dipilih. Analisis mencakup pendapatan, pengeluaran, dan arus kas untuk memberikan gambaran komprehensif.</p>`; return el; }
    function createFinancialHighlights() { const totalPendapatan = filteredData.sales?.reduce((s, i) => s + i.total_diharapkan, 0) || 0; const totalPengeluaran = filteredData.expenseMatch?.reduce((s, i) => s + i.displayAmount, 0) || 0; const labaRugi = totalPendapatan-totalPengeluaran; const el = document.createElement('div'); el.className = 'financial-highlights'; el.innerHTML = `<div class="highlight-item"><div class="highlight-label">Total Pendapatan</div><div class="highlight-value">${formatCurrency(totalPendapatan)}</div></div><div class="highlight-item"><div class="highlight-label">Total Pengeluaran</div><div class="highlight-value">${formatCurrency(totalPengeluaran)}</div></div><div class="highlight-item"><div class="highlight-label">Laba/Rugi</div><div class="highlight-value" style="color: ${labaRugi >= 0 ? 'green':'red'}">${formatCurrency(labaRugi)}</div></div>`; return el; }

    function handleDynamicClicks(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const { action, aruskas, pembayaran, category } = target.dataset;

        if (action === 'view-sales-detail') {
            const content = `<h4>Metode Pembayaran</h4>${createTable(['Metode','Jumlah'], JSON.parse(decodeURIComponent(pembayaran)), p => [p.method, formatCurrency(p.amount)])}<h4>Detail Arus Kas</h4>${createTable(['Item','Jumlah'], JSON.parse(decodeURIComponent(aruskas)), i=>[i.item, formatCurrency(i.amount)])}`;
            showModal('Detail Transaksi Penjualan', content);
        } else if (action === 'view-category-expenses') {
            const items = filteredData.expenseMatch.filter(item => item.displayCategory === category);
            showModal(`Transaksi Kategori: ${category}`, createTable(['Tanggal', 'Jumlah'], items, item => [item.date.toLocaleDateString('id-ID',{timeZone:'UTC'}), formatCurrency(item.displayAmount)]));
        } else if (action === 'toggle-accordion') {
            target.classList.toggle('active');
            const content = target.nextElementSibling;
            content.style.maxHeight = content.style.maxHeight ? null : `${content.scrollHeight}px`;
        }
    }
    function handleCommissionInputChange(e) { const input = e.target; const methodId = input.dataset.method; const total = parseFloat(input.dataset.total); const pct = parseFloat(input.value) || 0; const potongan = total * (pct / 100); const diterima = total - potongan; document.getElementById(`potongan-${methodId}`).textContent = formatCurrency(potongan); document.getElementById(`diterima-${methodId}`).textContent = formatCurrency(diterima); const commissionData = {}; document.querySelectorAll('.commission-input').forEach(inp => { const mid = inp.dataset.method; const tot = parseFloat(inp.dataset.total); const p = parseFloat(inp.value) || 0; commissionData[mid] = tot - (tot * (p / 100)); }); renderPaymentMethodChart(currentPaymentSummary, commissionData); }
    function showModal(title, content) { const modal = document.getElementById('modal'); modal.querySelector('.modal-title').textContent = title; modal.querySelector('.modal-body').innerHTML = content; modal.classList.add('show'); }
    function showNotification(message, type = 'success') { const notification = document.getElementById('notification'); notification.textContent = message; notification.className = `notification ${type} show`; setTimeout(() => notification.classList.remove('show'), 4000); }
    function renderPaymentMethodCalculator(summary) { const container = document.getElementById('payment-method-calculator-container'); const sortedMethods = Object.entries(summary).sort(([, a], [, b]) => b - a); container.innerHTML = `<table class="table"><thead><tr><th>Metode</th><th>Total</th><th>% Komisi</th><th>Potongan</th><th>Diterima</th></tr></thead><tbody>${sortedMethods.map(([method, total]) => { const cleanId = method.replace(/[^a-zA-Z0-9]/g, ''); return `<tr><td><strong>${method}</strong></td><td>${formatCurrency(total)}</td><td><input type="number" class="form-control commission-input" data-method="${cleanId}" data-total="${total}"></td><td id="potongan-${cleanId}">${formatCurrency(0)}</td><td id="diterima-${cleanId}">${formatCurrency(total)}</td></tr>`; }).join('')}</tbody></table>`; }
    function renderPaymentMethodChart(summary, commissionData = {}) { const labels = Object.keys(summary).sort((a, b) => summary[b] - summary[a]); createOrUpdateChart('payment-method-chart-container', 'bar', { labels, datasets: [{ label: 'Total Kotor', data: labels.map(l => summary[l]) }, { label: 'Total Diterima', data: labels.map(l => commissionData[l.replace(/[^a-zA-Z0-9]/g, '')] ?? summary[l]) }] }, { indexAxis: 'y' }); }
    function createOrUpdateChart(containerId, type, data, options = {}) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (chartInstances[containerId]) chartInstances[containerId].destroy();
        if (Object.keys(data).length === 0 || data.datasets.every(ds => ds.data.length === 0)) { container.innerHTML = createPlaceholder("Data tidak cukup untuk menampilkan grafik."); return; }
        container.innerHTML = `<canvas></canvas>`;
        const chartColors = ['#4361ee', '#4895ef', '#560bad', '#7209b7', '#f72585', '#ffc107', '#2ec4b6', '#06d6a0'];
        data.datasets.forEach((dataset, index) => {
            dataset.backgroundColor = dataset.backgroundColor || (type === 'doughnut' || type === 'pie' ? chartColors : chartColors[index % chartColors.length]);
            dataset.borderColor = dataset.borderColor || chartColors[index % chartColors.length];
            dataset.tension = 0.3;
        });
        chartInstances[containerId] = new Chart(container.querySelector('canvas').getContext('2d'), { type, data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${formatCurrency(ctx.parsed.y || ctx.parsed)}` } } }, ...options } });
    }

    // =================================================================================
    // --- INISIALISASI ---
    // =================================================================================
    setupAuth();
    checkAuthStatus();
});
</script>
</body>
</html>
