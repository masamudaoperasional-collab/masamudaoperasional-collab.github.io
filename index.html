<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Rekam Pengeluaran</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --danger-color: #ef4444;
      --success-color: #10b981;
      --text-color: #333;
      --border-color: #ccc;
      --background-color: #f9fafb;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 15px;
      background: var(--background-color);
      color: var(--text-color);
      font-size: 16px;
      line-height: 1.5;
    }
    
    h2 { 
      text-align: center; 
      margin-bottom: 20px; 
      color: var(--primary-color); 
      font-weight: 600; 
      font-size: 1.5rem;
    }
    
    form, .card {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .form-row { 
      display: flex; 
      gap: 15px; 
      margin-bottom: 15px; 
      flex-wrap: wrap; 
    }
    
    .form-group { 
      flex: 1; 
      min-width: 0;
    }
    
    label { 
      font-weight: 500; 
      display: block; 
      margin-bottom: 6px; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    select, input[type="number"], input[type="text"], textarea, input[type="file"] {
      width: 100%; 
      padding: 12px 10px; 
      border: 1px solid var(--border-color);
      border-radius: 6px; 
      outline: none; 
      font-family: 'Poppins', sans-serif; 
      font-size: 16px;
      max-width: 100%;
    }
    
    select:focus, input:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    
    textarea { 
      resize: vertical; 
      min-height: 100px; 
    }
    
    .date-nav { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      width: 100%;
    }
    
    .date-nav button {
      padding: 10px 14px; 
      background: var(--primary-color); 
      color: white;
      border-radius: 6px; 
      border: none; 
      cursor: pointer; 
      font-weight: 500;
      font-size: 16px;
      min-width: 44px;
      min-height: 44px;
      flex-shrink: 0;
    }
    
    .date-nav button:hover { 
      background: #1d4ed8; 
    }
    
    .date-nav input { 
      text-align: center; 
      background: var(--background-color); 
      border: 1px solid var(--border-color); 
      flex: 1;
      min-width: 0;
      padding: 10px;
    }
    
    .table-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 15px 0 10px; 
    }
    
    .table-header h3 { 
      margin: 0; 
      font-weight: 600; 
      color: #111827; 
      font-size: 1.2rem;
    }

    /* Table wrapper untuk scroll di mobile */
    .table-wrapper { 
      width: 100%; 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    table {
      width: 100%; 
      border-collapse: collapse; 
      margin: 0;
      font-size: 14px; 
      min-width: 600px;
    }
    
    th, td { 
      border: 1px solid #e5e7eb; 
      padding: 10px 8px; 
      text-align: center; 
      word-break: break-word;
      max-width: 200px;
    }
    
    th { 
      background-color: #f3f4f6; 
      font-weight: 500; 
      white-space: nowrap;
    }
    
    tr:hover td { 
      background-color: var(--background-color); 
    }

    button {
      padding: 12px 16px; 
      border-radius: 6px; 
      border: none; 
      cursor: pointer;
      font-weight: 500; 
      transition: all 0.2s; 
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .add-btn { 
      background: var(--primary-color); 
      color: white; 
      margin-top: 12px; 
      width: 100%;
    }
    
    .remove-btn { 
      background: var(--danger-color); 
      color: white; 
      padding: 8px 12px;
      font-size: 14px;
      min-height: 36px;
      white-space: nowrap;
    }
    
    .submit-btn { 
      background: var(--success-color); 
      color: white; 
      margin-top: 20px; 
      width: 100%;
      max-width: 300px;
    }
    
    .back-btn { 
      background: var(--danger-color); 
      color: white; 
      margin-right: 10px; 
    }
    
    .confirm-btn { 
      background: var(--success-color); 
      color: white; 
    }
    
    pre { 
      background: #f4f4f4; 
      padding: 10px; 
      margin-top: 20px; 
      font-size: 13px; 
      white-space: pre-wrap; 
      border-radius: 6px;
      overflow-x: auto;
    }

    /* Tampilan kartu untuk tabel di mobile */
    .mobile-card-view {
      display: none;
    }
    
    .card-row {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
    }
    
    .card-field {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .card-field:last-child {
      margin-bottom: 0;
    }
    
    .card-label {
      font-weight: 600;
      min-width: 120px;
    }
    
    .card-value {
      flex: 1;
      text-align: right;
    }
    
    .card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }

    /* Styling khusus untuk halaman review */
    .review-summary {
      margin-bottom: 20px;
    }
    
    .review-summary .card-row {
      margin-bottom: 0;
    }
    
    .review-table-container {
      margin-top: 20px;
    }
    
    .review-table-container h4 {
      margin: 0 0 10px 0;
      font-weight: 600;
      color: #111827;
    }

    /* Upload file styling */
    .upload-section {
      margin-top: 15px;
      padding: 15px;
      border: 1px dashed var(--border-color);
      border-radius: 6px;
      background-color: #f9fafb;
    }
    
    .upload-section h4 {
      margin: 0 0 10px 0;
      font-weight: 500;
      color: #4b5563;
    }
    
    .file-preview {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-size: 14px;
    }
    
    .file-item button {
      background: none;
      border: none;
      color: var(--danger-color);
      margin-left: 8px;
      padding: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    /* Debug panel */
    .debug-panel {
      margin-top: 20px;
      padding: 15px;
      background-color: #f3f4f6;
      border-radius: 6px;
      border-left: 4px solid var(--primary-color);
    }
    
    .debug-panel h4 {
      margin: 0 0 10px 0;
      color: #374151;
    }
    
    .debug-toggle {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    .debug-content {
      display: none;
      font-family: monospace;
      font-size: 12px;
      background: white;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body { 
        padding: 10px; 
        font-size: 15px; 
      }
      
      form, .card { 
        padding: 15px; 
      }
      
      .form-row { 
        flex-direction: column; 
        gap: 15px; 
      }
      
      .form-group { 
        width: 100%; 
      }
      
      table { 
        font-size: 14px; 
      }
      
      th, td {
        padding: 8px 6px;
        max-width: 150px;
      }
      
      .date-nav { 
        flex-wrap: nowrap;
      }
      
      .button-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .back-btn, .confirm-btn {
        width: 100%;
        margin-right: 0;
      }
      
      /* Sembunyikan tabel, tampilkan kartu pada layar kecil */
      .table-wrapper {
        display: none;
      }
      
      .mobile-card-view {
        display: block;
      }
      
      .add-btn {
        margin-top: 15px;
      }
      
      /* Tampilan mobile untuk tabel review */
      .review-table-wrapper {
        display: block;
      }
      
      .review-table-wrapper table {
        display: none;
      }
      
      .review-mobile-view {
        display: block;
      }
      
      .file-preview {
        flex-direction: column;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      form, .card {
        padding: 12px;
      }
      
      h2 {
        font-size: 1.3rem;
        margin-bottom: 15px;
      }
      
      .table-header h3 {
        font-size: 1.1rem;
      }
      
      th, td {
        padding: 6px 4px;
        font-size: 13px;
        max-width: 120px;
      }
      
      select, input, textarea { 
        font-size: 15px; 
        padding: 10px 8px;
      }
      
      .date-nav button {
        padding: 8px 10px;
        min-width: 40px;
        min-height: 40px;
        font-size: 14px;
      }
      
      .card-field {
        flex-direction: column;
      }
      
      .card-label {
        min-width: auto;
        margin-bottom: 5px;
      }
      
      .card-value {
        text-align: left;
      }
    }
    
    @media (max-width: 360px) {
      body {
        padding: 5px;
      }
      
      form, .card {
        padding: 10px;
      }
      
      .date-nav {
        flex-wrap: wrap;
      }
      
      .date-nav input {
        order: -1;
        width: 100%;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>

  <h2>Form Rekam Pengeluaran</h2>
  
  <!-- Step 1: Form -->
  <form id="pengeluaranForm">
    <div class="form-row">
      <div class="form-group">
        <label for="jenis">Jenis Pengeluaran:</label>
        <select id="jenis" name="jenis">
          <option value="bahan_baku">Bahan Baku</option>
          <option value="operasional">Operasional</option>
          <option value="inventaris">Inventaris</option>
          <option value="lainnya">Lainnya</option>
        </select>
      </div>
      <div class="form-group">
        <label for="tanggal">Tanggal:</label>
        <div class="date-nav">
          <button type="button" onclick="ubahTanggal(-1)">⬅</button>
          <input type="text" id="tanggal" name="tanggal" readonly>
          <button type="button" onclick="ubahTanggal(1)">➡</button>
        </div>
      </div>
    </div>

    <div id="tableContainer"></div>

    <div class="form-group" style="margin-top:20px;">
      <label for="keterangan">Keterangan Tambahan:</label>
      <textarea id="keterangan" name="keterangan" placeholder="Tambahkan catatan tambahan di sini..."></textarea>
    </div>

    <!-- Upload File Section -->
    <div class="upload-section">
      <h4>Upload File atau Foto</h4>
      <input type="file" id="fileUpload" name="fileUpload" multiple accept="image/*,.pdf,.doc,.docx">
      <div id="filePreview" class="file-preview"></div>
    </div>

    <button type="submit" class="submit-btn">Lanjut Review</button>
  </form>

  <!-- Step 2: Review -->
  <div id="reviewCard" class="card" style="display:none;">
    <h3>Review Data Anda</h3>
    
    <div class="review-summary">
      <div class="card-row">
        <div class="card-field">
          <span class="card-label">Jenis Pengeluaran</span>
          <span class="card-value" id="reviewJenis">-</span>
        </div>
        <div class="card-field">
          <span class="card-label">Tanggal</span>
          <span class="card-value" id="reviewTanggal">-</span>
        </div>
        <div class="card-field">
          <span class="card-label">Keterangan</span>
          <span class="card-value" id="reviewKeterangan">-</span>
        </div>
        <div class="card-field">
          <span class="card-label">File Terlampir</span>
          <span class="card-value" id="reviewFiles">-</span>
        </div>
      </div>
    </div>
    
    <div class="review-table-container">
      <h4>Detail Item</h4>
      <div class="table-wrapper">
        <table id="reviewTable">
          <!-- Tabel akan diisi oleh JavaScript -->
        </table>
      </div>
      <div id="reviewMobileView" class="mobile-card-view">
        <!-- Tampilan mobile akan diisi oleh JavaScript -->
      </div>
    </div>
    
    <div style="margin-top:20px;" class="button-group">
      <button class="back-btn" onclick="goBack()">Kembali</button>
      <button class="confirm-btn" onclick="confirmSubmit()">Konfirmasi & Kirim</button>
    </div>
    <pre id="status"></pre>
  </div>

  <!-- Step 3: Halaman Terima Kasih -->
  <div id="thankyouCard" class="card" style="display:none; text-align:center;">
    <h3>Terima kasih!</h3>
    <p>Data pengeluaran Anda berhasil dikirim.</p>
    <button class="submit-btn" onclick="startNew()">Mulai Input Baru</button>
  </div>

  <!-- Debug Panel -->
  <div class="debug-panel">
    <button class="debug-toggle" onclick="toggleDebug()">Toggle Debug Info</button>
    <div class="debug-content" id="debugContent">
      <p>Debug information will appear here when you submit the form.</p>
    </div>
  </div>

  <script>
    let currentDate = new Date();
    let uploadedFiles = [];
    
    tampilkanTanggal();
    
    function tampilkanTanggal() {
      document.getElementById("tanggal").value = currentDate.toLocaleDateString("id-ID", {
        day: "2-digit", month: "2-digit", year: "numeric"
      });
    }
    
    function ubahTanggal(step) { 
      currentDate.setDate(currentDate.getDate() + step); 
      tampilkanTanggal(); 
    }

    function toggleDebug() {
      const debugContent = document.getElementById("debugContent");
      debugContent.style.display = debugContent.style.display === 'block' ? 'none' : 'block';
    }

    function logDebug(message) {
      const debugContent = document.getElementById("debugContent");
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `<p>[${timestamp}] ${message}</p>`;
      debugContent.scrollTop = debugContent.scrollHeight;
    }

    // URL webhook yang benar (perbaikan dari error di console)
    const WEBHOOK_URL = "https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook-test/b481ef90-7fd7-4410-a59a-cac4a7fc82a7";
    
    // Alternatif URL untuk testing jika URL utama bermasalah
    const TEST_WEBHOOK_URL = "https://webhook.site/your-unique-id-here"; // Ganti dengan URL testing Anda

    function renderTable(jenis) {
      const container = document.getElementById("tableContainer");
      
      if (jenis === "bahan_baku") {
        container.innerHTML = `
          <div class="table-header">
            <h3>Daftar Bahan Baku</h3>
          </div>
          <div class="table-wrapper">
            <table id="bahanTable">
              <thead>
                <tr>
                  <th>Nama Barang</th>
                  <th>Kuantitas</th>
                  <th>Satuan</th>
                  <th>Harga (Rp)</th>
                  <th>Total Harga (Rp)</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <select name="nama_barang[]">
                      <option value="Air Cleo">Air Cleo</option>
                      <option value="Mineral Botol Cleo">Mineral Botol Cleo</option>
                      <option value="Es Batu IPB">Es Batu IPB</option>
                      <option value="House Blend Beans; Omni Roaster">House Blend Beans; Omni Roaster</option>
                      <option value="FM UHT; Diamond">FM UHT; Diamond</option>
                    </select>
                  </td>
                  <td><input type="number" name="kuantitas[]" min="1" value="1" oninput="hitungTotal(this)"></td>
                  <td>
                    <select name="satuan[]">
                      <option value="kg">Kg</option>
                      <option value="liter">Liter</option>
                      <option value="pcs">Pcs</option>
                      <option value="gal">Galon</option>
                      <option value="bal">Bal</option>
                      <option value="pack">Pack</option>
                      <option value="jerigen">Jerigen</option>
                      <option value="karton">Karton</option>
                    </select>
                  </td>
                  <td><input type="number" name="harga[]" min="0" step="100" placeholder="Rp" oninput="hitungTotal(this)"></td>
                  <td><input type="text" name="total[]" readonly></td>
                  <td><button type="button" class="remove-btn" onclick="hapusRow(this)">Hapus</button></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mobile-card-view" id="bahanCardView">
            <div class="card-row">
              <div class="card-field">
                <span class="card-label">Nama Barang:</span>
                <span class="card-value">
                  <select name="nama_barang_mobile[]">
                    <option value="Air Cleo">Air Cleo</option>
                    <option value="Es Batu IPB">Es Batu IPB</option>
                    <option value="House Blend Beans; Omni Roaster">House Blend Beans; Omni Roaster</option>
                    <option value="FM UHT; Diamond">FM UHT; Diamond</option>
                    <option value="FM COCO; Frisian Flag">FM COCO; Frisian Flag</option>
                    <option value="Aren Cair; Omni Roaster">Aren Cair; Omni Roaster</option>
                    <option value="Chai Syrup; Monin">Chai Syrup; Monin</option>
                    <option value="Pistachio Syrup; W&C">Pistachio Syrup; W&C</option>
                    <option value="Caramel Syrup; Dripp">Caramel Syrup; Dripp</option>
                    <option value="Banana Syrup; W&C">Banana Syrup; W&C</option>
                    <option value="Strawberry Pure; W&C">Strawberry Pure; W&C</option>
                    <option value="Creamer; W&C">Creamer; W&C</option>
                    <option value="SKM Dairy Champ">SKM Dairy Champ</option>
                    <option value="Gula Pasir; PSM">Gula Pasir; PSM</option>
                    <option value="Perisa Pandan; Koepoe">Perisa Pandan; Koepoe</option>
                    <option value="Matcha Powder; Denali">Matcha Powder; Denali</option>
                    <option value="Cinnamon Powder; Koepoe">Cinnamon Powder; Koepoe</option>
                    <option value="Dark Choco Powder; Delmoro">Dark Choco Powder; Delmoro</option>
                    <option value="Avocado Powder">Avocado Powder</option>
                    <option value="Jeruk Peras">Jeruk Peras</option>
                    <option value="Biji Selasih">Biji Selasih</option>
                    <option value="Nata De Coco">Nata De Coco</option>
                    <option value="Earlgrey; Toe a Tea">Earlgrey; Toe a Tea</option>
                    <option value="Black Tea; Goalpara">Black Tea; Goalpara</option>
                    <option value="Single Origin varian1">Single Origin varian1</option>
                    <option value="Single Origin varian2">Single Origin varian2</option>
                    <option value="Simple Syrup">Simple Syrup</option>
                    <option value="Masa Base">Masa Base</option>
                    <option value="Muda Base">Muda Base</option>
                    <option value="Chocolate Base">Chocolate Base</option>
                    <option value="Matcha Base">Matcha Base</option>
                    <option value="Black Tea Base">Black Tea Base</option>
                    <option value="Espresso Base">Espresso Base</option>
                    <option value="Espresso Cinn Base">Espresso Cinn Base</option>
                    <option value="Strawberry Frozen">Strawberry Frozen</option>
                    <option value="Alpukat Frozen">Alpukat Frozen</option>
                    <option value="Pisang Frozen">Pisang Frozen</option>
                    <option value="Ice Cup">Ice Cup</option>
                    <option value="Lid Ice Cup">Lid Ice Cup</option>
                    <option value="Hot Cup">Hot Cup</option>
                    <option value="Lid Hot Cup">Lid Hot Cup</option>
                    <option value="Plastik Mini TA">Plastik Mini TA</option>
                    <option value="Plastik Big TA">Plastik Big TA</option>
                    <option value="Sendok TA">Sendok TA</option>
                    <option value="Mini Thermal">Mini Thermal</option>
                    <option value="Big Thermal">Big Thermal</option>
                    <option value="Straw/Sedotan">Straw/Sedotan</option>
                    <option value="Cable Ties">Cable Ties</option>
                    <option value="Floor Cleaner">Floor Cleaner</option>
                    <option value="Table Cleaner">Table Cleaner</option>
                    <option value="Hand Soap">Hand Soap</option>
                    <option value="Sunlight">Sunlight</option>
                    <option value="SiBiru">SiBiru</option>
                    <option value="Porstex">Porstex</option>
                    <option value="Harpic Closet">Harpic Closet</option>
                    <option value="Kamper">Kamper</option>
                    <option value="Trashbag">Trashbag</option>
                    <option value="Kain Pel">Kain Pel</option>
                    <option value="Livi Napkin">Livi Napkin</option>
                    <option value="Livi Multifold">Livi Multifold</option>
                    <option value="Livi Roll WC.">Livi Roll WC.</option>
                    <option value="B Bombai">B Bombai</option>
                    <option value="B Merah">B Merah</option>
                    <option value="B Putih">B Putih</option>
                    <option value="C Merah Besar">C Merah Besar</option>
                    <option value="C Merah Keriting">C Merah Keriting</option>
                    <option value="Tomat">Tomat</option>
                    <option value="Timun">Timun</option>
                    <option value="Wortel">Wortel</option>
                    <option value="D Bawang">D Bawang</option>
                    <option value="D Jeruk">D Jeruk</option>
                    <option value="D Salam">D Salam</option>
                    <option value="D Parsley">D Parsley</option>
                    <option value="Jahe">Jahe</option>
                    <option value="Kelapa Parut">Kelapa Parut</option>
                    <option value="Kemangi">Kemangi</option>
                    <option value="Kemiri">Kemiri</option>
                    <option value="Kol">Kol</option>
                    <option value="Kunyit">Kunyit</option>
                    <option value="Lengkuas Parut">Lengkuas Parut</option>
                    <option value="Uli">Uli</option>
                    <option value="Selada">Selada</option>
                    <option value="Pakcoy">Pakcoy</option>
                    <option value="Kacang Panjang">Kacang Panjang</option>
                    <option value="Brokoli">Brokoli</option>
                    <option value="Sereh">Sereh</option>
                    <option value="Mix Vegetabls">Mix Vegetabls</option>
                    <option value="Coklat Clara">Coklat Clara</option>
                    <option value="Beras Pera">Beras Pera</option>
                    <option value="Beras Normal">Beras Normal</option>
                    <option value="Ayam Serundeng">Ayam Serundeng</option>
                    <option value="Ayam Fillet Crispy">Ayam Fillet Crispy</option>
                    <option value="Ayam Saus Mentega">Ayam Saus Mentega</option>
                    <option value="Ayam Nasi Goreng Kemangi">Ayam Nasi Goreng Kemangi</option>
                    <option value="French Fries">French Fries</option>
                    <option value="Cireng">Cireng</option>
                    <option value="Banana Bites">Banana Bites</option>
                    <option value="Bola Ubi">Bola Ubi</option>
                    <option value="Singkong Goreng">Singkong Goreng</option>
                    <option value="Churros">Churros</option>
                    <option value="Telur">Telur</option>
                    <option value="Saus Tomat; Delmonte">Saus Tomat; Delmonte</option>
                    <option value="Saus Cabai; Delmonte">Saus Cabai; Delmonte</option>
                    <option value="Saus Tiram; Cap Panda">Saus Tiram; Cap Panda</option>
                    <option value="Mayonaise">Mayonaise</option>
                    <option value="Kecap Maggi">Kecap Maggi</option>
                    <option value="Cuka Makan">Cuka Makan</option>
                    <option value="Minyak">Minyak</option>
                    <option value="Soda Kue">Soda Kue</option>
                    <option value="Chicken Powder">Chicken Powder</option>
                    <option value="Marinasi Bubuk">Marinasi Bubuk</option>
                    <option value="Ketumbar Bubuk">Ketumbar Bubuk</option>
                    <option value="Tepung Maizena">Tepung Maizena</option>
                    <option value="B Putih Bubuk">B Putih Bubuk</option>
                    <option value="Merica Bubuk">Merica Bubuk</option>
                    <option value="Tepung Terigu">Tepung Terigu</option>
                    <option value="Tepung Kentucky">Tepung Kentucky</option>
                    <option value="Tepung Roti">Tepung Roti</option>
                    <option value="Kertas Minyak">Kertas Minyak</option>
                    <option value="Plastik bwng 1/4">Plastik bwng 1/4</option>
                    <option value="Plastik bwng 2kg">Plastik bwng 2kg</option>
                    <option value="Sendok TA">Sendok TA</option>
                    <option value="Bento TA">Bento TA</option>
                    <option value="Bowl TA">Bowl TA</option>
                    <option value="Tisu Roll Kitchen">Tisu Roll Kitchen</option>
                    <option value="Trashbag">Trashbag</option>
                    <option value="HandGlove">HandGlove</option>
                    <option value="Cup Saus">Cup Saus</option>
                    <option value="Sunlight">Sunlight</option>
                  </select>
                </span>
              </div>
              <div class="card-field">
                <span class="card-label">Kuantitas:</span>
                <span class="card-value"><input type="number" name="kuantitas_mobile[]" min="1" value="1" oninput="hitungTotalMobile(this)"></span>
              </div>
              <div class="card-field">
                <span class="card-label">Satuan:</span>
                <span class="card-value">
                  <select name="satuan_mobile[]">
                    <option value="kg">Kg</option>
                    <option value="liter">Liter</option>
                    <option value="pcs">Pcs</option>
                    <option value="gal">Galon</option>
                    <option value="bal">Bal</option>
                    <option value="pack">Pack</option>
                    <option value="jerigen">Jerigen</option>
                    <option value="karton">Karton</option>
                  </select>
                </span>
              </div>
              <div class="card-field">
                <span class="card-label">Harga (Rp):</span>
                <span class="card-value"><input type="number" name="harga_mobile[]" min="0" step="100" placeholder="Rp" oninput="hitungTotalMobile(this)"></span>
              </div>
              <div class="card-field">
                <span class="card-label">Total Harga (Rp):</span>
                <span class="card-value"><input type="text" name="total_mobile[]" readonly></span>
              </div>
              <div class="card-actions">
                <button type="button" class="remove-btn" onclick="hapusCardRow(this)">Hapus</button>
              </div>
            </div>
          </div>
          <button type="button" class="add-btn" onclick="tambahRow()">+ Tambah Barang</button>
        `;
      } else if (jenis === "operasional") {
        container.innerHTML = `
          <div class="table-header">
            <h3>Biaya Operasional</h3>
          </div>
          <div class="table-wrapper">
            <table id="operasionalTable">
              <thead>
                <tr>
                  <th>Jenis Operasional</th>
                  <th>Biaya (Rp)</th>
                  <th>Bulan</th>
                  <th>PIC</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <select name="jenis_operasional[]">
                      <option value="listrik">Listrik</option>
                      <option value="gaji">Gaji</option>
                      <option value="sampah">Sampah</option>
                      <option value="internet">Internet</option>
                      <option value="sewa">Sewa</option>
                      <option value="dw">DW</option>
                    </select>
                  </td>
                  <td><input type="number" name="biaya[]" min="0" step="100" placeholder="Rp"></td>
                  <td>
                    <select name="bulan[]">
                      <option>Januari</option>
                      <option>Februari</option>
                      <option>Maret</option>
                      <option>April</option>
                      <option>Mei</option>
                      <option>Juni</option>
                      <option>Juli</option>
                      <option>Agustus</option>
                      <option>September</option>
                      <option>Oktober</option>
                      <option>November</option>
                      <option>Desember</option>
                    </select>
                  </td>
                  <td>
                    <select name="pic[]">
                      <option value="person1">Person1</option>
                      <option value="person2">Person2</option>
                      <option value="person3">Person3</option>
                    </select>
                  </td>
                  <td><button type="button" class="remove-btn" onclick="hapusRow(this)">Hapus</button></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mobile-card-view" id="operasionalCardView">
            <div class="card-row">
              <div class="card-field">
                <span class="card-label">Jenis Operasional:</span>
                <span class="card-value">
                  <select name="jenis_operasional_mobile[]">
                    <option value="listrik">Listrik</option>
                    <option value="gaji">Gaji</option>
                    <option value="sampah">Sampah</option>
                    <option value="internet">Internet</option>
                    <option value="sewa">Sewa</option>
                    <option value="dw">DW</option>
                  </select>
                </span>
              </div>
              <div class="card-field">
                <span class="card-label">Biaya (Rp):</span>
                <span class="card-value"><input type="number" name="biaya_mobile[]" min="0" step="100" placeholder="Rp"></span>
              </div>
              <div class="card-field">
                <span class="card-label">Bulan:</span>
                <span class="card-value">
                  <select name="bulan_mobile[]">
                    <option>Januari</option>
                    <option>Februari</option>
                    <option>Maret</option>
                    <option>April</option>
                    <option>Mei</option>
                    <option>Juni</option>
                    <option>Juli</option>
                    <option>Agustus</option>
                    <option>September</option>
                    <option>Oktober</option>
                    <option>November</option>
                    <option>Desember</option>
                  </select>
                </span>
              </div>
              <div class="card-field">
                <span class="card-label">PIC:</span>
                <span class="card-value">
                  <select name="pic_mobile[]">
                    <option value="person1">Person1</option>
                    <option value="person2">Person2</option>
                    <option value="person3">Person3</option>
                  </select>
                </span>
              </div>
              <div class="card-actions">
                <button type="button" class="remove-btn" onclick="hapusCardRow(this)">Hapus</button>
              </div>
            </div>
          </div>
          <button type="button" class="add-btn" onclick="tambahRow()">+ Tambah Baris</button>
        `;
      } else if (jenis === "inventaris" || jenis === "lainnya") {
        container.innerHTML = `
          <div class="table-header">
            <h3>${jenis === "inventaris" ? "Daftar Inventaris" : "Daftar Pengeluaran Lainnya"}</h3>
          </div>
          <div class="table-wrapper">
            <table id="${jenis}Table">
              <thead>
                <tr>
                  <th>Nama Barang</th>
                  <th>Satuan</th>
                  <th>Harga Total (Rp)</th>
                  <th>Harga Satuan (Rp)</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><input type="text" name="nama_barang[]" placeholder="Nama barang"></td>
                  <td>
                    <select name="satuan[]">
                      <option value="pcs">Pcs</option>
                      <option value="unit">Unit</option>
                      <option value="set">Set</option>
                      <option value="paket">Paket</option>
                      <option value="lusin">Lusin</option>
                      <option value="rim">Rim</option>
                      <option value="kg">Kg</option>
                      <option value="liter">Liter</option>
                    </select>
                  </td>
                  <td><input type="number" name="harga_total[]" min="0" step="100" placeholder="Rp" oninput="hitungHargaSatuan(this)"></td>
                  <td><input type="text" name="harga_satuan[]" readonly></td>
                  <td><button type="button" class="remove-btn" onclick="hapusRow(this)">Hapus</button></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mobile-card-view" id="${jenis}CardView">
            <div class="card-row">
              <div class="card-field">
                <span class="card-label">Nama Barang:</span>
                <span class="card-value"><input type="text" name="nama_barang_mobile[]" placeholder="Nama barang"></span>
              </div>
              <div class="card-field">
                <span class="card-label">Satuan:</span>
                <span class="card-value">
                  <select name="satuan_mobile[]">
                    <option value="pcs">Pcs</option>
                    <option value="unit">Unit</option>
                    <option value="set">Set</option>
                    <option value="paket">Paket</option>
                    <option value="lusin">Lusin</option>
                    <option value="rim">Rim</option>
                    <option value="kg">Kg</option>
                    <option value="liter">Liter</option>
                  </select>
                </span>
              </div>
              <div class="card-field">
                <span class="card-label">Harga Total (Rp):</span>
                <span class="card-value"><input type="number" name="harga_total_mobile[]" min="0" step="100" placeholder="Rp" oninput="hitungHargaSatuanMobile(this)"></span>
              </div>
              <div class="card-field">
                <span class="card-label">Harga Satuan (Rp):</span>
                <span class="card-value"><input type="text" name="harga_satuan_mobile[]" readonly></span>
              </div>
              <div class="card-actions">
                <button type="button" class="remove-btn" onclick="hapusCardRow(this)">Hapus</button>
              </div>
            </div>
          </div>
          <button type="button" class="add-btn" onclick="tambahRow()">+ Tambah Barang</button>
        `;
      } else {
        container.innerHTML = `<p style="text-align:center; color:#666; padding:20px;">Silakan pilih jenis pengeluaran</p>`;
      }
      
      // Tambahkan event listener untuk input harga dan kuantitas
      setTimeout(() => {
        document.querySelectorAll('input[name="harga[]"]').forEach(input => {
          input.addEventListener('input', function() { hitungTotal(this); });
        });
        document.querySelectorAll('input[name="kuantitas[]"]').forEach(input => {
          input.addEventListener('input', function() { hitungTotal(this); });
        });
        
        // Untuk tampilan mobile
        document.querySelectorAll('input[name="harga_mobile[]"]').forEach(input => {
          input.addEventListener('input', function() { hitungTotalMobile(this); });
        });
        document.querySelectorAll('input[name="kuantitas_mobile[]"]').forEach(input => {
          input.addEventListener('input', function() { hitungTotalMobile(this); });
        });
        
        // Untuk inventaris/lainnya
        document.querySelectorAll('input[name="harga_total[]"]').forEach(input => {
          input.addEventListener('input', function() { hitungHargaSatuan(this); });
        });
        document.querySelectorAll('input[name="harga_total_mobile[]"]').forEach(input => {
          input.addEventListener('input', function() { hitungHargaSatuanMobile(this); });
        });
      }, 100);
    }

    function tambahRow() {
      const jenis = document.getElementById("jenis").value;
      
      // Untuk tampilan desktop (tabel)
      const table = document.querySelector("#tableContainer table tbody");
      if (table) {
        const newRow = table.rows[0].cloneNode(true);
        newRow.querySelectorAll("input").forEach(input => {
          if (input.type !== 'button') input.value = "";
          if (input.name.includes("harga_satuan")) input.value = "";
        });
        table.appendChild(newRow);
        
        // Tambahkan event listener untuk input baru
        if (jenis === "bahan_baku") {
          newRow.querySelectorAll('input[name="harga[]"]').forEach(input => {
            input.addEventListener('input', function() { hitungTotal(this); });
          });
          newRow.querySelectorAll('input[name="kuantitas[]"]').forEach(input => {
            input.addEventListener('input', function() { hitungTotal(this); });
          });
        } else if (jenis === "inventaris" || jenis === "lainnya") {
          newRow.querySelectorAll('input[name="harga_total[]"]').forEach(input => {
            input.addEventListener('input', function() { hitungHargaSatuan(this); });
          });
        }
      }
      
      // Untuk tampilan mobile (kartu)
      const cardView = document.querySelector("#tableContainer .mobile-card-view");
      if (cardView) {
        const newCard = cardView.querySelector(".card-row").cloneNode(true);
        newCard.querySelectorAll("input").forEach(input => {
          if (input.type !== 'button') input.value = "";
          if (input.name.includes("harga_satuan")) input.value = "";
        });
        cardView.appendChild(newCard);
        
        // Tambahkan event listener untuk input baru
        if (jenis === "bahan_baku") {
          newCard.querySelectorAll('input[name="harga_mobile[]"]').forEach(input => {
            input.addEventListener('input', function() { hitungTotalMobile(this); });
          });
          newCard.querySelectorAll('input[name="kuantitas_mobile[]"]').forEach(input => {
            input.addEventListener('input', function() { hitungTotalMobile(this); });
          });
        } else if (jenis === "inventaris" || jenis === "lainnya") {
          newCard.querySelectorAll('input[name="harga_total_mobile[]"]').forEach(input => {
            input.addEventListener('input', function() { hitungHargaSatuanMobile(this); });
          });
        }
      }
    }
    
    function hapusRow(btn) {
      const row = btn.closest("tr"); 
      const table = row.parentNode;
      if (table.rows.length > 1) row.remove();
      else alert("Minimal 1 baris harus ada.");
    }
    
    function hapusCardRow(btn) {
      const card = btn.closest(".card-row"); 
      const container = card.parentNode;
      if (container.children.length > 1) card.remove();
      else alert("Minimal 1 baris harus ada.");
    }
    
    function hitungTotal(elem) {
      const row = elem.closest("tr");
      const qtyInput = row.querySelector("input[name='kuantitas[]']");
      const hargaInput = row.querySelector("input[name='harga[]']");
      const totalInput = row.querySelector("input[name='total[]']");
      
      if (!qtyInput || !hargaInput || !totalInput) return;
      
      const qty = parseFloat(qtyInput.value) || 0;
      const harga = parseFloat(hargaInput.value) || 0;
      totalInput.value = (qty * harga).toLocaleString("id-ID");
    }
    
    function hitungTotalMobile(elem) {
      const card = elem.closest(".card-row");
      const qtyInput = card.querySelector("input[name='kuantitas_mobile[]']");
      const hargaInput = card.querySelector("input[name='harga_mobile[]']");
      const totalInput = card.querySelector("input[name='total_mobile[]']");
      
      if (!qtyInput || !hargaInput || !totalInput) return;
      
      const qty = parseFloat(qtyInput.value) || 0;
      const harga = parseFloat(hargaInput.value) || 0;
      totalInput.value = (qty * harga).toLocaleString("id-ID");
    }
    
    function hitungHargaSatuan(elem) {
      const row = elem.closest("tr");
      const hargaTotalInput = row.querySelector("input[name='harga_total[]']");
      const hargaSatuanInput = row.querySelector("input[name='harga_satuan[]']");
      
      if (!hargaTotalInput || !hargaSatuanInput) return;
      
      const hargaTotal = parseFloat(hargaTotalInput.value) || 0;
      hargaSatuanInput.value = hargaTotal.toLocaleString("id-ID");
    }
    
    function hitungHargaSatuanMobile(elem) {
      const card = elem.closest(".card-row");
      const hargaTotalInput = card.querySelector("input[name='harga_total_mobile[]']");
      const hargaSatuanInput = card.querySelector("input[name='harga_satuan_mobile[]']");
      
      if (!hargaTotalInput || !hargaSatuanInput) return;
      
      const hargaTotal = parseFloat(hargaTotalInput.value) || 0;
      hargaSatuanInput.value = hargaTotal.toLocaleString("id-ID");
    }

    // Fungsi untuk mengelola upload file
    document.getElementById("fileUpload").addEventListener("change", function(e) {
      const files = e.target.files;
      const previewContainer = document.getElementById("filePreview");
      previewContainer.innerHTML = "";
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";
        
        const fileName = document.createElement("span");
        fileName.textContent = file.name;
        
        const removeBtn = document.createElement("button");
        removeBtn.innerHTML = "×";
        removeBtn.title = "Hapus file";
        removeBtn.onclick = function() {
          fileItem.remove();
          // Hapus file dari array uploadedFiles
          const index = uploadedFiles.findIndex(f => f.name === file.name);
          if (index !== -1) {
            uploadedFiles.splice(index, 1);
          }
        };
        
        fileItem.appendChild(fileName);
        fileItem.appendChild(removeBtn);
        previewContainer.appendChild(fileItem);
        
        // Simpan file ke array
        uploadedFiles.push(file);
      }
    });

    document.getElementById("jenis").addEventListener("change", function() { 
      renderTable(this.value); 
    });
    
    // Inisialisasi tabel saat halaman dimuat
    renderTable(document.getElementById("jenis").value);

    let formDataCache = null;

    document.getElementById("pengeluaranForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const jenis = document.getElementById("jenis").value;
      const tanggal = document.getElementById("tanggal").value;
      const keterangan = document.getElementById("keterangan").value;

      let items = [];
      if (jenis === "bahan_baku") {
        // Coba ambil data dari tampilan desktop terlebih dahulu
        const desktopRows = document.querySelectorAll("#bahanTable tbody tr");
        if (desktopRows.length > 0) {
          items = Array.from(desktopRows).map(row => ({
            nama_barang: row.querySelector("select[name='nama_barang[]']").value,
            kuantitas: row.querySelector("input[name='kuantitas[]']").value,
            satuan: row.querySelector("select[name='satuan[]']").value,
            harga: row.querySelector("input[name='harga[]']").value,
            total: row.querySelector("input[name='total[]']").value
          }));
        } else {
          // Jika tidak ada, ambil dari tampilan mobile
          const mobileCards = document.querySelectorAll("#bahanCardView .card-row");
          items = Array.from(mobileCards).map(card => ({
            nama_barang: card.querySelector("select[name='nama_barang_mobile[]']").value,
            kuantitas: card.querySelector("input[name='kuantitas_mobile[]']").value,
            satuan: card.querySelector("select[name='satuan_mobile[]']").value,
            harga: card.querySelector("input[name='harga_mobile[]']").value,
            total: card.querySelector("input[name='total_mobile[]']").value
          }));
        }
      } else if (jenis === "operasional") {
        // Coba ambil data dari tampilan desktop terlebih dahulu
        const desktopRows = document.querySelectorAll("#operasionalTable tbody tr");
        if (desktopRows.length > 0) {
          items = Array.from(desktopRows).map(row => ({
            jenis_operasional: row.querySelector("select[name='jenis_operasional[]']").value,
            biaya: row.querySelector("input[name='biaya[]']").value,
            bulan: row.querySelector("select[name='bulan[]']").value,
            pic: row.querySelector("select[name='pic[]']").value
          }));
        } else {
          // Jika tidak ada, ambil dari tampilan mobile
          const mobileCards = document.querySelectorAll("#operasionalCardView .card-row");
          items = Array.from(mobileCards).map(card => ({
            jenis_operasional: card.querySelector("select[name='jenis_operasional_mobile[]']").value,
            biaya: card.querySelector("input[name='biaya_mobile[]']").value,
            bulan: card.querySelector("select[name='bulan_mobile[]']").value,
            pic: card.querySelector("select[name='pic_mobile[]']").value
          }));
        }
      } else if (jenis === "inventaris" || jenis === "lainnya") {
        // Coba ambil data dari tampilan desktop terlebih dahulu
        const desktopRows = document.querySelectorAll(`#${jenis}Table tbody tr`);
        if (desktopRows.length > 0) {
          items = Array.from(desktopRows).map(row => ({
            nama_barang: row.querySelector("input[name='nama_barang[]']").value,
            satuan: row.querySelector("select[name='satuan[]']").value,
            harga_total: row.querySelector("input[name='harga_total[]']").value,
            harga_satuan: row.querySelector("input[name='harga_satuan[]']").value
          }));
        } else {
          // Jika tidak ada, ambil dari tampilan mobile
          const mobileCards = document.querySelectorAll(`#${jenis}CardView .card-row`);
          items = Array.from(mobileCards).map(card => ({
            nama_barang: card.querySelector("input[name='nama_barang_mobile[]']").value,
            satuan: card.querySelector("select[name='satuan_mobile[]']").value,
            harga_total: card.querySelector("input[name='harga_total_mobile[]']").value,
            harga_satuan: card.querySelector("input[name='harga_satuan_mobile[]']").value
          }));
        }
      }

      formDataCache = { 
        jenis, 
        tanggal, 
        keterangan, 
        items,
        files_count: uploadedFiles.length
      };

      // Render review page
      renderReviewPage(jenis, tanggal, keterangan, items);
    });

    function renderReviewPage(jenis, tanggal, keterangan, items) {
      // Isi data summary
      document.getElementById("reviewJenis").textContent = jenis;
      document.getElementById("reviewTanggal").textContent = tanggal;
      document.getElementById("reviewKeterangan").textContent = keterangan || "-";
      document.getElementById("reviewFiles").textContent = uploadedFiles.length > 0 
        ? `${uploadedFiles.length} file terlampir` 
        : "Tidak ada file";
      
      // Render tabel untuk desktop
      const reviewTable = document.getElementById("reviewTable");
      let tableHTML = "";
      
      if (jenis === "bahan_baku") {
        tableHTML = `
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Barang</th>
              <th>Kuantitas</th>
              <th>Satuan</th>
              <th>Harga (Rp)</th>
              <th>Total (Rp)</th>
            </tr>
          </thead>
          <tbody>
        `;
        
        items.forEach((item, index) => {
          tableHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${item.nama_barang}</td>
              <td>${item.kuantitas}</td>
              <td>${item.satuan}</td>
              <td>${parseInt(item.harga).toLocaleString("id-ID")}</td>
              <td>${item.total}</td>
            </tr>
          `;
        });
        
        tableHTML += `</tbody>`;
      } else if (jenis === "operasional") {
        tableHTML = `
          <thead>
            <tr>
              <th>No</th>
              <th>Jenis Operasional</th>
              <th>Biaya (Rp)</th>
              <th>Bulan</th>
              <th>PIC</th>
            </tr>
          </thead>
          <tbody>
        `;
        
        items.forEach((item, index) => {
          tableHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${item.jenis_operasional}</td>
              <td>${parseInt(item.biaya).toLocaleString("id-ID")}</td>
              <td>${item.bulan}</td>
              <td>${item.pic}</td>
            </tr>
          `;
        });
        
        tableHTML += `</tbody>`;
      } else if (jenis === "inventaris" || jenis === "lainnya") {
        tableHTML = `
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Barang</th>
              <th>Satuan</th>
              <th>Harga Total (Rp)</th>
              <th>Harga Satuan (Rp)</th>
            </tr>
          </thead>
          <tbody>
        `;
        
        items.forEach((item, index) => {
          tableHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${item.nama_barang}</td>
              <td>${item.satuan}</td>
              <td>${parseInt(item.harga_total).toLocaleString("id-ID")}</td>
              <td>${item.harga_satuan}</td>
            </tr>
          `;
        });
        
        tableHTML += `</tbody>`;
      }
      
      reviewTable.innerHTML = tableHTML;
      
      // Render tampilan mobile
      const reviewMobileView = document.getElementById("reviewMobileView");
      let mobileHTML = "";
      
      if (items.length > 0) {
        items.forEach((item, index) => {
          if (jenis === "bahan_baku") {
            mobileHTML += `
              <div class="card-row">
                <div class="card-field">
                  <span class="card-label">Item ${index + 1}</span>
                  <span class="card-value"></span>
                </div>
                <div class="card-field">
                  <span class="card-label">Nama Barang</span>
                  <span class="card-value">${item.nama_barang}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Kuantitas</span>
                  <span class="card-value">${item.kuantitas}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Satuan</span>
                  <span class="card-value">${item.satuan}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Harga</span>
                  <span class="card-value">${parseInt(item.harga).toLocaleString("id-ID")}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Total</span>
                  <span class="card-value">${item.total}</span>
                </div>
              </div>
            `;
          } else if (jenis === "operasional") {
            mobileHTML += `
              <div class="card-row">
                <div class="card-field">
                  <span class="card-label">Item ${index + 1}</span>
                  <span class="card-value"></span>
                </div>
                <div class="card-field">
                  <span class="card-label">Jenis</span>
                  <span class="card-value">${item.jenis_operasional}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Biaya</span>
                  <span class="card-value">${parseInt(item.biaya).toLocaleString("id-ID")}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Bulan</span>
                  <span class="card-value">${item.bulan}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">PIC</span>
                  <span class="card-value">${item.pic}</span>
                </div>
              </div>
            `;
          } else if (jenis === "inventaris" || jenis === "lainnya") {
            mobileHTML += `
              <div class="card-row">
                <div class="card-field">
                  <span class="card-label">Item ${index + 1}</span>
                  <span class="card-value"></span>
                </div>
                <div class="card-field">
                  <span class="card-label">Nama Barang</span>
                  <span class="card-value">${item.nama_barang}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Satuan</span>
                  <span class="card-value">${item.satuan}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Harga Total</span>
                  <span class="card-value">${parseInt(item.harga_total).toLocaleString("id-ID")}</span>
                </div>
                <div class="card-field">
                  <span class="card-label">Harga Satuan</span>
                  <span class="card-value">${item.harga_satuan}</span>
                </div>
              </div>
            `;
          }
        });
      } else {
        mobileHTML = `<p style="text-align:center; color:#666; padding:10px;">Tidak ada item</p>`;
      }
      
      reviewMobileView.innerHTML = mobileHTML;

      document.getElementById("pengeluaranForm").style.display = "none";
      document.getElementById("reviewCard").style.display = "block";
    }

    function goBack() {
      document.getElementById("reviewCard").style.display = "none";
      document.getElementById("pengeluaranForm").style.display = "block";
    }

    async function confirmSubmit() {
      if (!formDataCache) return;
      
      logDebug("Memulai proses pengiriman data...");
      
      try {
        // Kirim data form terlebih dahulu
        logDebug("Mengirim data form ke webhook...");
        
        const formResponse = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            // Tambahkan header untuk mengatasi CORS
            "Accept": "application/json"
          },
          mode: "cors", // Explicitly set CORS mode
          body: JSON.stringify(formDataCache, null, 2)
        });
        
        logDebug(`Status response: ${formResponse.status}`);
        
        if (!formResponse.ok) {
          throw new Error(`HTTP error! status: ${formResponse.status}`);
        }
        
        const responseText = await formResponse.text();
        logDebug(`Response dari server: ${responseText}`);
        
        // Kirim file jika ada
        if (uploadedFiles.length > 0) {
          logDebug(`Mengirim ${uploadedFiles.length} file...`);
          
          for (const file of uploadedFiles) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("jenis", formDataCache.jenis);
            formData.append("tanggal", formDataCache.tanggal);
            
            const fileResponse = await fetch(WEBHOOK_URL, {
              method: "POST",
              body: formData
            });
            
            logDebug(`File ${file.name} dikirim dengan status: ${fileResponse.status}`);
          }
        }
        
        logDebug("Semua data berhasil dikirim!");
        
        // Kalau berhasil, tampilkan halaman terima kasih
        document.getElementById("reviewCard").style.display = "none";
        document.getElementById("thankyouCard").style.display = "block";
      } catch (err) {
        logDebug(`Error: ${err.message}`);
        document.getElementById("status").textContent = "Error: " + err.message;
        
        // Coba alternatif jika webhook utama gagal
        logDebug("Mencoba alternatif webhook...");
        try {
          // Ganti dengan URL testing jika tersedia
          const testResponse = await fetch(TEST_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({...formDataCache, test: true}, null, 2)
          });
          
          logDebug(`Alternatif webhook status: ${testResponse.status}`);
          
          if (testResponse.ok) {
            logDebug("Alternatif webhook berhasil!");
            document.getElementById("reviewCard").style.display = "none";
            document.getElementById("thankyouCard").style.display = "block";
          }
        } catch (altErr) {
          logDebug(`Alternatif webhook juga gagal: ${altErr.message}`);
        }
      }
    }
    
    function startNew() {
      // Reset form dan kembali ke halaman awal
      document.getElementById("thankyouCard").style.display = "none";
      document.getElementById("pengeluaranForm").style.display = "block";
      document.getElementById("pengeluaranForm").reset();
      uploadedFiles = [];
      document.getElementById("filePreview").innerHTML = "";
      document.getElementById("debugContent").innerHTML = "<p>Debug information will appear here when you submit the form.</p>";
      renderTable(document.getElementById("jenis").value);
    }

  </script>

</body>
</html>
