<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Absensi - masa.muda</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {margin:0;padding:0;box-sizing:border-box;}
    @font-face {
      font-family: 'Bristol';
      src: url('https://fonts.cdnfonts.com/s/85309/Bristol.woff') format('woff');
      font-weight: normal;
      font-style: italic;
    }
    body{font-family:'Poppins',sans-serif;background:#f8f9fa;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;color:#333;line-height:1.5;}
    .container{width:100%;max-width:450px;}
    .header{text-align:center;margin-bottom:25px;}
    .logo{font-family:'Poppins',sans-serif;font-size:36px;color:#7c895d;margin-bottom:5px;font-weight:500;letter-spacing:1px;}
    .subtitle{color:#6c757d;font-size:15px;font-weight:400;}
    
    /* Login Section */
    .login-section{display:block;}
    .login-card{background:#fff;border-radius:16px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
    .login-title{font-size:20px;color:#333;margin-bottom:20px;text-align:center;font-weight:500;}
    .form-group{margin-bottom:20px;}
    .form-label{display:block;margin-bottom:8px;font-weight:500;color:#555;}
    .form-select, .form-input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;font-family:'Poppins',sans-serif;}
    .login-btn{width:100%;padding:14px;border:none;border-radius:10px;font-size:16px;font-weight:500;cursor:pointer;transition:.3s;background:#7c895d;color:#fff;margin-top:10px;}
    .login-btn:hover{background:#6a7850;}
    .login-btn:disabled{background:#a8b4a0;cursor:not-allowed;}
    
    /* Loading Spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #7c895d;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Main App Section */
    #mainApp{display:none;}
    .card{background:#fff;border-radius:16px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
    .card-title{font-size:20px;color:#333;margin-bottom:20px;text-align:center;font-weight:500;}
    .user-info{background:#f0f3f5;border-radius:10px;padding:15px;margin-bottom:20px;text-align:center;position:relative;}
    .user-name{font-size:18px;font-weight:500;color:#7c895d;}
    .logout-btn{background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:5px;font-size:12px;margin-top:8px;cursor:pointer;}
    .device-info{font-size:12px;color:#666;margin-top:5px;}
    .shift-buttons{display:flex;gap:12px;margin-bottom:20px;}
    .shift-btn{flex:1;padding:14px;border:1px solid #dee2e6;border-radius:10px;font-size:15px;background:#fff;cursor:pointer;transition:.3s;font-weight:400;}
    .shift-btn.active{background:#7c895d;color:#fff;border-color:#7c895d;}
    .location-info{background:#f0f7f0;border-radius:10px;padding:15px;margin-bottom:20px;font-size:14px;}
    .location-status{display:flex;align-items:center;margin-bottom:8px;}
    .location-icon{margin-right:10px;font-size:16px;color:#7c895d;}
    .distance-info{font-weight:500;margin-top:8px;padding-top:8px;border-top:1px dashed #ccc;}
    .btn-record{width:100%;padding:16px;border:none;border-radius:10px;font-size:16px;font-weight:500;cursor:pointer;transition:.3s;background:#7c895d;color:#fff;margin-top:10px;}
    .btn-record:hover{background:#6a7850;}
    .btn-record:disabled{background:#a8b4a0;cursor:not-allowed;}
    
    /* Tombol Lihat Jadwal */
    .btn-schedule{width:100%;padding:14px;border:1px solid #7c895d;border-radius:10px;font-size:15px;font-weight:500;cursor:pointer;transition:.3s;background:#fff;color:#7c895d;margin-top:15px;text-decoration:none;display:block;text-align:center;}
    .btn-schedule:hover{background:#f8f9fa;border-color:#6a7850;color:#6a7850;}
    
    .msg{margin-top:20px;padding:12px 16px;border-radius:8px;text-align:center;font-weight:500;display:none;}
    .msg.success{background:#e8f5e9;color:#2e7d32;border:1px solid #c8e6c9;display:block;}
    .msg.error{background:#ffebee;color:#c62828;border:1px solid #ffcdd2;display:block;}
    .msg.info{background:#e3f2fd;color:#1565c0;border:1px solid #bbdefb;display:block;}
    .msg.warning{background:#fff3e0;color:#ef6c00;border:1px solid #ffcc80;display:block;}
    
    /* Modal */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000;padding:20px;}
    .modal-content{background:#fff;border-radius:16px;padding:25px;width:100%;max-width:400px;box-shadow:0 10px 25px rgba(0,0,0,.1);max-height:90vh;overflow-y:auto;}
    .modal-title{font-size:20px;color:#333;margin-bottom:20px;text-align:center;font-weight:500;}
    .review-item{margin-bottom:12px;display:flex;}
    .review-label{font-weight:500;width:100px;color:#6c757d;}
    .review-value{flex:1;color:#333;}
    .location-status-review{margin-top:15px;padding:12px;border-radius:8px;text-align:center;font-weight:500;}
    .location-valid{background:#e8f5e9;color:#2e7d32;}
    .location-invalid{background:#ffebee;color:#c62828;}
    .modal-buttons{display:flex;gap:12px;margin-top:25px;}
    .modal-buttons button{flex:1;padding:14px;border-radius:10px;font-weight:500;border:none;cursor:pointer;transition:.3s;}
    .btn-cancel{background:#f5f5f5;color:#666;}
    .btn-cancel:hover{background:#e0e0e0;}
    .btn-confirm{background:#7c895d;color:#fff;}
    .btn-confirm:hover{background:#6a7850;}
    
    .footer{text-align:center;margin-top:25px;color:#6c757d;font-size:14px;}
    
    /* Logout Modal */
    .logout-modal .modal-content{max-width:350px;}
    .password-input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;margin-bottom:15px;font-family:'Poppins',sans-serif;}
    
    /* Reporting Section */
    .reporting-section { display: none; }
    .reporting-card { background: #fff; border-radius: 16px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,.05); }
    .reporting-title { font-size: 20px; color: #333; margin-bottom: 20px; text-align: center; font-weight: 500; }
    .shift-info { background: #f0f7f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center; }
    .shift-type { font-size: 18px; font-weight: 500; color: #7c895d; }
    
    /* Task Checklist - NEW DESIGN */
    .task-section { margin-bottom: 25px; }
    .task-title { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #7c895d; }
    .task-list { list-style: none; }
    .task-item { 
      margin-bottom: 12px; 
      padding: 15px; 
      background: #f8f9fa; 
      border-radius: 12px; 
      border-left: 4px solid #dee2e6;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
    }
    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .task-item.checked { 
      background: #e8f5e9; 
      border-left-color: #4caf50; 
    }
    .task-checkbox { 
      margin-right: 15px; 
      transform: scale(1.3);
      cursor: pointer;
    }
    .task-label { 
      font-size: 14px; 
      cursor: pointer;
      flex: 1;
    }
    .task-number {
      display: inline-block;
      width: 24px;
      height: 24px;
      background: #7c895d;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      margin-right: 10px;
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Cash Drawer Section */
    .cash-section { background: #fff3e0; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .cash-title { font-size: 16px; font-weight: 500; color: #e65100; margin-bottom: 15px; }
    .cash-input-group { margin-bottom: 12px; }
    .cash-label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 14px; }
    .cash-input { width: 100%; padding: 10px; border: 1px solid #ffcc80; border-radius: 6px; font-size: 14px; font-family: 'Poppins', sans-serif; }
    
    /* Action Buttons */
    .action-buttons { display: flex; gap: 12px; margin-top: 25px; }
    .btn-back { flex: 1; padding: 14px; border: 1px solid #7c895d; border-radius: 10px; font-size: 16px; font-weight: 500; cursor: pointer; transition: .3s; background: #fff; color: #7c895d; }
    .btn-back:hover { background: #f8f9fa; }
    .btn-whatsapp { flex: 2; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 500; cursor: pointer; transition: .3s; background: #25D366; color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-whatsapp:hover { background: #128C7E; }
    .btn-whatsapp:disabled { background: #a8b4a0; cursor: not-allowed; }
    
    /* Progress Info */
    .progress-info { background: #e3f2fd; border-radius: 8px; padding: 12px; margin-bottom: 15px; text-align: center; font-size: 14px; }
    .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin: 8px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: #4caf50; border-radius: 4px; transition: width 0.3s ease; }
    
    /* Floating Help Button */
    .floating-help-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #7c895d;
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      border: none;
    }
    .floating-help-btn:hover {
      background: #6a7850;
      transform: scale(1.1);
    }
    
    /* Help Modal */
    .help-modal .modal-content {
      max-width: 500px;
    }
    .help-section {
      margin-bottom: 20px;
    }
    .help-title {
      font-size: 16px;
      font-weight: 600;
      color: #7c895d;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #e0e0e0;
    }
    .help-content {
      font-size: 14px;
      line-height: 1.6;
      color: #555;
    }
    .help-list {
      padding-left: 20px;
      margin: 10px 0;
    }
    .help-list li {
      margin-bottom: 8px;
    }
    .help-note {
      background: #fff3e0;
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 13px;
      border-left: 4px solid #ff9800;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">masa.muda</div>
      <div class="subtitle">Sistem Absensi Karyawan</div>
    </div>

    <!-- Login Section -->
    <div class="login-section" id="loginSection">
      <div class="login-card">
        <h2 class="login-title">Login Absensi</h2>
        <div class="form-group">
          <label class="form-label">Pilih Karyawan</label>
          <select class="form-select" id="employeeSelect">
            <option value="">Memuat data karyawan...</option>
          </select>
        </div>
        <button class="login-btn" id="loginBtn" disabled>
          <span class="loading-text">
            <span class="spinner"></span>
            Memuat data...
          </span>
        </button>
      </div>
    </div>

    <!-- Main App Section -->
    <div id="mainApp">
      <div class="card">
        <h2 class="card-title">Absensi Karyawan</h2>
        <div class="user-info">
          <div class="user-name" id="userName">-</div>
          <div class="device-info" id="deviceInfo"></div>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
        <div class="shift-buttons">
          <button class="shift-btn" id="shiftPagi">Shift Pagi</button>
          <button class="shift-btn" id="shiftClosing">Shift Closing</button>
        </div>
        <div class="location-info">
          <div class="location-status">
            <span class="location-icon">üìç</span>
            <span id="locationStatus">Mendapatkan lokasi...</span>
          </div>
          <div class="distance-info" id="distanceInfo"></div>
        </div>
        <button class="btn-record" id="btnRecord" disabled>Rekam Absen</button>
        
        <!-- Tombol Lihat Jadwal -->
        <a href="https://masamudaoperasional-collab.github.io/jadwalkaryawan.html" class="btn-schedule" target="_blank">
          üìÖ Lihat Jadwal
        </a>
        
        <div class="msg" id="msg"></div>
      </div>
      <div class="footer">&copy; 2025 masa.muda - All rights reserved</div>
    </div>

    <!-- Reporting Section -->
    <div class="reporting-section" id="reportingSection">
      <div class="reporting-card">
        <h2 class="reporting-title">Laporan Shift Harian</h2>
        
        <div class="shift-info">
          <div class="shift-type" id="currentShiftType">Shift Pagi</div>
          <div style="font-size: 14px; color: #666; margin-top: 5px;" id="reportingEmployee">Ahmad Wijaya</div>
        </div>

        <!-- Progress Info -->
        <div class="progress-info">
          <div id="progressText">Progress: 0/0 task (0%)</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div style="font-size: 12px; color: #666;">Minimal 80% task harus diselesaikan</div>
        </div>

        <!-- Cash Drawer Information -->
        <div class="cash-section">
          <h3 class="cash-title">üí∞ Informasi Petty Cash Drawer</h3>
          <div class="cash-input-group">
            <label class="cash-label">Petty Cash Awal Shift (Wajib)</label>
            <input type="number" class="cash-input" id="cashStart" placeholder="Masukkan jumlah petty cash awal shift">
          </div>
          <div class="cash-input-group">
            <label class="cash-label">Catatan Tambahan</label>
            <input type="text" class="cash-input" id="cashNotes" placeholder="Catatan mengenai cash drawer...">
          </div>
        </div>

        <!-- Task Checklist akan dimuat secara dinamis -->
        <div id="taskChecklistContainer"></div>

        <div class="action-buttons">
          <button class="btn-back" id="backToAttendance">Kembali ke Absensi</button>
          <button class="btn-whatsapp" id="shareToWhatsapp" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893c0-3.176-1.24-6.165-3.495-8.411"/>
            </svg>
            Bagikan ke WhatsApp
          </button>
        </div>
      </div>
      <div class="footer">&copy; 2025 masa.muda - All rights reserved</div>
    </div>
  </div>

  <!-- Modal Review Absensi -->
  <div class="modal" id="reviewModal">
    <div class="modal-content">
      <h3 class="modal-title">Konfirmasi Absensi</h3>
      <div id="reviewText"></div>
      <div id="locationStatusReview"></div>
      <div class="modal-buttons">
        <button class="btn-cancel" id="cancelBtn">Batal</button>
        <button class="btn-confirm" id="confirmBtn">Rekam Absen</button>
      </div>
    </div>
  </div>

  <!-- Modal Logout Confirmation -->
  <div class="modal logout-modal" id="logoutModal">
    <div class="modal-content">
      <h3 class="modal-title">Konfirmasi Logout</h3>
      <p style="margin-bottom:15px;text-align:center;">Masukkan password untuk logout:</p>
      <input type="password" class="password-input" id="logoutPassword" placeholder="Password logout">
      <div class="modal-buttons">
        <button class="btn-cancel" id="logoutCancelBtn">Batal</button>
        <button class="btn-confirm" id="logoutConfirmBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- Floating Help Button -->
  <button class="floating-help-btn" id="helpBtn">?</button>

  <!-- Help Modal -->
  <div class="modal help-modal" id="helpModal">
    <div class="modal-content">
      <h3 class="modal-title">üìã Panduan Penggunaan Sistem</h3>
      
      <div class="help-section">
        <div class="help-title">CARA PENGGUNAAN APLIKASI ABSENSI</div>
        <div class="help-content">
          <ol class="help-list">
            <li><strong>Login:</strong> Pilih nama Anda dari dropdown dan klik "Masuk ke Sistem"</li>
            <li><strong>Pilih Shift:</strong> Klik tombol "Shift Pagi" atau "Shift Closing" sesuai jadwal Anda</li>
            <li><strong>Rekam Absensi:</strong> Pastikan lokasi sudah terdeteksi, lalu klik "Rekam Absen"</li>
            <li><strong>Konfirmasi:</strong> Periksa data absensi dan klik "Rekam Absen" untuk mengirim</li>
            <li><strong>Laporan Harian:</strong> Isi checklist task dan informasi cash drawer</li>
            <li><strong>Share Laporan:</strong> Kirim laporan ke WhatsApp grup masa.muda setelah menyelesaikan task</li>
          </ol>
        </div>
      </div>

      <div class="help-section">
        <div class="help-title">KETENTUM UMUM</div>
        <div class="help-content">
          <ul class="help-list">
            <li>Absensi hanya bisa dilakukan dalam radius <strong>100 meter</strong> dari lokasi masa.muda</li>
            <li>Pastikan GPS/Lokasi di perangkat Anda sudah diaktifkan</li>
            <li>Data absensi akan tercatat secara otomatis dengan timestamp</li>
            <li>Setiap karyawan hanya bisa login di satu perangkat</li>
            <li>Laporan harian wajib dikirim sebelum akhir shift</li>
          </ul>
        </div>
      </div>

      <div class="help-section">
        <div class="help-title">TROUBLESHOOTING</div>
        <div class="help-content">
          <ul class="help-list">
            <li><strong>Lokasi tidak terdeteksi:</strong> Pastikan izin lokasi sudah diberikan ke browser</li>
            <li><strong>Gagal login:</strong> Refresh halaman dan coba kembali</li>
            <li><strong>Tombol absen tidak aktif:</strong> Pastikan sudah memilih shift dan lokasi terdeteksi</li>
            <li><strong>Data tidak muncul:</strong> Periksa koneksi internet Anda</li>
          </ul>
        </div>
      </div>

      <div class="help-note">
        <strong>Catatan Penting:</strong> Sistem ini dirancang untuk memudahkan proses absensi dan pelaporan harian. Pastikan data yang dimasukkan akurat dan sesuai dengan kondisi sebenarnya.
      </div>

      <div class="modal-buttons">
        <button class="btn-confirm" id="closeHelpBtn">Mengerti</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const OFFICE_LAT = -6.550851308037668;
    const OFFICE_LON = 106.73153435127753;
    const RADIUS_METERS = 100;
    const WEBHOOK_URL = "https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/attendance-receiver";
    const EMPLOYEE_WEBHOOK_URL = "https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/employeeId";
    const LOGOUT_PASSWORD = "masamuda2025";
    
    // ==================== SESSION MANAGER ====================
    class SessionManager {
      constructor() {
        this.SESSION_KEY = 'attendance_session';
        this.DEVICE_KEY = 'attendance_device_id';
        this.EXPIRY_DAYS = 30;
      }

      saveSession(employeeData) {
        const sessionData = {
          employeeId: employeeData.employeeId,
          employeeName: employeeData.Name,
          deviceId: this.getOrCreateDeviceId(),
          deviceFingerprint: this.generateDeviceFingerprint(),
          loginTimestamp: new Date().toISOString(),
          sessionExpiry: new Date(Date.now() + (this.EXPIRY_DAYS * 24 * 60 * 60 * 1000)).toISOString()
        };
        
        localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
        return sessionData;
      }

      getCurrentSession() {
        const sessionStr = localStorage.getItem(this.SESSION_KEY);
        if (!sessionStr) return null;
        
        try {
          const session = JSON.parse(sessionStr);
          if (new Date(session.sessionExpiry) < new Date()) {
            this.clearSession();
            return null;
          }
          return session;
        } catch (e) {
          this.clearSession();
          return null;
        }
      }

      clearSession() {
        localStorage.removeItem(this.SESSION_KEY);
      }

      getOrCreateDeviceId() {
        let deviceId = localStorage.getItem(this.DEVICE_KEY);
        if (!deviceId) {
          deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem(this.DEVICE_KEY, deviceId);
        }
        return deviceId;
      }

      generateDeviceFingerprint() {
        const components = [
          navigator.userAgent,
          navigator.language,
          navigator.hardwareConcurrency || 'unknown',
          screen.width + 'x' + screen.height,
          new Date().getTimezoneOffset(),
          navigator.platform
        ];
        return btoa(components.join('|'));
      }
    }

    // ==================== EMPLOYEE DATA MANAGER ====================
    class EmployeeManager {
      constructor() {
        this.EMPLOYEE_KEY = 'employee_data';
        this.CACHE_DURATION = 30 * 60 * 1000; // 30 menit
      }

      async fetchEmployees() {
        try {
          const response = await fetch(EMPLOYEE_WEBHOOK_URL);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const employees = await response.json();
          
          // Simpan ke cache dengan timestamp
          const cacheData = {
            employees: employees,
            timestamp: Date.now()
          };
          localStorage.setItem(this.EMPLOYEE_KEY, JSON.stringify(cacheData));
          
          return employees;
        } catch (error) {
          console.error('Error fetching employees:', error);
          // Fallback ke cache jika ada
          const cached = this.getCachedEmployees();
          if (cached) {
            return cached;
          }
          throw error;
        }
      }

      getCachedEmployees() {
        try {
          const cached = localStorage.getItem(this.EMPLOYEE_KEY);
          if (!cached) return null;
          
          const cacheData = JSON.parse(cached);
          const isExpired = Date.now() - cacheData.timestamp > this.CACHE_DURATION;
          
          if (!isExpired) {
            return cacheData.employees;
          }
        } catch (e) {
          console.error('Error reading cached employees:', e);
        }
        return null;
      }

      populateEmployeeSelect(employees) {
        const select = document.getElementById('employeeSelect');
        select.innerHTML = '<option value="">Pilih nama Anda</option>';
        
        employees.forEach(employee => {
          const option = document.createElement('option');
          option.value = employee.employeeId;
          option.textContent = `${employee.Name} (${employee.employeeId})`;
          select.appendChild(option);
        });
      }

      getEmployeeById(employeeId, employees) {
        return employees.find(emp => emp.employeeId === employeeId);
      }
    }

    // ==================== TASK DATA - UPDATED ====================
    const TASK_TEMPLATES = {
      pagi: {
        title: "TO DO LIST AWAL SHIFT OPENING",
        tasks: [
          "Travel Path",
          "Prepare Bahan Baku", 
          "Kebersihan Floor",
          "Lampu & Dekor",
          "Sound",
          "Tissue WC & Wastafel",
          "Cek Kebersihan Toilet",
          "Kaca"
        ]
      },
      closing: {
        title: "TO DO LIST AWAL SHIFT CLOSING",
        tasks: [
          "Travel Path",
          "Prepare Bahan Baku",
          "Kebersihan Floor", 
          "Kebersihan Peralatan",
          "Tissue WC & Wastafel",
          "Kaca",
          "Transfer Informasi dari Shift Opening",
          "Mencatat bahan baku yang menipis"
        ]
      }
    };

    // ==================== ATTENDANCE SYSTEM ====================
    const sessionManager = new SessionManager();
    const employeeManager = new EmployeeManager();
    let userLocation = null, selectedShift = "", currentDistance = 0, employeesData = [];

    // DOM Elements
    const msgEl = document.getElementById("msg"),
          locationStatus = document.getElementById("locationStatus"),
          distanceInfo = document.getElementById("distanceInfo"),
          userName = document.getElementById("userName"),
          deviceInfo = document.getElementById("deviceInfo"),
          btnRecord = document.getElementById("btnRecord"),
          loginSection = document.getElementById("loginSection"),
          mainApp = document.getElementById("mainApp"),
          employeeSelect = document.getElementById("employeeSelect"),
          loginBtn = document.getElementById("loginBtn"),
          logoutBtn = document.getElementById("logoutBtn"),
          reportingSection = document.getElementById("reportingSection");

    // Geolocation Functions
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function getLocation() {
      if (!navigator.geolocation) {
        locationStatus.textContent = "Browser tidak mendukung geolokasi.";
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          currentDistance = getDistance(OFFICE_LAT, OFFICE_LON, userLocation.lat, userLocation.lng);
          locationStatus.textContent = "Lokasi berhasil didapatkan";
          distanceInfo.textContent = `Jarak dari masa.muda: ${Math.round(currentDistance)} meter`;
          distanceInfo.style.color = (currentDistance <= RADIUS_METERS ? '#2e7d32' : '#c62828');
          if (selectedShift) btnRecord.disabled = false;
        },
        err => {
          locationStatus.textContent = 'Gagal mendapatkan lokasi.';
          const saved = localStorage.getItem('userLocation');
          if (saved) {
            userLocation = JSON.parse(saved);
            currentDistance = getDistance(OFFICE_LAT, OFFICE_LON, userLocation.lat, userLocation.lng);
            distanceInfo.textContent = `Jarak dari kantor: ${Math.round(currentDistance)} meter`;
            distanceInfo.style.color = (currentDistance <= RADIUS_METERS ? '#2e7d32' : '#c62828');
            if (selectedShift) btnRecord.disabled = false;
          }
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
      );
    }

    // Attendance Functions
    function sendAttendance(data) {
      showMessage("Mengirim data absensi...", "info");
      fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(r => {
        if (r.ok) {
          const statusLokasi = (currentDistance <= RADIUS_METERS) ? "VALID" : "TIDAK VALID";
          const statusClass = (currentDistance <= RADIUS_METERS) ? "success" : "warning";
          const icon = (currentDistance <= RADIUS_METERS) ? "‚úÖ" : "‚ö†Ô∏è";
          
          showMessage(`${icon} Absensi berhasil dikirim! (Status: ${statusLokasi})`, statusClass);
          
          setTimeout(() => {
            showReportingPage(selectedShift.toLowerCase());
          }, 2000);
          
        } else {
          showMessage("Gagal mengirim absensi.", "error");
        }
      })
      .catch(err => {
        showMessage("Error koneksi.", "error");
      });
    }

    function showMessage(msg, type) {
      msgEl.textContent = msg;
      msgEl.className = "msg " + type;
    }

    function showReview() {
      const reviewText = document.getElementById("reviewText"),
            locationStatusReview = document.getElementById("locationStatusReview");
      
      const currentSession = sessionManager.getCurrentSession();
      let statusLokasiTxt = "", statusClass = "";
      
      if (currentDistance <= RADIUS_METERS) {
        statusLokasiTxt = "Lokasi sesuai untuk absensi";
        statusClass = "location-status-review location-valid";
      } else {
        statusLokasiTxt = "Lokasi tidak sesuai - Absensi tetap dapat dikirim";
        statusClass = "location-status-review location-invalid";
      }
      
      reviewText.innerHTML = `
        <div class="review-item"><div class="review-label">ID:</div><div class="review-value">${currentSession.employeeId}</div></div>
        <div class="review-item"><div class="review-label">Nama:</div><div class="review-value">${currentSession.employeeName}</div></div>
        <div class="review-item"><div class="review-label">Shift:</div><div class="review-value">${selectedShift}</div></div>
        <div class="review-item"><div class="review-label">Waktu:</div><div class="review-value">${new Date().toLocaleString()}</div></div>
        <div class="review-item"><div class="review-label">Jarak:</div><div class="review-value">${Math.round(currentDistance)} meter</div></div>
        <div class="review-item"><div class="review-label">Status Lokasi:</div><div class="review-value">${currentDistance <= RADIUS_METERS ? 'VALID' : 'TIDAK VALID'}</div></div>
        <div class="review-item"><div class="review-label">Device ID:</div><div class="review-value">${currentSession.deviceId}</div></div>`;
      
      locationStatusReview.innerHTML = `<div class="${statusClass}">${statusLokasiTxt}</div>`;
      document.getElementById("reviewModal").style.display = "flex";
    }

    function selectShift(s) {
      selectedShift = s;
      document.getElementById("shiftPagi").classList.remove("active");
      document.getElementById("shiftClosing").classList.remove("active");
      document.getElementById("shift" + s).classList.add("active");
      if (userLocation) btnRecord.disabled = false;
    }

    // ==================== REPORTING FUNCTIONS ====================
    function showReportingPage(shiftType) {
      mainApp.style.display = 'none';
      reportingSection.style.display = 'block';
      
      document.getElementById('currentShiftType').textContent = `Shift ${shiftType === 'pagi' ? 'Pagi' : 'Closing'}`;
      
      const currentSession = sessionManager.getCurrentSession();
      document.getElementById('reportingEmployee').textContent = currentSession.employeeName;
      
      loadTaskChecklist(shiftType);
    }

    function loadTaskChecklist(shiftType) {
      const container = document.getElementById('taskChecklistContainer');
      const template = TASK_TEMPLATES[shiftType];
      
      if (!template) {
        container.innerHTML = '<div class="msg error">Template task tidak ditemukan</div>';
        return;
      }
      
      let html = `
        <div class="task-section">
          <h3 class="task-title">${template.title}</h3>
          <ul class="task-list" id="taskList">
      `;
      
      template.tasks.forEach((task, index) => {
        html += `
          <li class="task-item" id="taskItem-${index}">
            <input type="checkbox" class="task-checkbox" id="task-${index}" data-task="${task}">
            <label class="task-label" for="task-${index}">
              <span class="task-number">${index + 1}</span>
              ${task}
            </label>
          </li>
        `;
      });
      
      html += `</ul></div>`;
      container.innerHTML = html;
      
      template.tasks.forEach((_, index) => {
        document.getElementById(`task-${index}`).addEventListener('change', updateProgress);
      });
    }

    function updateProgress() {
      const checkboxes = document.querySelectorAll('.task-checkbox');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const totalCount = checkboxes.length;
      const minRequired = Math.ceil(totalCount * 0.8);
      const completionRate = Math.round((checkedCount / totalCount) * 100);
      
      const progressText = document.getElementById('progressText');
      const progressFill = document.getElementById('progressFill');
      const whatsappBtn = document.getElementById('shareToWhatsapp');
      
      progressText.textContent = `Progress: ${checkedCount}/${totalCount} task (${completionRate}%)`;
      progressFill.style.width = `${completionRate}%`;
      
      if (checkedCount >= minRequired) {
        whatsappBtn.disabled = false;
        whatsappBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893c0-3.176-1.24-6.165-3.495-8.411"/>
          </svg>
          Bagikan ke WhatsApp (${checkedCount}/${totalCount})
        `;
      } else {
        whatsappBtn.disabled = true;
        whatsappBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893c0-3.176-1.24-6.165-3.495-8.411"/>
          </svg>
          Lengkapi Task (${checkedCount}/${minRequired})
        `;
      }
      
      checkboxes.forEach((checkbox, index) => {
        const taskItem = document.getElementById(`taskItem-${index}`);
        taskItem.classList.toggle('checked', checkbox.checked);
      });
    }

    function generateWhatsAppMessage() {
      const currentSession = sessionManager.getCurrentSession();
      const checkboxes = document.querySelectorAll('.task-checkbox');
      const completedTasks = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.getAttribute('data-task'));
      const totalTasks = checkboxes.length;
      const completionRate = Math.round((completedTasks.length / totalTasks) * 100);
      
      const cashStart = document.getElementById('cashStart').value;
      const cashNotes = document.getElementById('cashNotes').value;
      
      let message = `üìã *LAPORAN SHIFT ${selectedShift.toUpperCase()} - masa.muda*\n\n`;
      message += `üë§ *Karyawan:* ${currentSession.employeeName}\n`;
      message += `üïí *Shift:* ${selectedShift}\n`;
      message += `üìÖ *Tanggal:* ${new Date().toLocaleDateString('id-ID')}\n`;
      message += `‚è∞ *Waktu:* ${new Date().toLocaleTimeString('id-ID')}\n\n`;
      
      message += `üí∞ *PETTY CASH DRAWER*\n`;
      message += `Petty Cash Awal: ${cashStart ? 'Rp ' + parseInt(cashStart).toLocaleString('id-ID') : 'Tidak diisi'}\n`;
      if (cashNotes) message += `Catatan: ${cashNotes}\n`;
      message += `\n`;
      
      message += `üìù *TASK YANG DISELESAIKAN:*\n`;
      completedTasks.forEach((task, index) => {
        message += `${index + 1}. ${task}\n`;
      });
      
      return encodeURIComponent(message);
    }

    function shareToWhatsApp() {
      const message = generateWhatsAppMessage();
      
      // Buka WhatsApp tanpa nomor tujuan (user pilih kontak manual)
      const whatsappUrl = `https://wa.me/?text=${message}`;
      
      window.open(whatsappUrl, '_blank');
      
      showMessage("‚úÖ Membuka WhatsApp... Silakan pilih kontak tujuan untuk mengirim laporan", "success");
      
      setTimeout(() => {
        reportingSection.style.display = 'none';
        mainApp.style.display = 'block';
        resetReportingForm();
      }, 3000);
    }

    function resetReportingForm() {
      document.getElementById('cashStart').value = '';
      document.getElementById('cashNotes').value = '';
      selectedShift = "";
      
      document.getElementById("shiftPagi").classList.remove("active");
      document.getElementById("shiftClosing").classList.remove("active");
      btnRecord.disabled = true;
    }

    // ==================== HELP MODAL FUNCTIONS ====================
    function showHelpModal() {
      document.getElementById("helpModal").style.display = "flex";
    }

    function closeHelpModal() {
      document.getElementById("helpModal").style.display = "none";
    }

    // ==================== LOGIN/LOGOUT FUNCTIONS ====================
    async function initializeApp() {
      // Coba load data karyawan terlebih dahulu
      await loadEmployees();
      
      const currentSession = sessionManager.getCurrentSession();
      
      if (currentSession) {
        handleAutoLogin(currentSession);
      } else {
        loginSection.style.display = 'block';
        mainApp.style.display = 'none';
      }
    }

    async function loadEmployees() {
      try {
        employeesData = await employeeManager.fetchEmployees();
        employeeManager.populateEmployeeSelect(employeesData);
        
        // Enable login button
        loginBtn.disabled = false;
        loginBtn.innerHTML = "Masuk ke Sistem";
        
      } catch (error) {
        console.error('Failed to load employees:', error);
        employeeSelect.innerHTML = '<option value="">Gagal memuat data karyawan</option>';
        loginBtn.disabled = true;
        loginBtn.innerHTML = "Gagal memuat data";
        showMessage("Gagal memuat data karyawan. Silakan refresh halaman.", "error");
      }
    }

    function handleAutoLogin(session) {
      loginSection.style.display = 'none';
      mainApp.style.display = 'block';
      
      userName.textContent = session.employeeName;
      deviceInfo.textContent = `Device: ${session.deviceId.substring(0, 10)}...`;
      
      console.log(`Auto-login sebagai: ${session.employeeName}`);
      getLocation();
    }

    function handleManualLogin() {
      const selectedEmployeeId = employeeSelect.value;
      if (!selectedEmployeeId) {
        alert("Silakan pilih karyawan terlebih dahulu");
        return;
      }

      const employeeData = employeeManager.getEmployeeById(selectedEmployeeId, employeesData);
      if (employeeData) {
        const session = sessionManager.saveSession(employeeData);
        handleAutoLogin(session);
      } else {
        alert("Data karyawan tidak ditemukan");
      }
    }

    function showLogoutModal() {
      document.getElementById("logoutPassword").value = "";
      document.getElementById("logoutModal").style.display = "flex";
    }

    function handleLogout() {
      const password = document.getElementById("logoutPassword").value;
      if (password === LOGOUT_PASSWORD) {
        sessionManager.clearSession();
        document.getElementById("logoutModal").style.display = "none";
        loginSection.style.display = 'block';
        mainApp.style.display = 'none';
        employeeSelect.value = "";
        selectedShift = "";
      } else {
        alert("Password logout salah!");
      }
    }

    // ==================== EVENT LISTENERS ====================
    window.addEventListener('load', initializeApp);

    loginBtn.addEventListener('click', handleManualLogin);
    logoutBtn.addEventListener('click', showLogoutModal);

    document.getElementById("shiftPagi").onclick = () => selectShift("Pagi");
    document.getElementById("shiftClosing").onclick = () => selectShift("Closing");
    
    document.getElementById("btnRecord").onclick = () => {
      if (!selectedShift) {
        showMessage("Pilih shift dulu", "error");
        return;
      }
      if (!userLocation) {
        showMessage("Lokasi tidak tersedia", "error");
        return;
      }
      showReview();
    };

    document.getElementById("cancelBtn").onclick = () => {
      document.getElementById("reviewModal").style.display = "none";
    };

    document.getElementById("confirmBtn").onclick = () => {
      const currentSession = sessionManager.getCurrentSession();
      const statusLokasi = (currentDistance <= RADIUS_METERS) ? "Valid" : "Invalid";
      
      const data = {
        id: currentSession.employeeId,
        nama: currentSession.employeeName,
        deviceId: currentSession.deviceId,
        deviceFingerprint: currentSession.deviceFingerprint,
        shift: selectedShift,
        tipe: "selesai",
        datetime: new Date().toISOString(),
        distance: Math.round(currentDistance),
        statusLokasi: statusLokasi,
        lokasi: userLocation,
        loginTimestamp: currentSession.loginTimestamp
      };
      
      sendAttendance(data);
      document.getElementById("reviewModal").style.display = "none";
    };

    // Logout modal handlers
    document.getElementById("logoutCancelBtn").onclick = () => {
      document.getElementById("logoutModal").style.display = "none";
    };

    document.getElementById("logoutConfirmBtn").onclick = handleLogout;

    // Reporting handlers
    document.getElementById('backToAttendance').addEventListener('click', () => {
      reportingSection.style.display = 'none';
      mainApp.style.display = 'block';
    });

    document.getElementById('shareToWhatsapp').addEventListener('click', shareToWhatsApp);

    // Help modal handlers
    document.getElementById('helpBtn').addEventListener('click', showHelpModal);
    document.getElementById('closeHelpBtn').addEventListener('click', closeHelpModal);

    // Enter key untuk logout password
    document.getElementById("logoutPassword").addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleLogout();
      }
    });

    // Close modal ketika klik di luar konten
    window.addEventListener('click', (e) => {
      const helpModal = document.getElementById('helpModal');
      if (e.target === helpModal) {
        closeHelpModal();
      }
    });
  </script>
</body>
</html>
