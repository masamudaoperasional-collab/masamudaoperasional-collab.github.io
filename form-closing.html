<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Closing Penjualan - Masakluda</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --danger-color: #ef4444;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --text-color: #333;
      --border-color: #ccc;
      --background-color: #f9fafb;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 15px;
      background: var(--background-color);
      color: var(--text-color);
      font-size: 16px;
      line-height: 1.5;
    }
    
    h2, h3 { 
      text-align: center; 
      margin-bottom: 20px; 
      color: var(--primary-color); 
      font-weight: 600; 
    }
    
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.3rem; }
    
    .card {
      max-width: 100%;
      width: 100%;
      margin: 0 auto 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .form-row { 
      display: flex; 
      gap: 15px; 
      margin-bottom: 15px; 
      flex-wrap: wrap; 
    }
    
    .form-group { 
      flex: 1; 
      min-width: 0;
    }
    
    label { 
      font-weight: 500; 
      display: block; 
      margin-bottom: 6px; 
    }
    
    select, input[type="text"], input[type="number"], input[type="date"] {
      width: 100%; 
      padding: 12px 10px; 
      border: 1px solid var(--border-color);
      border-radius: 6px; 
      outline: none; 
      font-family: 'Poppins', sans-serif; 
      font-size: 16px;
    }
    
    select:focus, input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    
    button {
      padding: 12px 16px; 
      border-radius: 6px; 
      border: none; 
      cursor: pointer;
      font-weight: 500; 
      transition: all 0.2s; 
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .primary-btn { 
      background: var(--primary-color); 
      color: white; 
    }
    
    .success-btn { 
      background: var(--success-color); 
      color: white; 
    }
    
    .danger-btn { 
      background: var(--danger-color); 
      color: white; 
    }
    
    .warning-btn { 
      background: var(--warning-color); 
      color: white; 
    }
    
    .table-wrapper { 
      width: 100%; 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    table {
      width: 100%; 
      border-collapse: collapse; 
      margin: 0;
      font-size: 14px; 
    }
    
    th, td { 
      border: 1px solid #e5e7eb; 
      padding: 10px 8px; 
      text-align: center; 
      word-break: break-word;
    }
    
    th { 
      background-color: #f3f4f6; 
      font-weight: 500; 
      white-space: nowrap;
    }
    
    .match { background-color: #d1fae5; }
    .mismatch { background-color: #fee2e2; }
    .warning { background-color: #fef3c7; }
    
    .status-card {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 500;
    }
    
    .status-success {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .status-warning {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .status-error {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    .hidden {
      display: none;
    }
    
    .summary-card {
      background-color: #f0f9ff;
      border-left: 4px solid var(--primary-color);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      body { 
        padding: 10px; 
        font-size: 15px; 
      }
      
      .card { 
        padding: 15px; 
      }
      
      .form-row { 
        flex-direction: column; 
        gap: 15px; 
      }
      
      .form-group { 
        width: 100%; 
      }
      
      table { 
        font-size: 14px; 
        min-width: 600px;
      }
      
      th, td {
        padding: 8px 6px;
      }
    }
  </style>
</head>
<body>

  <h2>Form Closing Penjualan - Masakluda</h2>
  
  <!-- Step 1: Input Data Dasar -->
  <div class="card" id="step1">
    <h3>Data Closing Penjualan</h3>
    
    <div class="form-row">
      <div class="form-group">
        <label for="tanggalClosing">Tanggal Closing:</label>
        <input type="date" id="tanggalClosing" name="tanggalClosing">
      </div>
      <div class="form-group">
        <label for="shift">Shift:</label>
        <select id="shift" name="shift">
          <option value="pagi">Pagi</option>
          <option value="siang">Siang</option>
          <option value="malam">Malam</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label for="karyawan">Nama Karyawan:</label>
      <input type="text" id="karyawan" name="karyawan" placeholder="Nama karyawan yang bertugas">
    </div>
    
    <button class="primary-btn" onclick="ambilDataResi()" style="width: 100%;" id="btnProses">
      <span id="btnText">Proses Resi dan Ambil Data</span>
      <span id="btnLoading" class="hidden loading"></span>
    </button>
  </div>

  <!-- Step 2: Data dari Resi dan Input Aktual -->
  <div class="card hidden" id="step2">
    <h3>Data dari Resi vs Aktual Kas</h3>
    
    <div id="statusInfo"></div>
    
    <!-- Informasi Header dari Resi -->
    <div class="card summary-card">
      <h4>Informasi Resi</h4>
      <div class="form-row">
        <div class="form-group">
          <label>Outlet:</label>
          <input type="text" id="outlet" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>Tanggal Transaksi:</label>
          <input type="text" id="tanggalTransaksi" readonly style="background: #f5f5f5;">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Jumlah Tamu:</label>
          <input type="text" id="jumlahTamu" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>Total Resi:</label>
          <input type="text" id="totalResi" readonly style="background: #f5f5f5;">
        </div>
      </div>
    </div>
    
    <!-- Ringkasan Penjualan -->
    <div class="table-wrapper">
      <table id="tabelRingkasan">
        <thead>
          <tr>
            <th>Item</th>
            <th>Nilai dari Resi (Rp)</th>
            <th>Nilai Aktual (Rp)</th>
            <th>Selisih (Rp)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="bodyTabelRingkasan">
          <!-- Data akan diisi oleh JavaScript -->
        </tbody>
      </table>
    </div>
    
    <!-- Detail Pembayaran -->
    <h4>Detail Pembayaran</h4>
    <div class="table-wrapper">
      <table id="tabelPembayaran">
        <thead>
          <tr>
            <th>Metode Pembayaran</th>
            <th>Penjualan (Resi)</th>
            <th>Penjualan (Aktual)</th>
            <th>Selisih</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="bodyTabelPembayaran">
          <!-- Data akan diisi oleh JavaScript -->
        </tbody>
      </table>
    </div>
    
    <div class="form-group">
      <label for="keteranganUmum">Keterangan Umum:</label>
      <textarea id="keteranganUmum" name="keteranganUmum" placeholder="Tambahkan catatan mengenai closing penjualan..." style="width: 100%; padding: 12px 10px; border-radius: 6px; border: 1px solid #ccc; min-height: 100px; font-family: 'Poppins', sans-serif;"></textarea>
    </div>
    
    <div class="form-row">
      <button class="danger-btn" onclick="kembaliKeStep1()" style="flex: 1;">Kembali</button>
      <button class="success-btn" onclick="prosesClosing()" style="flex: 2;" id="btnSubmit">
        <span id="submitText">Submit Closing</span>
        <span id="submitLoading" class="hidden loading"></span>
      </button>
    </div>
  </div>

  <!-- Step 3: Hasil Closing -->
  <div class="card hidden summary-card" id="step3">
    <h3>Hasil Closing Penjualan</h3>
    
    <div id="summaryInfo"></div>
    
    <div class="table-wrapper">
      <table id="tabelHasil">
        <thead>
          <tr>
            <th>Item</th>
            <th>Nilai</th>
          </tr>
        </thead>
        <tbody id="bodyTabelHasil">
          <!-- Data akan diisi oleh JavaScript -->
        </tbody>
      </table>
    </div>
    
    <div class="form-row">
      <button class="primary-btn" onclick="cetakLaporan()" style="flex: 1;">Cetak Laporan</button>
      <button class="success-btn" onclick="simpanDanTutup()" style="flex: 1;">Selesai</button>
    </div>
  </div>

  <script>
      console.log('üìÑ Script JavaScript mulai loading...');
      
      // Webhook URLs
      const WEBHOOK_GET_DATA = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook-test/get-resi-data';
      const WEBHOOK_SUBMIT_DATA = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook-test/5aef7833-d0fb-4c04-8aec-d99784165f15';
  
      // Variabel global
      let dataResi = {};
      let chatId = '';
  
      // Fungsi untuk mengambil parameter dari URL
      function getUrlParams() {
        console.log('üîó Mengambil parameter dari URL...');
        const params = new URLSearchParams(window.location.search);
        const result = {
          chatId: params.get('chat_id'),
          tanggal: params.get('tanggal'),
          shift: params.get('shift')
        };
        console.log('üìã Parameter URL:', result);
        return result;
      }
  
      // Inisialisasi saat halaman dimuat
      document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM fully loaded and parsed');
        
        const params = getUrlParams();
        
        // Ambil chat_id dari URL parameter (otomatis dari Telegram)
        if (params.chatId) {
          chatId = params.chatId;
          console.log('üí¨ Chat ID dari URL:', chatId);
        } else {
          console.warn('‚ö†Ô∏è Chat ID tidak ditemukan di URL');
        }
        
        // Set nilai form dari URL parameters jika ada
        if (params.tanggal) {
          document.getElementById('tanggalClosing').value = params.tanggal;
          console.log('üìÖ Tanggal dari URL:', params.tanggal);
        }
        
        if (params.shift) {
          document.getElementById('shift').value = params.shift;
          console.log('üïí Shift dari URL:', params.shift);
        }
        
        // Set tanggal default ke hari ini jika tidak ada parameter
        if (!params.tanggal) {
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          document.getElementById('tanggalClosing').value = todayStr;
          console.log('üìÖ Tanggal default di-set ke:', todayStr);
        }
        
        console.log('üéâ Form siap digunakan');
      });
  
      // Fungsi untuk menampilkan/menyembunyikan loading
      function setLoading(buttonId, isLoading) {
        console.log('üîÑ Set loading:', buttonId, isLoading);
        const btn = document.getElementById(buttonId);
        const text = document.getElementById(buttonId === 'btnProses' ? 'btnText' : 'submitText');
        const loading = document.getElementById(buttonId === 'btnProses' ? 'btnLoading' : 'submitLoading');
        
        if (isLoading) {
          btn.disabled = true;
          text.classList.add('hidden');
          loading.classList.remove('hidden');
          console.log('‚è≥ Loading ditampilkan untuk', buttonId);
        } else {
          btn.disabled = false;
          text.classList.remove('hidden');
          loading.classList.add('hidden');
          console.log('‚úÖ Loading disembunyikan untuk', buttonId);
        }
      }
  
      // Fungsi untuk memproses data resi dengan berbagai format response
      function processResiData(data) {
        console.log('üîß Processing data:', data);
        
        // Jika data adalah array, ambil elemen pertama
        if (Array.isArray(data)) {
          if (data.length === 0) {
            throw new Error('Data resi tidak ditemukan untuk parameter yang diberikan');
          }
          console.log('üì¶ Data adalah array, mengambil elemen pertama');
          return data[0];
        }
        
        // Jika data adalah object langsung
        if (typeof data === 'object' && data !== null) {
          // Cek jika mengandung error message
          if (data.error || data.message) {
            throw new Error(data.message || data.error || 'Terjadi kesalahan pada server');
          }
          
          // Cek jika data ada di property tertentu
          if (data.data) {
            console.log('üìä Data ditemukan di property "data"');
            return data.data;
          }
          
          // Jika data langsung berisi informasi resi
          if (data.total_penjualan || data.metode_pembayaran) {
            console.log('‚úÖ Data langsung berisi informasi resi');
            return data;
          }
        }
        
        // Jika format tidak dikenali
        throw new Error('Format data tidak dikenali: ' + JSON.stringify(data).substring(0, 200));
      }
  
      // Fungsi utama untuk mengambil data resi - VERSI DIPERBAIKI
      async function ambilDataResi() {
        console.log('üöÄ Memulai fungsi ambilDataResi...');
        
        const tanggal = document.getElementById('tanggalClosing').value;
        const shift = document.getElementById('shift').value;
        const karyawan = document.getElementById('karyawan').value;
        
        console.log('üìã Data input:', { tanggal, shift, karyawan, chatId });
        
        if (!tanggal || !karyawan) {
          console.error('‚ùå Validasi gagal: tanggal atau karyawan kosong');
          alert('Harap isi tanggal dan nama karyawan!');
          return;
        }
        
        // Tampilkan loading state
        setLoading('btnProses', true);
        document.getElementById('statusInfo').innerHTML = 
          '<div class="status-warning status-card">Mengambil data resi dari sistem...</div>';
        
        try {
          console.log('üì§ Mengirim request ke webhook...');
          
          const requestBody = {
            chat_id: chatId,
            tanggal: tanggal,
            shift: shift,
            karyawan: karyawan
          };
          
          console.log('üì¶ Request body:', requestBody);
          console.log('üîó URL webhook:', WEBHOOK_GET_DATA);
          
          // Tambahkan timeout untuk request
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 detik timeout
          
          const response = await fetch(WEBHOOK_GET_DATA, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          console.log('üì• Response received.');
          console.log('üìä Status:', response.status);
          console.log('‚úÖ OK:', response.ok);
          console.log('üî§ Status Text:', response.statusText);
          console.log('üìã Response headers:', Object.fromEntries(response.headers.entries()));
          
          if (!response.ok) {
            console.error('‚ùå HTTP Error:', response.status, response.statusText);
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
          }
          
          const rawResponse = await response.text();
          console.log('üìÑ Raw response:', rawResponse.substring(0, 500));
          
          let result;
          try {
            result = JSON.parse(rawResponse);
            console.log('‚úÖ Parsed JSON result:', result);
          } catch (parseError) {
            console.error('‚ùå JSON parse error:', parseError);
            throw new Error('Format response tidak valid - bukan JSON');
          }
          
          // üîç PROSES DATA DENGAN FUNGSI BARU YANG LEBIH ROBUST
          dataResi = processResiData(result);
          console.log('üíæ Data resi yang diproses:', dataResi);
          
          // üé® Validasi data minimal sebelum render
          if (!dataResi || typeof dataResi !== 'object') {
            throw new Error('Data resi tidak valid');
          }
          
          // Render data ke UI
          renderDataResi();
          
          // üîÑ Pindah ke step berikutnya
          console.log('üîÑ Pindah ke step 2...');
          document.getElementById('step1').classList.add('hidden');
          document.getElementById('step2').classList.remove('hidden');
          
          document.getElementById('statusInfo').innerHTML = 
            '<div class="status-success status-card">Data resi berhasil diambil!</div>';
          
          console.log('üéâ Proses selesai dengan sukses!');
          
        } catch (error) {
          // ‚ùå Handle error dengan lebih detail
          console.error('üí• Error terjadi:');
          console.error('üî§ Error name:', error.name);
          console.error('üí¨ Error message:', error.message);
          console.error('üìã Error stack:', error.stack);
          
          let errorMessage = error.message;
          if (error.name === 'AbortError') {
            errorMessage = 'Request timeout - server terlalu lama merespon';
          }
          
          document.getElementById('statusInfo').innerHTML = 
            `<div class="status-error status-card">Error: ${errorMessage}</div>`;
            
          alert(`Gagal mengambil data: ${errorMessage}`);
        } finally {
          setLoading('btnProses', false);
          console.log('üèÅ Fungsi ambilDataResi selesai dijalankan');
        }
      }
  
      // Fungsi untuk render data resi ke form - DIPERBAIKI dengan fallback
      function renderDataResi() {
        console.log('üé® Memulai renderDataResi...');
        console.log('üìä Data yang akan di-render:', dataResi);
        
        try {
          // Isi informasi header dengan fallback
          document.getElementById('outlet').value = dataResi.outlet || dataResi.nama_outlet || 'Masakluda';
          document.getElementById('tanggalTransaksi').value = dataResi.tanggal_transaksi || dataResi.tanggal || dataResi.tgl_transaksi || '-';
          document.getElementById('jumlahTamu').value = dataResi.jumlah_tamu || dataResi.jml_tamu || 0;
          document.getElementById('totalResi').value = dataResi.total_resi || dataResi.total_penjualan || dataResi.total || 0;
          
          console.log('üìù Informasi header diisi');
          
          // Render ringkasan penjualan dengan fallback values
          const totalPenjualan = dataResi.total_penjualan || dataResi.total_resi || dataResi.total || 0;
          const subtotal = dataResi.subtotal || totalPenjualan;
          const diskonBill = dataResi.diskon_bill || dataResi.diskon || 0;
          
          const ringkasanBody = document.getElementById('bodyTabelRingkasan');
          ringkasanBody.innerHTML = `
            <tr>
              <td>Total Penjualan</td>
              <td>${formatRupiah(totalPenjualan)}</td>
              <td><input type="number" id="aktualTotalPenjualan" value="${totalPenjualan}" onchange="updateRingkasan()" style="width: 100%; padding: 5px;"></td>
              <td id="selisihTotalPenjualan">${formatRupiah(0)}</td>
              <td id="statusTotalPenjualan" class="match">Match</td>
            </tr>
            <tr>
              <td>Subtotal</td>
              <td>${formatRupiah(subtotal)}</td>
              <td><input type="number" id="aktualSubtotal" value="${subtotal}" onchange="updateRingkasan()" style="width: 100%; padding: 5px;"></td>
              <td id="selisihSubtotal">${formatRupiah(0)}</td>
              <td id="statusSubtotal" class="match">Match</td>
            </tr>
            <tr>
              <td>Diskon Bill</td>
              <td>${formatRupiah(diskonBill)}</td>
              <td><input type="number" id="aktualDiskon" value="${diskonBill}" onchange="updateRingkasan()" style="width: 100%; padding: 5px;"></td>
              <td id="selisihDiskon">${formatRupiah(0)}</td>
              <td id="statusDiskon" class="match">Match</td>
            </tr>
          `;
          
          console.log('üìä Tabel ringkasan di-render');
          
          // Render detail pembayaran dengan handling yang lebih baik
          const pembayaranBody = document.getElementById('bodyTabelPembayaran');
          pembayaranBody.innerHTML = '';
          
          let metodePembayaran = dataResi.metode_pembayaran || dataResi.pembayaran || dataResi.payment_methods;
          
          if (metodePembayaran && Array.isArray(metodePembayaran) && metodePembayaran.length > 0) {
            console.log('üí≥ Metode pembayaran ditemukan:', metodePembayaran.length, 'item');
            metodePembayaran.forEach((metode, index) => {
              const nama = metode.nama || metode.name || metode.metode || `Metode ${index + 1}`;
              const penjualan = metode.penjualan || metode.sales || metode.amount || 0;
              
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${nama}</td>
                <td>${formatRupiah(penjualan)}</td>
                <td><input type="number" id="aktual-${index}" value="${penjualan}" onchange="updatePembayaran(${index})" style="width: 100%; padding: 5px;"></td>
                <td id="selisih-${index}">${formatRupiah(0)}</td>
                <td id="status-${index}" class="match">Match</td>
              `;
              pembayaranBody.appendChild(row);
            });
          } else {
            console.log('‚ö†Ô∏è Tidak ada metode pembayaran, menggunakan fallback');
            // Fallback jika tidak ada data metode pembayaran
            pembayaranBody.innerHTML = `
              <tr>
                <td>QR-MANDIRI</td>
                <td>${formatRupiah(totalPenjualan)}</td>
                <td><input type="number" id="aktual-0" value="${totalPenjualan}" onchange="updatePembayaran(0)" style="width: 100%; padding: 5px;"></td>
                <td id="selisih-0">${formatRupiah(0)}</td>
                <td id="status-0" class="match">Match</td>
              </tr>
            `;
          }
          
          console.log('‚úÖ Render data selesai');
        } catch (error) {
          console.error('‚ùå Error saat render data:', error);
          throw new Error('Gagal menampilkan data: ' + error.message);
        }
      }
  
      // Fungsi untuk update ringkasan
      function updateRingkasan() {
        console.log('üßÆ Update ringkasan dipanggil');
        
        const totalPenjualanAktual = parseInt(document.getElementById('aktualTotalPenjualan').value) || 0;
        const subtotalAktual = parseInt(document.getElementById('aktualSubtotal').value) || 0;
        const diskonAktual = parseInt(document.getElementById('aktualDiskon').value) || 0;
        
        console.log('üìä Nilai aktual:', { totalPenjualanAktual, subtotalAktual, diskonAktual });
        
        // Hitung selisih
        const totalPenjualanResi = dataResi.total_penjualan || dataResi.total_resi || 0;
        const subtotalResi = dataResi.subtotal || totalPenjualanResi;
        const diskonResi = dataResi.diskon_bill || dataResi.diskon || 0;
        
        const selisihTotal = totalPenjualanAktual - totalPenjualanResi;
        const selisihSubtotal = subtotalAktual - subtotalResi;
        const selisihDiskon = diskonAktual - diskonResi;
        
        console.log('üìà Selisih:', { selisihTotal, selisihSubtotal, selisihDiskon });
        
        // Update tampilan
        document.getElementById('selisihTotalPenjualan').textContent = formatRupiah(selisihTotal);
        document.getElementById('selisihSubtotal').textContent = formatRupiah(selisihSubtotal);
        document.getElementById('selisihDiskon').textContent = formatRupiah(selisihDiskon);
        
        // Update status
        document.getElementById('statusTotalPenjualan').textContent = getStatusText(selisihTotal);
        document.getElementById('statusTotalPenjualan').className = getStatusClass(selisihTotal);
        
        document.getElementById('statusSubtotal').textContent = getStatusText(selisihSubtotal);
        document.getElementById('statusSubtotal').className = getStatusClass(selisihSubtotal);
        
        document.getElementById('statusDiskon').textContent = getStatusText(selisihDiskon);
        document.getElementById('statusDiskon').className = getStatusClass(selisihDiskon);
        
        console.log('‚úÖ Update ringkasan selesai');
      }
  
      // Fungsi untuk update pembayaran
      function updatePembayaran(index) {
        console.log('üí≥ Update pembayaran untuk index:', index);
        
        const nilaiAktual = parseInt(document.getElementById(`aktual-${index}`).value) || 0;
        let nilaiResi = 0;
        
        const metodePembayaran = dataResi.metode_pembayaran || dataResi.pembayaran;
        
        if (metodePembayaran && Array.isArray(metodePembayaran) && metodePembayaran[index]) {
          nilaiResi = metodePembayaran[index].penjualan || metodePembayaran[index].sales || 0;
        } else {
          // Fallback jika tidak ada data metode pembayaran
          nilaiResi = dataResi.total_penjualan || dataResi.total_resi || 0;
        }
        
        const selisih = nilaiAktual - nilaiResi;
        
        console.log('üí∞ Pembayaran:', { index, nilaiAktual, nilaiResi, selisih });
        
        // Update tampilan
        document.getElementById(`selisih-${index}`).textContent = formatRupiah(selisih);
        document.getElementById(`status-${index}`).textContent = getStatusText(selisih);
        document.getElementById(`status-${index}`).className = getStatusClass(selisih);
        
        console.log('‚úÖ Update pembayaran selesai');
      }
  
      // Helper functions
      function getStatusText(selisih) {
        if (selisih === 0) return 'Match';
        if (Math.abs(selisih) <= 5000) return 'Perhatian';
        return 'Mismatch';
      }
  
      function getStatusClass(selisih) {
        if (selisih === 0) return 'match';
        if (Math.abs(selisih) <= 5000) return 'warning';
        return 'mismatch';
      }
  
      function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', {
          style: 'currency',
          currency: 'IDR',
          minimumFractionDigits: 0
        }).format(angka);
      }
  
      // Fungsi untuk kembali ke step 1
      function kembaliKeStep1() {
        console.log('‚Ü©Ô∏è Kembali ke step 1');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
      }
  
      // Fungsi untuk proses closing
      async function prosesClosing() {
        console.log('üöÄ Memulai prosesClosing...');
        
        const tanggal = document.getElementById('tanggalClosing').value;
        const shift = document.getElementById('shift').value;
        const karyawan = document.getElementById('karyawan').value;
        const keterangan = document.getElementById('keteranganUmum').value;
        
        console.log('üìã Data closing:', { tanggal, shift, karyawan, keterangan });
        
        // Validasi data
        const totalAktual = parseInt(document.getElementById('aktualTotalPenjualan').value) || 0;
        if (totalAktual === 0) {
          console.error('‚ùå Validasi gagal: total aktual = 0');
          alert('Harap isi semua nilai aktual sebelum melanjutkan!');
          return;
        }
        
        // Kumpulkan data aktual
        const ringkasanAktual = {
          total_penjualan: totalAktual,
          subtotal: parseInt(document.getElementById('aktualSubtotal').value) || 0,
          diskon_bill: parseInt(document.getElementById('aktualDiskon').value) || 0
        };
        
        const pembayaranAktual = [];
        const metodePembayaran = dataResi.metode_pembayaran || dataResi.pembayaran;
        const jumlahInput = metodePembayaran && Array.isArray(metodePembayaran) ? metodePembayaran.length : 1;
        
        console.log('üìä Mengumpulkan data pembayaran, jumlah input:', jumlahInput);
        
        for (let i = 0; i < jumlahInput; i++) {
          const input = document.getElementById(`aktual-${i}`);
          if (input) {
            let namaMetode = 'QR-MANDIRI';
            let nilaiResi = dataResi.total_penjualan || dataResi.total_resi || 0;
            
            if (metodePembayaran && metodePembayaran[i]) {
              namaMetode = metodePembayaran[i].nama || metodePembayaran[i].name || `Metode ${i+1}`;
              nilaiResi = metodePembayaran[i].penjualan || metodePembayaran[i].sales || nilaiResi;
            }
            
            pembayaranAktual.push({
              nama: namaMetode,
              penjualan_aktual: parseInt(input.value) || 0,
              penjualan_resi: nilaiResi
            });
          }
        }
        
        // Data yang akan dikirim ke n8n
        const dataKirim = {
          chat_id: chatId,
          tanggal: tanggal,
          shift: shift,
          karyawan: karyawan,
          data_resi: dataResi,
          ringkasan_aktual: ringkasanAktual,
          pembayaran_aktual: pembayaranAktual,
          keterangan: keterangan,
          timestamp: new Date().toISOString()
        };
        
        console.log('üì¶ Data yang akan dikirim ke webhook 2:', dataKirim);
        
        // Tampilkan loading
        setLoading('btnSubmit', true);
        
        try {
          // Kirim data ke webhook n8n
          const response = await fetch(WEBHOOK_SUBMIT_DATA, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(dataKirim)
          });
          
          console.log('üì• Response dari webhook 2:', response.status, response.ok);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('‚úÖ Response submit:', result);
          
          // Tampilkan hasil
          document.getElementById('step2').classList.add('hidden');
          document.getElementById('step3').classList.remove('hidden');
          
          // Render hasil closing
          renderHasilClosing(dataKirim);
          
          document.getElementById('summaryInfo').innerHTML = 
            '<div class="status-success status-card">Data closing berhasil dikirim!</div>';
            
          console.log('üéâ Proses closing selesai');
            
        } catch (error) {
          console.error('üí• Error saat submit:', error);
          alert(`Error: ${error.message}`);
        } finally {
          setLoading('btnSubmit', false);
          console.log('üèÅ Fungsi prosesClosing selesai');
        }
      }
  
      // Fungsi untuk render hasil closing
      function renderHasilClosing(data) {
        console.log('üé® Render hasil closing...');
        
        const totalPenjualanResi = dataResi.total_penjualan || dataResi.total_resi || 0;
        const totalSelisih = data.ringkasan_aktual.total_penjualan - totalPenjualanResi;
        
        const tbody = document.getElementById('bodyTabelHasil');
        tbody.innerHTML = `
          <tr><td>Outlet</td><td>${dataResi.outlet || dataResi.nama_outlet || 'Masakluda'}</td></tr>
          <tr><td>Tanggal Closing</td><td>${data.tanggal}</td></tr>
          <tr><td>Shift</td><td>${data.shift}</td></tr>
          <tr><td>Karyawan</td><td>${data.karyawan}</td></tr>
          <tr><td>Total Penjualan (Resi)</td><td>${formatRupiah(totalPenjualanResi)}</td></tr>
          <tr><td>Total Penjualan (Aktual)</td><td>${formatRupiah(data.ringkasan_aktual.total_penjualan)}</td></tr>
          <tr><td>Total Selisih</td><td>${formatRupiah(totalSelisih)}</td></tr>
          <tr><td>Keterangan</td><td>${data.keterangan || '-'}</td></tr>
          <tr><td>Waktu Submit</td><td>${new Date().toLocaleString('id-ID')}</td></tr>
        `;
        
        console.log('‚úÖ Hasil closing di-render');
      }
  
      // Fungsi tambahan
      function cetakLaporan() {
        console.log('üñ®Ô∏è Cetak laporan');
        window.print();
      }
  
      function simpanDanTutup() {
        console.log('üíæ Simpan dan tutup');
        alert('Terima kasih! Form closing telah selesai.');
      }
      
      console.log('‚úÖ Semua fungsi JavaScript berhasil di-load');
  </script>
</body>
</html>
