<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Closing Penjualan - Masakluda</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --danger-color: #ef4444;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --text-color: #333;
      --border-color: #ccc;
      --background-color: #f9fafb;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 15px;
      background: var(--background-color);
      color: var(--text-color);
      font-size: 16px;
      line-height: 1.5;
    }
    
    h2, h3 { 
      text-align: center; 
      margin-bottom: 20px; 
      color: var(--primary-color); 
      font-weight: 600; 
    }
    
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.3rem; }
    
    .card {
      max-width: 100%;
      width: 100%;
      margin: 0 auto 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .form-row { 
      display: flex; 
      gap: 15px; 
      margin-bottom: 15px; 
      flex-wrap: wrap; 
    }
    
    .form-group { 
      flex: 1; 
      min-width: 0;
    }
    
    label { 
      font-weight: 500; 
      display: block; 
      margin-bottom: 6px; 
    }
    
    select, input[type="text"], input[type="number"], input[type="date"] {
      width: 100%; 
      padding: 12px 10px; 
      border: 1px solid var(--border-color);
      border-radius: 6px; 
      outline: none; 
      font-family: 'Poppins', sans-serif; 
      font-size: 16px;
    }
    
    select:focus, input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    
    button {
      padding: 12px 16px; 
      border-radius: 6px; 
      border: none; 
      cursor: pointer;
      font-weight: 500; 
      transition: all 0.2s; 
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .primary-btn { 
      background: var(--primary-color); 
      color: white; 
    }
    
    .success-btn { 
      background: var(--success-color); 
      color: white; 
    }
    
    .danger-btn { 
      background: var(--danger-color); 
      color: white; 
    }
    
    .warning-btn { 
      background: var(--warning-color); 
      color: white; 
    }
    
    .table-wrapper { 
      width: 100%; 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    table {
      width: 100%; 
      border-collapse: collapse; 
      margin: 0;
      font-size: 14px; 
    }
    
    th, td { 
      border: 1px solid #e5e7eb; 
      padding: 10px 8px; 
      text-align: center; 
      word-break: break-word;
    }
    
    th { 
      background-color: #f3f4f6; 
      font-weight: 500; 
      white-space: nowrap;
    }
    
    .match { background-color: #d1fae5; }
    .mismatch { background-color: #fee2e2; }
    .warning { background-color: #fef3c7; }
    
    .status-card {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 500;
    }
    
    .status-success {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .status-warning {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .status-error {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    .hidden {
      display: none;
    }
    
    .summary-card {
      background-color: #f0f9ff;
      border-left: 4px solid var(--primary-color);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      body { 
        padding: 10px; 
        font-size: 15px; 
      }
      
      .card { 
        padding: 15px; 
      }
      
      .form-row { 
        flex-direction: column; 
        gap: 15px; 
      }
      
      .form-group { 
        width: 100%; 
      }
      
      table { 
        font-size: 14px; 
        min-width: 600px;
      }
      
      th, td {
        padding: 8px 6px;
      }
      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255,255,255,.3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 1s ease-in-out infinite;
          margin-right: 10px;
      }
      
      @keyframes spin {
          to { transform: rotate(360deg); }
      }
      
      .hidden {
          display: none;
      }
    }
  </style>
</head>
<body>

  <h2>Form Closing Penjualan - Masakluda</h2>
  
  <!-- Step 1: Input Data Dasar -->
  <div class="card" id="step1">
    <h3>Data Closing Penjualan</h3>
    
    <div class="form-row">
      <div class="form-group">
        <label for="tanggalClosing">Tanggal Closing:</label>
        <input type="date" id="tanggalClosing" name="tanggalClosing">
      </div>
      <div class="form-group">
        <label for="shift">Shift:</label>
        <select id="shift" name="shift">
          <option value="pagi">Pagi</option>
          <option value="siang">Siang</option>
          <option value="malam">Malam</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label for="karyawan">Nama Karyawan:</label>
      <input type="text" id="karyawan" name="karyawan" placeholder="Nama karyawan yang bertugas">
    </div>
    
    <button class="primary-btn" onclick="ambilDataResi()" style="width: 100%;" id="btnProses">
      <span id="btnText">Proses Resi dan Ambil Data</span>
      <span id="btnLoading" class="hidden loading"></span>
    </button>
  </div>

  <!-- Step 2: Data dari Resi dan Input Aktual -->
  <div class="card hidden" id="step2">
    <h3>Data dari Resi vs Aktual Kas</h3>
    
    <div id="statusInfo"></div>
    
    <!-- Informasi Header dari Resi -->
    <div class="card summary-card">
      <h4>Informasi Resi</h4>
      <div class="form-row">
        <div class="form-group">
          <label>Outlet:</label>
          <input type="text" id="outlet" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>Tanggal Transaksi:</label>
          <input type="text" id="tanggalTransaksi" readonly style="background: #f5f5f5;">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Jumlah Tamu:</label>
          <input type="text" id="jumlahTamu" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>Total Resi:</label>
          <input type="text" id="totalResi" readonly style="background: #f5f5f5;">
        </div>
      </div>
    </div>
    
    <!-- Ringkasan Penjualan -->
    <div class="table-wrapper">
      <table id="tabelRingkasan">
        <thead>
          <tr>
            <th>Item</th>
            <th>Nilai dari Resi (Rp)</th>
            <th>Nilai Aktual (Rp)</th>
            <th>Selisih (Rp)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="bodyTabelRingkasan">
          <!-- Data akan diisi oleh JavaScript -->
        </tbody>
      </table>
    </div>
    
    <!-- Detail Pembayaran -->
    <h4>Detail Pembayaran</h4>
    <div class="table-wrapper">
      <table id="tabelPembayaran">
        <thead>
          <tr>
            <th>Metode Pembayaran</th>
            <th>Penjualan (Resi)</th>
            <th>Penjualan (Aktual)</th>
            <th>Selisih</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="bodyTabelPembayaran">
          <!-- Data akan diisi oleh JavaScript -->
        </tbody>
      </table>
    </div>
    
    <div class="form-group">
      <label for="keteranganUmum">Keterangan Umum:</label>
      <textarea id="keteranganUmum" name="keteranganUmum" placeholder="Tambahkan catatan mengenai closing penjualan..." style="width: 100%; padding: 12px 10px; border-radius: 6px; border: 1px solid #ccc; min-height: 100px; font-family: 'Poppins', sans-serif;"></textarea>
    </div>
    
    <div class="form-row">
      <button class="danger-btn" onclick="kembaliKeStep1()" style="flex: 1;">Kembali</button>
      <button class="success-btn" onclick="prosesClosing()" style="flex: 2;" id="btnSubmit">
        <span id="submitText">Submit Closing</span>
        <span id="submitLoading" class="hidden loading"></span>
      </button>
    </div>
  </div>

      <!-- Step 3: Hasil Closing -->
      <div class="card hidden summary-card" id="step3">
          <h3>Hasil Closing Penjualan</h3>
          
          <div id="summaryInfo"></div>
          
          <div class="table-wrapper">
              <table id="tabelHasil">
                  <thead>
                      <tr>
                          <th>Item</th>
                          <th>Nilai</th>
                      </tr>
                  </thead>
                  <tbody id="bodyTabelHasil">
                      <!-- Data akan diisi oleh JavaScript -->
                  </tbody>
              </table>
          </div>
          
          <div class="form-row">
              <button class="primary-btn" onclick="kirimEmailLaporan()" style="flex: 1;" id="btnKirimEmail">
                  <span id="btnKirimText">Kirim PDF via Email</span>
                  <span id="btnKirimLoading" class="hidden loading"></span>
              </button>
              <button class="success-btn" onclick="simpanDanTutup()" style="flex: 1;">Selesai</button>
          </div>
      </div>

  <script>
      console.log('üìÑ Script JavaScript mulai loading...');
      
      // Webhook URLs
      const WEBHOOK_GET_DATA = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/get-resi-data';
      const WEBHOOK_SUBMIT_DATA = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/5aef7833-d0fb-4c04-8aec-d99784165f15';
      const WEBHOOK_SEND_EMAIL = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/send-email-pdf';
  
      // Variabel global
      let dataResi = {};
      let chatId = '';
  
      // Fungsi untuk mengambil parameter dari URL
      function getUrlParams() {
        console.log('üîó Mengambil parameter dari URL...');
        const params = new URLSearchParams(window.location.search);
        const result = {
          chatId: params.get('chat_id'),
          tanggal: params.get('tanggal'),
          shift: params.get('shift')
        };
        console.log('üìã Parameter URL:', result);
        return result;
      }
  
      // Inisialisasi saat halaman dimuat
      document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM fully loaded and parsed');
        
        const params = getUrlParams();
        
        // Ambil chat_id dari URL parameter (otomatis dari Telegram)
        if (params.chatId) {
          chatId = params.chatId;
          console.log('üí¨ Chat ID dari URL:', chatId);
        } else {
          console.warn('‚ö†Ô∏è Chat ID tidak ditemukan di URL');
        }
        
        // Set nilai form dari URL parameters jika ada
        if (params.tanggal) {
          document.getElementById('tanggalClosing').value = params.tanggal;
          console.log('üìÖ Tanggal dari URL:', params.tanggal);
        }
        
        if (params.shift) {
          document.getElementById('shift').value = params.shift;
          console.log('üïí Shift dari URL:', params.shift);
        }
        
        // Set tanggal default ke hari ini jika tidak ada parameter
        if (!params.tanggal) {
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          document.getElementById('tanggalClosing').value = todayStr;
          console.log('üìÖ Tanggal default di-set ke:', todayStr);
        }
        
        console.log('üéâ Form siap digunakan');
      });
  
      // Fungsi untuk menampilkan/menyembunyikan loading
      function setLoading(buttonId, isLoading) {
        console.log('üîÑ Set loading:', buttonId, isLoading);
        const btn = document.getElementById(buttonId);
        const text = document.getElementById(buttonId === 'btnProses' ? 'btnText' : 'submitText');
        const loading = document.getElementById(buttonId === 'btnProses' ? 'btnLoading' : 'submitLoading');
        
        if (isLoading) {
          btn.disabled = true;
          text.classList.add('hidden');
          loading.classList.remove('hidden');
          console.log('‚è≥ Loading ditampilkan untuk', buttonId);
        } else {
          btn.disabled = false;
          text.classList.remove('hidden');
          loading.classList.add('hidden');
          console.log('‚úÖ Loading disembunyikan untuk', buttonId);
        }
      }
  
      // Helper function untuk variasi penulisan metode pembayaran
      function getPaymentVariations(kode) {
          const variations = {
              'cash': ['tunai', 'cash', 'kas', 'kas_total'],
              'mandiri': ['mandiri', 'bank_mandiri', 'bank mandiri', 'transfer_mandiri'],
              'qrMandiri': ['qrmandiri', 'qr_mandiri', 'qris_mandiri', 'qris mandiri'],
              'grabfood': ['grab', 'grabfood', 'grab_food', 'grab food'],
              'gofood': ['gojek', 'gofood', 'go_food', 'go food'],
              'shopeefood': ['shopee', 'shopeefood', 'shopee_food', 'shopee food']
          };
          
          return variations[kode] || [kode];
      }
  
      // Fungsi untuk konversi metode_pembayaran object ke array dengan template tetap
      function convertPaymentMethods(paymentObject) {
          console.log('üí≥ Konversi metode pembayaran:', paymentObject);
          
          // Template metode pembayaran tetap
          const templatePayments = [
              { kode: 'cash', nama: 'Cash' },
              { kode: 'mandiri', nama: 'Mandiri' },
              { kode: 'qrMandiri', nama: 'QR Mandiri' },
              { kode: 'grabfood', nama: 'GrabFood' },
              { kode: 'gofood', nama: 'GoFood' },
              { kode: 'shopeefood', nama: 'ShopeeFood' }
          ];
          
          const paymentArray = templatePayments.map(template => {
              // Cari nilai dari response API
              let nilai = 0;
              
              // Cek berbagai variasi penulisan key
              if (paymentObject && typeof paymentObject === 'object') {
                  // Exact match
                  if (paymentObject[template.kode] !== undefined) {
                      nilai = paymentObject[template.kode];
                  }
                  // Case insensitive match
                  else {
                      const lowerKey = template.kode.toLowerCase();
                      for (const [key, value] of Object.entries(paymentObject)) {
                          if (key.toLowerCase() === lowerKey) {
                              nilai = value;
                              break;
                          }
                      }
                  }
                  
                  // Fallback untuk variasi penulisan
                  if (nilai === 0) {
                      const variations = getPaymentVariations(template.kode);
                      for (const variation of variations) {
                          if (paymentObject[variation] !== undefined) {
                              nilai = paymentObject[variation];
                              break;
                          }
                      }
                  }
              }
              
              return {
                  kode: template.kode,
                  nama: template.nama,
                  penjualan: nilai || 0
              };
          });
          
          console.log('‚úÖ Metode pembayaran dikonversi:', paymentArray);
          return paymentArray;
      }
  
      // Fungsi untuk memproses data resi - DIPERBAIKI untuk format array
      function processResiData(data) {
        console.log('üîß Processing data:', data);
        
        // ‚úÖ PERBAIKAN: Handle array response [{}] dan extract data dari property 'data'
        if (Array.isArray(data) && data.length > 0) {
          console.log('üì¶ Data adalah array, mengambil elemen pertama');
          const firstItem = data[0];
          
          // ‚úÖ EKSTRAK DATA DARI PROPERTY 'data'
          if (firstItem.success && firstItem.data) {
            console.log('‚úÖ Format response benar: {success: true, data: {...}} - extracting data');
            return firstItem.data;
          } else if (firstItem.outlet || firstItem.total_penjualan) {
            console.log('‚ö†Ô∏è Data langsung di array, tanpa wrapper');
            return firstItem;
          } else {
            throw new Error('Format array tidak dikenali');
          }
        }
        
        // ‚úÖ Handle object langsung {success, data}
        if (typeof data === 'object' && data !== null) {
          if (data.success && data.data) {
            console.log('‚úÖ Format response: {success: true, data: {...}} - extracting data');
            return data.data;
          }
          
          // ‚úÖ Handle data langsung tanpa wrapper
          if (data.outlet || data.total_penjualan) {
            console.log('‚úÖ Data langsung berisi informasi resi');
            return data;
          }
          
          // ‚ùå Error handling
          if (data.error || data.message) {
            throw new Error(data.message || data.error || 'Terjadi kesalahan pada server');
          }
        }
        
        throw new Error('Format data tidak dikenali: ' + JSON.stringify(data).substring(0, 200));
      }
  
      // Fungsi utama untuk mengambil data resi - VERSI FINAL
      async function ambilDataResi() {
        console.log('üöÄ Memulai fungsi ambilDataResi...');
        
        const tanggal = document.getElementById('tanggalClosing').value;
        const shift = document.getElementById('shift').value;
        const karyawan = document.getElementById('karyawan').value;
        
        console.log('üìã Data input:', { tanggal, shift, karyawan, chatId });
        
        if (!tanggal || !karyawan) {
          console.error('‚ùå Validasi gagal: tanggal atau karyawan kosong');
          alert('Harap isi tanggal dan nama karyawan!');
          return;
        }
        
        // Tampilkan loading state
        setLoading('btnProses', true);
        document.getElementById('statusInfo').innerHTML = 
          '<div class="status-warning status-card">Mengambil data resi dari sistem...</div>';
        
        try {
          console.log('üì§ Mengirim request ke webhook...');
          
          const requestBody = {
            chat_id: chatId,
            tanggal: tanggal,
            shift: shift,
            karyawan: karyawan
          };
          
          console.log('üì¶ Request body:', requestBody);
          console.log('üîó URL webhook:', WEBHOOK_GET_DATA);
          
          const response = await fetch(WEBHOOK_GET_DATA, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
          
          console.log('üì• Response received.');
          console.log('üìä Status:', response.status);
          console.log('‚úÖ OK:', response.ok);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('‚úÖ Response data dari n8n:', result);
          
          // üîç PROSES DATA DENGAN FUNGSI YANG SUDAH DIPERBAIKI
          dataResi = processResiData(result);
          console.log('üíæ Data resi yang diproses:', dataResi);
          
          // ‚úÖ KONVERSI METODE PEMBAYARAN DARI OBJECT KE ARRAY DENGAN TEMPLATE
          if (dataResi.metode_pembayaran && typeof dataResi.metode_pembayaran === 'object') {
            dataResi.metode_pembayaran = convertPaymentMethods(dataResi.metode_pembayaran);
          } else if (!dataResi.metode_pembayaran) {
            // Jika tidak ada data metode_pembayaran, buat template kosong
            dataResi.metode_pembayaran = convertPaymentMethods({});
          }
          
          // üé® Render data ke UI
          renderDataResi();
          
          // üîÑ Pindah ke step berikutnya
          console.log('üîÑ Pindah ke step 2...');
          document.getElementById('step1').classList.add('hidden');
          document.getElementById('step2').classList.remove('hidden');
          
          document.getElementById('statusInfo').innerHTML = 
            '<div class="status-success status-card">Data resi berhasil diambil!</div>';
          
          console.log('üéâ Proses selesai dengan sukses!');
          
        } catch (error) {
          // ‚ùå Handle error
          console.error('üí• Error terjadi:');
          console.error('üî§ Error name:', error.name);
          console.error('üí¨ Error message:', error.message);
          
          document.getElementById('statusInfo').innerHTML = 
            `<div class="status-error status-card">Error: ${error.message}</div>`;
            
          alert(`Gagal mengambil data: ${error.message}`);
        } finally {
          setLoading('btnProses', false);
          console.log('üèÅ Fungsi ambilDataResi selesai dijalankan');
        }
      }
  
      // Fungsi untuk render data resi ke form - DIPERBAIKI dengan template tetap
      function renderDataResi() {
          console.log('üé® Memulai renderDataResi...');
          console.log('üìä Data yang akan di-render:', dataResi);
          
          try {
              // Isi informasi header
              document.getElementById('outlet').value = dataResi.outlet || 'Masakluda';
              document.getElementById('tanggalTransaksi').value = dataResi.tanggal_transaksi || '-';
              document.getElementById('jumlahTamu').value = dataResi.jumlah_tamu || 0;
              document.getElementById('totalResi').value = dataResi.total_resi || 0;
              
              console.log('üìù Informasi header diisi');
              
              // Render ringkasan penjualan
              const ringkasanBody = document.getElementById('bodyTabelRingkasan');
              ringkasanBody.innerHTML = `
                  <tr>
                      <td>Total Penjualan</td>
                      <td>${formatRupiah(dataResi.total_penjualan || 0)}</td>
                      <td><input type="number" id="aktualTotalPenjualan" value="${dataResi.total_penjualan || 0}" onchange="updateRingkasan()" style="width: 100%; padding: 5px;"></td>
                      <td id="selisihTotalPenjualan">${formatRupiah(0)}</td>
                      <td id="statusTotalPenjualan" class="match">Match</td>
                  </tr>
                  <tr>
                      <td>Subtotal</td>
                      <td>${formatRupiah(dataResi.subtotal || 0)}</td>
                      <td><input type="number" id="aktualSubtotal" value="${dataResi.subtotal || 0}" onchange="updateRingkasan()" style="width: 100%; padding: 5px;"></td>
                      <td id="selisihSubtotal">${formatRupiah(0)}</td>
                      <td id="statusSubtotal" class="match">Match</td>
                  </tr>
                  <tr>
                      <td>Diskon Bill</td>
                      <td>${formatRupiah(dataResi.diskon_bill || 0)}</td>
                      <td><input type="number" id="aktualDiskon" value="${dataResi.diskon_bill || 0}" onchange="updateRingkasan()" style="width: 100%; padding: 5px;"></td>
                      <td id="selisihDiskon">${formatRupiah(0)}</td>
                      <td id="statusDiskon" class="match">Match</td>
                  </tr>
              `;
              
              console.log('üìä Tabel ringkasan di-render');
              
              // Render detail pembayaran dengan template tetap
              const pembayaranBody = document.getElementById('bodyTabelPembayaran');
              pembayaranBody.innerHTML = '';
              
              // Pastikan metode_pembayaran sudah dikonversi ke array dengan template
              if (!dataResi.metode_pembayaran || !Array.isArray(dataResi.metode_pembayaran)) {
                  dataResi.metode_pembayaran = convertPaymentMethods(dataResi.metode_pembayaran || {});
              }
              
              console.log('üí≥ Metode pembayaran untuk render:', dataResi.metode_pembayaran);
              
              // Render semua metode pembayaran dari template
              dataResi.metode_pembayaran.forEach((metode, index) => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                      <td>${metode.nama}</td>
                      <td>${formatRupiah(metode.penjualan || 0)}</td>
                      <td><input type="number" id="aktual-${index}" value="${metode.penjualan || 0}" onchange="updatePembayaran(${index})" style="width: 100%; padding: 5px;"></td>
                      <td id="selisih-${index}">${formatRupiah(0)}</td>
                      <td id="status-${index}" class="match">Match</td>
                  `;
                  pembayaranBody.appendChild(row);
              });
              
              console.log('‚úÖ Render data selesai');
              
          } catch (error) {
              console.error('‚ùå Error saat render data:', error);
              throw new Error('Gagal menampilkan data: ' + error.message);
          }
      }
  
      // Fungsi untuk update ringkasan
      function updateRingkasan() {
        console.log('üßÆ Update ringkasan dipanggil');
        
        const totalPenjualanAktual = parseInt(document.getElementById('aktualTotalPenjualan').value) || 0;
        const subtotalAktual = parseInt(document.getElementById('aktualSubtotal').value) || 0;
        const diskonAktual = parseInt(document.getElementById('aktualDiskon').value) || 0;
        
        console.log('üìä Nilai aktual:', { totalPenjualanAktual, subtotalAktual, diskonAktual });
        
        // Hitung selisih
        const selisihTotal = totalPenjualanAktual - (dataResi.total_penjualan || 0);
        const selisihSubtotal = subtotalAktual - (dataResi.subtotal || 0);
        const selisihDiskon = diskonAktual - (dataResi.diskon_bill || 0);
        
        console.log('üìà Selisih:', { selisihTotal, selisihSubtotal, selisihDiskon });
        
        // Update tampilan
        document.getElementById('selisihTotalPenjualan').textContent = formatRupiah(selisihTotal);
        document.getElementById('selisihSubtotal').textContent = formatRupiah(selisihSubtotal);
        document.getElementById('selisihDiskon').textContent = formatRupiah(selisihDiskon);
        
        // Update status
        document.getElementById('statusTotalPenjualan').textContent = getStatusText(selisihTotal);
        document.getElementById('statusTotalPenjualan').className = getStatusClass(selisihTotal);
        
        document.getElementById('statusSubtotal').textContent = getStatusText(selisihSubtotal);
        document.getElementById('statusSubtotal').className = getStatusClass(selisihSubtotal);
        
        document.getElementById('statusDiskon').textContent = getStatusText(selisihDiskon);
        document.getElementById('statusDiskon').className = getStatusClass(selisihDiskon);
        
        console.log('‚úÖ Update ringkasan selesai');
      }
  
      // Fungsi untuk update pembayaran - DIPERBAIKI untuk template
      function updatePembayaran(index) {
          console.log('üí≥ Update pembayaran untuk index:', index);
          
          const nilaiAktual = parseInt(document.getElementById(`aktual-${index}`).value) || 0;
          let nilaiResi = 0;
          
          if (dataResi.metode_pembayaran && dataResi.metode_pembayaran[index]) {
              nilaiResi = dataResi.metode_pembayaran[index].penjualan || 0;
          }
          
          const selisih = nilaiAktual - nilaiResi;
          
          console.log('üí∞ Pembayaran:', { 
              index, 
              metode: dataResi.metode_pembayaran[index]?.nama, 
              nilaiAktual, 
              nilaiResi, 
              selisih 
          });
          
          // Update tampilan
          document.getElementById(`selisih-${index}`).textContent = formatRupiah(selisih);
          document.getElementById(`status-${index}`).textContent = getStatusText(selisih);
          document.getElementById(`status-${index}`).className = getStatusClass(selisih);
          
          console.log('‚úÖ Update pembayaran selesai');
      }
  
      // Helper functions
      function getStatusText(selisih) {
        if (selisih === 0) return 'Match';
        if (Math.abs(selisih) <= 5000) return 'Perhatian';
        return 'Mismatch';
      }
  
      function getStatusClass(selisih) {
        if (selisih === 0) return 'match';
        if (Math.abs(selisih) <= 5000) return 'warning';
        return 'mismatch';
      }
  
      function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', {
          style: 'currency',
          currency: 'IDR',
          minimumFractionDigits: 0
        }).format(angka);
      }
  
      // Fungsi untuk kembali ke step 1
      function kembaliKeStep1() {
        console.log('‚Ü©Ô∏è Kembali ke step 1');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
      }
  
      // Helper function untuk mendapatkan data pembayaran aktual
      function getPembayaranAktual() {
          const pembayaranAktual = [];
          
          if (dataResi.metode_pembayaran && dataResi.metode_pembayaran.length > 0) {
              dataResi.metode_pembayaran.forEach((metode, index) => {
                  const input = document.getElementById(`aktual-${index}`);
                  if (input) {
                      pembayaranAktual.push({
                          kode: metode.kode,
                          nama: metode.nama,
                          penjualan_aktual: parseInt(input.value) || 0,
                          penjualan_resi: metode.penjualan || 0
                      });
                  }
              });
          }
          
          return pembayaranAktual;
      }
    // Fungsi untuk generate kesimpulan matching
          function generateKesimpulan() {
              console.log('üìä Generate kesimpulan matching...');
              
              const kesimpulan = {
                  totalMatch: true,
                  detailMatch: {},
                  totalSelisih: 0,
                  rekomendasi: []
              };
          
              // 1. Check Total Penjualan
              const totalAktual = parseInt(document.getElementById('aktualTotalPenjualan').value) || 0;
              const totalResi = dataResi.total_penjualan || 0;
              const selisihTotal = totalAktual - totalResi;
              
              kesimpulan.detailMatch.total_penjualan = {
                  match: selisihTotal === 0,
                  selisih: selisihTotal,
                  status: getStatusText(selisihTotal)
              };
              
              if (selisihTotal !== 0) {
                  kesimpulan.totalMatch = false;
                  kesimpulan.totalSelisih += Math.abs(selisihTotal);
              }
          
              // 2. Check Subtotal
              const subtotalAktual = parseInt(document.getElementById('aktualSubtotal').value) || 0;
              const subtotalResi = dataResi.subtotal || 0;
              const selisihSubtotal = subtotalAktual - subtotalResi;
              
              kesimpulan.detailMatch.subtotal = {
                  match: selisihSubtotal === 0,
                  selisih: selisihSubtotal,
                  status: getStatusText(selisihSubtotal)
              };
              
              if (selisihSubtotal !== 0) {
                  kesimpulan.totalMatch = false;
                  kesimpulan.totalSelisih += Math.abs(selisihSubtotal);
              }
          
              // 3. Check Diskon
              const diskonAktual = parseInt(document.getElementById('aktualDiskon').value) || 0;
              const diskonResi = dataResi.diskon_bill || 0;
              const selisihDiskon = diskonAktual - diskonResi;
              
              kesimpulan.detailMatch.diskon_bill = {
                  match: selisihDiskon === 0,
                  selisih: selisihDiskon,
                  status: getStatusText(selisihDiskon)
              };
              
              if (selisihDiskon !== 0) {
                  kesimpulan.totalMatch = false;
                  kesimpulan.totalSelisih += Math.abs(selisihDiskon);
              }
          
              // 4. Check Metode Pembayaran
              kesimpulan.detailMatch.metode_pembayaran = [];
              let semuaPembayaranMatch = true;
              let totalSelisihPembayaran = 0;
          
              if (dataResi.metode_pembayaran && dataResi.metode_pembayaran.length > 0) {
                  dataResi.metode_pembayaran.forEach((metode, index) => {
                      const input = document.getElementById(`aktual-${index}`);
                      if (input) {
                          const nilaiAktual = parseInt(input.value) || 0;
                          const nilaiResi = metode.penjualan || 0;
                          const selisih = nilaiAktual - nilaiResi;
                          
                          const matchPembayaran = {
                              metode: metode.nama,
                              match: selisih === 0,
                              selisih: selisih,
                              status: getStatusText(selisih)
                          };
                          
                          kesimpulan.detailMatch.metode_pembayaran.push(matchPembayaran);
                          
                          if (selisih !== 0) {
                              semuaPembayaranMatch = false;
                              totalSelisihPembayaran += Math.abs(selisih);
                          }
                      }
                  });
              }
              
              kesimpulan.totalMatch = kesimpulan.totalMatch && semuaPembayaranMatch;
              kesimpulan.totalSelisih += totalSelisihPembayaran;
          
              // 5. Generate Rekomendasi
              if (kesimpulan.totalMatch) {
                  kesimpulan.rekomendasi.push("‚úÖ Semua data matching sempurna");
                  kesimpulan.rekomendasi.push("‚úÖ Tidak perlu tindakan lebih lanjut");
              } else {
                  if (Math.abs(selisihTotal) > 0) {
                      kesimpulan.rekomendasi.push(`‚ö†Ô∏è Periksa total penjualan (selisih: ${formatRupiah(selisihTotal)})`);
                  }
                  if (Math.abs(selisihSubtotal) > 0) {
                      kesimpulan.rekomendasi.push(`‚ö†Ô∏è Periksa subtotal (selisih: ${formatRupiah(selisihSubtotal)})`);
                  }
                  if (Math.abs(selisihDiskon) > 0) {
                      kesimpulan.rekomendasi.push(`‚ö†Ô∏è Periksa diskon bill (selisih: ${formatRupiah(selisihDiskon)})`);
                  }
                  
                  kesimpulan.detailMatch.metode_pembayaran.forEach(pembayaran => {
                      if (!pembayaran.match) {
                          kesimpulan.rekomendasi.push(`‚ö†Ô∏è Periksa ${pembayaran.metode} (selisih: ${formatRupiah(pembayaran.selisih)})`);
                      }
                  });
                  
                  if (kesimpulan.totalSelisih > 100000) {
                      kesimpulan.rekomendasi.push("üö® Selisih signifikan, perlu investigasi mendalam");
                  } else if (kesimpulan.totalSelisih > 50000) {
                      kesimpulan.rekomendasi.push("‚ö†Ô∏è Selisih cukup besar, perlu pengecekan ulang");
                  } else {
                      kesimpulan.rekomendasi.push("üí° Selisih kecil, mungkin karena pembulatan");
                  }
              }
          
              // 6. Status Overall
              kesimpulan.statusOverall = kesimpulan.totalMatch ? "MATCH SEMPURNA" : 
                                        kesimpulan.totalSelisih <= 5000 ? "HAMPIR MATCH" : 
                                        "PERLU PERBAIKAN";
          
              console.log('‚úÖ Kesimpulan generated:', kesimpulan);
              return kesimpulan;
          }
          
          // Fungsi untuk mendapatkan teks kesimpulan yang lebih readable
          function getKesimpulanText(kesimpulan) {
              let text = `STATUS: ${kesimpulan.statusOverall}\n\n`;
              
              if (kesimpulan.totalMatch) {
                  text += "üéâ SELAMAT! Semua data matching sempurna antara sistem dan kas aktual.\n\n";
              } else {
                  text += `üìä TOTAL SELISIH: ${formatRupiah(kesimpulan.totalSelisih)}\n\n`;
                  text += "üîç DETAIL KETIDAKSESUAIAN:\n";
                  
                  Object.keys(kesimpulan.detailMatch).forEach(key => {
                      if (key !== 'metode_pembayaran') {
                          const detail = kesimpulan.detailMatch[key];
                          if (!detail.match) {
                              text += `‚Ä¢ ${key.replace('_', ' ').toUpperCase()}: ${formatRupiah(detail.selisih)} (${detail.status})\n`;
                          }
                      }
                  });
                  
                  if (kesimpulan.detailMatch.metode_pembayaran) {
                      kesimpulan.detailMatch.metode_pembayaran.forEach(pembayaran => {
                          if (!pembayaran.match) {
                              text += `‚Ä¢ ${pembayaran.metode.toUpperCase()}: ${formatRupiah(pembayaran.selisih)} (${pembayaran.status})\n`;
                          }
                      });
                  }
                  
                  text += "\nüí° REKOMENDASI:\n";
                  kesimpulan.rekomendasi.forEach(rec => {
                      text += `‚Ä¢ ${rec}\n`;
                  });
              }
              
              return text;
          }
  
      // Fungsi untuk proses closing
// Dalam fungsi prosesClosing(), tambahkan kesimpulan ke data yang dikirim
      async function prosesClosing() {
          console.log('üöÄ Memulai prosesClosing...');
          
          const tanggal = document.getElementById('tanggalClosing').value;
          const shift = document.getElementById('shift').value;
          const karyawan = document.getElementById('karyawan').value;
          const keterangan = document.getElementById('keteranganUmum').value;
          
          console.log('üìã Data closing:', { tanggal, shift, karyawan, keterangan });
          
          // Validasi data
          const totalAktual = parseInt(document.getElementById('aktualTotalPenjualan').value) || 0;
          if (totalAktual === 0) {
              console.error('‚ùå Validasi gagal: total aktual = 0');
              alert('Harap isi semua nilai aktual sebelum melanjutkan!');
              return;
          }
          
          // Generate kesimpulan matching
          const kesimpulan = generateKesimpulan();
          
          // Kumpulkan data aktual
          const ringkasanAktual = {
              total_penjualan: totalAktual,
              subtotal: parseInt(document.getElementById('aktualSubtotal').value) || 0,
              diskon_bill: parseInt(document.getElementById('aktualDiskon').value) || 0
          };
          
          // Kumpulkan data pembayaran aktual menggunakan helper function
          const pembayaranAktual = getPembayaranAktual();
          console.log('üìä Data pembayaran aktual:', pembayaranAktual);
          
          // Data yang akan dikirim ke n8n - DITAMBAH KESIMPULAN
          const dataKirim = {
              chat_id: chatId,
              tanggal: tanggal,
              shift: shift,
              karyawan: karyawan,
              data_resi: dataResi,
              ringkasan_aktual: ringkasanAktual,
              pembayaran_aktual: pembayaranAktual,
              keterangan: keterangan,
              kesimpulan: kesimpulan, // ‚¨ÖÔ∏è INI YANG BARU
              kesimpulan_text: getKesimpulanText(kesimpulan), // ‚¨ÖÔ∏è TEKS READABLE
              timestamp: new Date().toISOString()
          };
          
          console.log('üì¶ Data yang akan dikirim ke webhook 2:', dataKirim);
          
          // Tampilkan loading
          setLoading('btnSubmit', true);
          
          try {
              // Kirim data ke webhook n8n
              const response = await fetch(WEBHOOK_SUBMIT_DATA, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(dataKirim)
              });
              
              console.log('üì• Response dari webhook 2:', response.status, response.ok);
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const result = await response.json();
              console.log('‚úÖ Response submit:', result);
              
              // Tampilkan hasil
              document.getElementById('step2').classList.add('hidden');
              document.getElementById('step3').classList.remove('hidden');
              
              // Render hasil closing - TAMBAH KESIMPULAN
              renderHasilClosing(dataKirim, kesimpulan);
              
              document.getElementById('summaryInfo').innerHTML = 
                  '<div class="status-success status-card">Data closing berhasil dikirim!</div>';
                  
              console.log('üéâ Proses closing selesai');
                  
          } catch (error) {
              console.error('üí• Error saat submit:', error);
              alert(`Error: ${error.message}`);
          } finally {
              setLoading('btnSubmit', false);
              console.log('üèÅ Fungsi prosesClosing selesai');
          }
      }
  
      // Fungsi untuk render hasil closing
     // Update fungsi renderHasilClosing()
      function renderHasilClosing(data, kesimpulan) {
          console.log('üé® Render hasil closing...');
          
          const totalSelisih = data.ringkasan_aktual.total_penjualan - (dataResi.total_penjualan || 0);
          
          const tbody = document.getElementById('bodyTabelHasil');
          tbody.innerHTML = `
              <tr><td>Outlet</td><td>${dataResi.outlet || 'Masakluda'}</td></tr>
              <tr><td>Tanggal Closing</td><td>${data.tanggal}</td></tr>
              <tr><td>Shift</td><td>${data.shift}</td></tr>
              <tr><td>Karyawan</td><td>${data.karyawan}</td></tr>
              <tr><td>Total Penjualan (Resi)</td><td>${formatRupiah(dataResi.total_penjualan || 0)}</td></tr>
              <tr><td>Total Penjualan (Aktual)</td><td>${formatRupiah(data.ringkasan_aktual.total_penjualan)}</td></tr>
              <tr><td>Total Selisih</td><td>${formatRupiah(totalSelisih)}</td></tr>
              <tr><td>Status Matching</td><td><strong>${kesimpulan.statusOverall}</strong></td></tr>
              <tr><td>Keterangan</td><td>${data.keterangan || '-'}</td></tr>
              <tr><td>Waktu Submit</td><td>${new Date().toLocaleString('id-ID')}</td></tr>
          `;
          
          // Tambahkan card kesimpulan
          const summaryInfo = document.getElementById('summaryInfo');
          summaryInfo.innerHTML = `
              <div class="status-card ${kesimpulan.totalMatch ? 'status-success' : kesimpulan.totalSelisih <= 5000 ? 'status-warning' : 'status-error'}">
                  <h4>KESIMPULAN MATCHING</h4>
                  <p><strong>Status: ${kesimpulan.statusOverall}</strong></p>
                  <p>Total Selisih: ${formatRupiah(kesimpulan.totalSelisih)}</p>
                  ${kesimpulan.rekomendasi.length > 0 ? 
                      `<p>Rekomendasi:<br>${kesimpulan.rekomendasi.join('<br>')}</p>` : 
                      '<p>‚úÖ Semua data matching sempurna</p>'
                  }
              </div>
          `;
          
          console.log('‚úÖ Hasil closing di-render');
      }
  
      // Fungsi untuk kirim PDF via email - menggantikan cetakLaporan()
      // Update fungsi kirimEmailLaporan()
      async function kirimEmailLaporan() {
          console.log('üìß Memulai kirimEmailLaporan...');
          
          // Tampilkan loading state untuk tombol kirim email
          const btnKirim = document.getElementById('btnKirimEmail');
          const btnText = document.getElementById('btnKirimText');
          const btnLoading = document.getElementById('btnKirimLoading');
          
          if (btnKirim) {
              btnKirim.disabled = true;
              btnText.textContent = 'Mengirim...';
              if (btnLoading) btnLoading.classList.remove('hidden');
          }
          
          try {
              // Generate kesimpulan
              const kesimpulan = generateKesimpulan();
              
              // Siapkan data untuk PDF - DITAMBAH KESIMPULAN
              const dataPDF = {
                  chat_id: chatId,
                  tanggal: document.getElementById('tanggalClosing').value,
                  shift: document.getElementById('shift').value,
                  karyawan: document.getElementById('karyawan').value,
                  data_resi: dataResi,
                  ringkasan_aktual: {
                      total_penjualan: parseInt(document.getElementById('aktualTotalPenjualan').value) || 0,
                      subtotal: parseInt(document.getElementById('aktualSubtotal').value) || 0,
                      diskon_bill: parseInt(document.getElementById('aktualDiskon').value) || 0
                  },
                  pembayaran_aktual: getPembayaranAktual(),
                  keterangan: document.getElementById('keteranganUmum').value,
                  kesimpulan: kesimpulan, // ‚¨ÖÔ∏è INI YANG BARU
                  kesimpulan_text: getKesimpulanText(kesimpulan), // ‚¨ÖÔ∏è TEKS READABLE
                  timestamp: new Date().toISOString()
              };
              
              console.log('üì¶ Data untuk PDF:', dataPDF);
              
              // Kirim request ke webhook untuk generate dan kirim PDF
              const response = await fetch(WEBHOOK_SEND_EMAIL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(dataPDF)
              });
              
              console.log('üì• Response dari webhook email:', response.status);
              
              if (!response.ok) {
                  throw new Error(`Gagal mengirim email: ${response.status}`);
              }
              
              const result = await response.json();
              console.log('‚úÖ Response kirim email:', result);
              
              // Tampilkan notifikasi sukses
              document.getElementById('summaryInfo').innerHTML = 
                  `<div class="status-success status-card">‚úì Laporan PDF berhasil dikirim via email!\nStatus: ${kesimpulan.statusOverall}</div>`;
              
              alert(`Laporan PDF berhasil dikirim via email!\nStatus: ${kesimpulan.statusOverall}`);
              
          } catch (error) {
              console.error('üí• Error kirim email:', error);
              
              document.getElementById('summaryInfo').innerHTML = 
                  `<div class="status-error status-card">‚ùå Gagal mengirim email: ${error.message}</div>`;
              
              alert(`Gagal mengirim email: ${error.message}`);
          } finally {
              // Reset tombol
              if (btnKirim) {
                  btnKirim.disabled = false;
                  btnText.textContent = 'Kirim PDF via Email';
                  if (btnLoading) btnLoading.classList.add('hidden');
              }
          }
      }
  
      // Fungsi tambahan
      function cetakLaporan() {
        console.log('üñ®Ô∏è Cetak laporan');
        window.print();
      }
  
      function simpanDanTutup() {
        console.log('üíæ Simpan dan tutup');
        alert('Terima kasih! Form closing telah selesai.');
      }
      
      console.log('‚úÖ Semua fungsi JavaScript berhasil di-load');
  </script>
</body>
</html>
