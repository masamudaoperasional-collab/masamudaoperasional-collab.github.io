<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Absensi Karyawan</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      background: #f0f2f5;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 90%; max-width: 400px;
    }
    .card h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: 14px;
      color: #555;
    }
    select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    button {
      width: 100%; padding: 12px; margin-top: 15px;
      border: none; border-radius: 8px;
      font-size: 16px; font-weight: bold; color: white;
      cursor: pointer; transition: background 0.3s;
    }
    .btn-masuk { background: #3498db; }
    .btn-masuk:hover { background: #2980b9; }
    .btn-selesai { background: #2ecc71; }
    .btn-selesai:hover { background: #27ae60; }
    .msg {
      margin-top: 15px; text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Absensi Shift</h2>

    <label for="shift">Pilih Shift</label>
    <select id="shift">
      <option value="">-- Pilih Shift --</option>
      <option value="Pagi">Pagi</option>
      <option value="Siang">Siang</option>
    </select>

    <label for="crew">Nama Karyawan</label>
    <select id="crew">
      <option value="">-- Pilih Karyawan --</option>
      <option value="Crew1">Crew1</option>
      <option value="Crew2">Crew2</option>
      <option value="Crew3">Crew3</option>
    </select>

    <button class="btn-masuk" id="btnMasuk">Masuk Shift</button>
    <button class="btn-selesai" id="btnSelesai">Selesai Shift</button>

    <div class="msg" id="msg"></div>
  </div>

<script>
const officeLat = -6.604950281449473;   // titik kantor
const officeLon = 106.77332736980102;
const radiusMeters = 100;

const WEBHOOK_URL = "https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook-test/attendance-receiver";
const msgEl = document.getElementById("msg");

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function sendAttendance(type, shift, crew, lat, lon, distance){
  const data = {
    shift,
    crew,
    type,
    timestamp: new Date().toISOString(),
    latitude: lat,
    longitude: lon,
    distance: Math.round(distance)
  };

  msgEl.style.color = "#444";
  msgEl.innerText = "📤 Mengirim data...";

  fetch(WEBHOOK_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  })
  .then(r => {
    if(r.ok){
      msgEl.style.color = "green";
      msgEl.innerText = "✅ Absensi berhasil dikirim!";
      setTimeout(()=> window.close(), 2000); // otomatis tutup
    } else {
      msgEl.style.color = "red";
      msgEl.innerText = "❌ Gagal kirim absensi.";
    }
  })
  .catch(err => {
    msgEl.style.color = "red";
    msgEl.innerText = "❌ Error: " + err.message;
  });
}

function handleClick(type){
  const shift = document.getElementById("shift").value;
  const crew = document.getElementById("crew").value;
  if(!shift || !crew){
    msgEl.style.color = "red";
    msgEl.innerText = "Pilih shift & nama karyawan dulu.";
    return;
  }

  msgEl.style.color = "#444";
  msgEl.innerText = "📍 Mengambil lokasi...";

  if(!navigator.geolocation){
    msgEl.style.color = "red";
    msgEl.innerText = "Browser tidak mendukung geolokasi.";
    return;
  }

  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const dist = getDistance(officeLat, officeLon, lat, lon);

    if(dist > radiusMeters && type === "Masuk"){
      msgEl.style.color = "red";
      msgEl.innerText = `🚫 Anda di luar area absensi (${Math.round(dist)} m).`;
      return;
    }

    sendAttendance(type, shift, crew, lat, lon, dist);
  }, err=>{
    msgEl.style.color = "red";
    msgEl.innerText = "❌ Gagal ambil lokasi: " + err.message;
  }, { enableHighAccuracy:true, timeout:15000 });
}

document.getElementById("btnMasuk").onclick = ()=> handleClick("Masuk");
document.getElementById("btnSelesai").onclick = ()=> handleClick("Selesai");
</script>
</body>
</html>
