<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Form Pembelian MasaMuda-Updated</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9;
            --success: #4cc9f0; --danger: #f72585; --warning: #f8961e; --light: #f8f9fa; --dark: #212529;
            --gray: #6c757d; --border: #e0e0e0; --bg-body: #f5f7fa;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --radius: 12px;
            --whatsapp: #25D366;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--dark); line-height: 1.6; padding-bottom: 120px; }
        .container { padding: 16px; }
        .wizard-steps { display: flex; justify-content: space-around; padding: 16px; background-color: white; border-bottom: 1px solid var(--border); margin: -16px -16px 16px -16px; }
        .step-indicator { display: flex; flex-direction: column; align-items: center; color: var(--gray); font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .step-indicator:hover { color: var(--primary); }
        .step-indicator .step-icon { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--gray); display: flex; align-items: center; justify-content: center; margin-bottom: 6px; transition: all 0.3s ease; }
        .step-indicator.active { color: var(--primary); }
        .step-indicator.active .step-icon { background-color: var(--primary); border-color: var(--primary); color: white; }
        .step-indicator.completed .step-icon { background-color: var(--success); border-color: var(--success); color: white; }

        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .card-header { padding: 16px; font-size: 1.1rem; font-weight: 600; color: var(--primary); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 16px; }
        
        .form-group { margin-bottom: 18px; }
        .form-label { font-weight: 500; margin-bottom: 8px; display: block; }
        .required::after { content: " *"; color: var(--danger); }
        .form-control, .form-select { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background-color: #fdfdff; }
        .form-control:focus, .form-select:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        .input-group { display: flex; align-items: center; gap: 8px; }
        .input-group .form-control, .input-group .form-select { flex-grow: 1; }
        .btn-icon { padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background-color: var(--light); cursor: pointer; }

        /* Item & Supplier Search */
        .item-search-wrapper { position: relative; z-index: 100; }
        #item-search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow); max-height: 250px; overflow-y: auto; z-index: 100; margin-top: 4px; }
        .search-result-item { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .search-result-item:hover { background-color: #f5f7fa; }
        
        /* Item Card */
        .item-card { display: flex; align-items: center; padding: 12px; background: #fdfdff; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; }
        .item-card-info { flex-grow: 1; cursor: pointer; }
        .item-card-name { font-weight: 600; }
        .item-card-price { font-size: 0.9rem; color: var(--gray); }
        .item-card-actions { display: flex; align-items: center; gap: 8px; }
        .quantity-input { width: 40px; text-align: center; border: none; background: #f0f3f7; font-weight: 600; padding: 6px; border-radius: 6px; }
        .quantity-btn, .remove-item-btn { width: 30px; height: 30px; border-radius: 50%; border: none; background: #e9ecef; color: var(--dark); font-size: 1rem; cursor: pointer; }
        .remove-item-btn { background-color: rgba(247, 37, 133, 0.1); color: var(--danger); }

        /* Total Summary */
        .total-summary { margin-top: 20px; padding: 16px; background: #f1f5fd; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .summary-row.total { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: block; animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 0; border: 1px solid #888; width: 95%; max-width: 500px; border-radius: var(--radius); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .modal-body { padding: 16px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; padding: 16px; border-top: 1px solid var(--border); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; border: none; background: transparent; }

        /* Bulk Item Modal List */
        .bulk-item-list-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .bulk-item-list-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; }

        /* Draft List */
        .draft-item { position: relative; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; }
        .draft-item:hover { background-color: #f5f7fa; }
        .draft-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .draft-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s ease; }
        .draft-item:hover .draft-actions { opacity: 1; }
        .draft-delete-btn { background: rgba(247, 37, 133, 0.1); border: 1px solid var(--danger); color: var(--danger); width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .draft-delete-btn:hover { background: var(--danger); color: white; }
        .draft-po-number { font-weight: 600; color: var(--primary); }
        .draft-supplier { font-size: 0.9rem; color: var(--gray); }
        .draft-items { font-size: 0.8rem; color: var(--gray); margin-top: 4px; }

        /* PO Sheet Modal - PERBAIKAN UTAMA */
        #po-sheet-modal .modal-content {
            font-family: 'Arial', sans-serif;
            color: #000;
            max-width: 95%;
            width: 95%;
            margin: 2% auto;
            height: 96vh;
            max-height: 96vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: none;
            position: relative;
        }
        
        #po-sheet-modal .modal-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 1001;
            padding: 15px 20px;
            border-bottom: 2px solid var(--primary);
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #po-sheet-modal .modal-body {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            position: relative;
        }
        
        #po-sheet-modal .modal-footer {
            flex-shrink: 0;
            padding: 12px 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Style khusus untuk konten PO Sheet */
        .po-sheet-body {
            padding: 20px;
            font-size: 14px;
            line-height: 1.4;
            background: white;
            min-height: 100%;
            box-sizing: border-box;
        }
        
        .po-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #333;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            margin: -20px -20px 25px -20px;
            border-radius: 8px 8px 0 0;
        }
        
        .po-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .po-header p {
            margin: 8px 0 0 0;
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .po-addresses {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .po-addresses > div {
            width: 100%;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .po-addresses h4 {
            font-size: 16px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .po-addresses p {
            margin: 6px 0;
            font-size: 13px;
            line-height: 1.4;
            color: #495057;
        }
        
        .po-addresses strong {
            color: #2c3e50;
        }
        
        .po-meta {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .po-meta div {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        
        .po-meta strong {
            display: inline-block;
            min-width: 100px;
            color: #495057;
            font-weight: 600;
        }
        
        .po-meta span {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .po-item-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
        }
        
        .po-item-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
            min-width: 400px;
        }
        
        .po-item-table th,
        .po-item-table td {
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            text-align: left;
            word-break: break-word;
            vertical-align: top;
            line-height: 1.4;
        }
        
        .po-item-table th:nth-child(1),
        .po-item-table td:nth-child(1) {
            width: 10%;
            text-align: center;
            font-weight: 600;
        }
        
        .po-item-table th:nth-child(2),
        .po-item-table td:nth-child(2) {
            width: 65%;
            padding-left: 12px;
        }
        
        .po-item-table th:nth-child(3),
        .po-item-table td:nth-child(3) {
            width: 25%;
            text-align: center;
            font-weight: 500;
        }
        
        .po-item-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 14px 8px;
            border-color: #2c3e50;
        }
        
        .po-item-table td {
            font-size: 13px;
            color: #495057;
        }
        
        .po-item-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .po-item-table tbody tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.2s ease;
        }
        
        .po-footer {
            margin-top: 25px;
            font-size: 13px;
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            color: #6c757d;
        }
        
        .po-footer p:first-child {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        
        /* Tombol close yang lebih mudah di-tap di mobile */
        #po-sheet-modal .close-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: absolute;
            right: 15px;
            top: 15px;
            z-index: 1002;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid #dee2e6;
            color: #6c757d;
            transition: all 0.2s ease;
        }
        
        #po-sheet-modal .close-btn:hover {
            background: #fff;
            color: #dc3545;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.25);
        }
        
        /* Responsive improvements */
        @media (max-width: 480px) {
            #po-sheet-modal .modal-content {
                margin: 2% auto;
                height: 96vh;
                max-height: 96vh;
                width: 98%;
                max-width: 98%;
            }
            
            .po-sheet-body {
                font-size: 12px;
                padding: 15px;
            }
            
            .po-header {
                padding: 15px;
                margin: -15px -15px 20px -15px;
            }
            
            .po-header h2 {
                font-size: 18px;
            }
            
            .po-header p {
                font-size: 12px;
            }
            
            .po-item-table {
                font-size: 12px;
            }
            
            .po-item-table th,
            .po-item-table td {
                padding: 10px 6px;
                font-size: 11px;
            }
            
            .po-item-table th:nth-child(1),
            .po-item-table td:nth-child(1) {
                width: 12%;
            }
            
            .po-item-table th:nth-child(2),
            .po-item-table td:nth-child(2) {
                width: 60%;
                padding-left: 8px;
            }
            
            .po-item-table th:nth-child(3),
            .po-item-table td:nth-child(3) {
                width: 28%;
            }
            
            .po-addresses h4 {
                font-size: 14px;
            }
            
            .po-addresses p {
                font-size: 11px;
            }
            
            .po-meta div {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .po-meta strong {
                min-width: auto;
            }
        }
        
        @media (min-width: 768px) {
            #po-sheet-modal .modal-content {
                max-width: 1000px;
                width: 90%;
                margin: 10% auto;
                height: 70vh;
            }
            
            .po-addresses {
                flex-direction: row;
            }
            
            .po-addresses > div {
                width: 48%;
            }
            
            .po-meta {
                flex-direction: row;
            }
            
            .po-meta div {
                width: 48%;
                flex-direction: row;
            }
            
            .po-item-table th:nth-child(1),
            .po-item-table td:nth-child(1) {
                width: 8%;
            }
            
            .po-item-table th:nth-child(2),
            .po-item-table td:nth-child(2) {
                width: 67%;
                padding-left: 15px;
            }
            
            .po-item-table th:nth-child(3),
            .po-item-table td:nth-child(3) {
                width: 25%;
            }
        }
        
        @media (min-width: 1024px) {
            #po-sheet-modal .modal-content {
                max-width: 900px;
            }
            
            .po-item-table th:nth-child(1),
            .po-item-table td:nth-child(1) {
                width: 7%;
            }
            
            .po-item-table th:nth-child(2),
            .po-item-table td:nth-child(2) {
                width: 68%;
            }
            
            .po-item-table th:nth-child(3),
            .po-item-table td:nth-child(3) {
                width: 25%;
            }
        }
        
        /* Touch improvements untuk mobile */
        @media (hover: none) and (pointer: coarse) {
            #po-sheet-modal .close-btn:hover {
                background: rgba(255, 255, 255, 0.95);
                color: #6c757d;
            }
            
            .po-item-table th,
            .po-item-table td {
                min-height: 44px;
                display: table-cell;
                vertical-align: middle;
            }
        }
        
        /* Print styles untuk PO Sheet */
        @media print {
            #po-sheet-modal .modal-content {
                box-shadow: none;
                border: none;
                margin: 0;
                width: 100%;
                height: auto;
                max-height: none;
                position: static;
            }
            
            #po-sheet-modal .modal-header,
            #po-sheet-modal .modal-footer {
                display: none;
            }
            
            #po-sheet-modal .modal-body {
                padding: 0;
                overflow: visible;
                height: auto;
            }
            
            .po-sheet-body {
                padding: 20mm;
                font-size: 12pt;
            }
            
            .po-item-table {
                page-break-inside: avoid;
            }
            
            .po-header {
                background: none !important;
                margin: 0 0 20px 0 !important;
                padding: 0 0 15px 0 !important;
            }
        }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px 16px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); z-index: 500; display: flex; gap: 10px; }
        .bottom-nav-main { display: flex; gap: 10px; width: 100%; }
        .bottom-nav-review { display: flex; gap: 10px; width: 100%; }
        .btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 16px; border: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; flex: 1; }
        .btn-primary { background: var(--primary); color: white; padding: 13px 16px; align-items: center; margin-left: auto; margin-right: auto; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        .hidden { display: none; }

        /* Payment Method Section */
        .payment-method-section { margin-top: 20px; }
        .payment-method-cards { display: flex; gap: 12px; margin-bottom: 20px; }
        .payment-method-card { flex: 1; padding: 16px; border: 2px solid var(--border); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .payment-method-card:hover { border-color: var(--primary-light); }
        .payment-method-card.selected { border-color: var(--primary); background-color: rgba(67, 97, 238, 0.05); }
        .payment-method-icon { font-size: 1.5rem; margin-bottom: 8px; color: var(--gray); }
        .payment-method-card.selected .payment-method-icon { color: var(--primary); }
        .payment-method-name { font-weight: 600; }
        .payment-status { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Review Section */
        .review-section { padding: 16px; }
        .review-info { margin-bottom: 20px; }
        .review-info h4 { margin-bottom: 10px; color: var(--primary); }
        .review-items { margin-bottom: 20px; }
        .review-items h4 { margin-bottom: 10px; color: var(--primary); }
        .review-total { background: #f1f5fd; padding: 16px; border-radius: 8px; }
        .review-total h4 { margin-bottom: 10px; color: var(--primary); }
        .po-sheet-btn-container { margin-top: 0px; text-align: center; }

        /* Shipping Section */
        .shipping-section { margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; }
        .shipping-toggle { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .shipping-form { display: none; }
        .shipping-form.active { display: block; }

        /* Edit Item Modal */
        .edit-item-form .form-group {
            margin-bottom: 16px;
        }
        
        .edit-item-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .edit-item-full-width {
            grid-column: 1 / -1;
        }

        /* Add Item Modal */
        .add-item-form .form-group {
            margin-bottom: 16px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: var(--shadow);
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: var(--success);
        }
        .notification.error {
            background-color: var(--danger);
        }
        .notification.warning {
            background-color: var(--warning);
        }
        .notification.info {
            background-color: var(--primary);
        }

        /* Payment Details */
        .payment-details {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .payment-status-label {
            font-weight: 600;
            color: var(--primary);
        }

        /* Add Item Button */
        .add-item-container {
            margin-top: 16px;
            text-align: center;
            padding: 16px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .add-item-container:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
        .add-item-text {
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Style untuk halaman history */
        .history-item {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fdfdff;
            transition: all 0.2s ease;
        }
        
        .history-item:hover {
            box-shadow: var(--shadow);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .history-po-number {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .history-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-paid {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .status-pending {
            background: rgba(248, 150, 30, 0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        .history-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        .history-detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--gray);
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .history-items-preview {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .items-preview-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .items-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .item-preview-tag {
            background: var(--light);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--dark);
        }
        
        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #e02d6f;
        }
        
        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .history-empty i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: var(--border);
        }
        
        /* Style untuk modal hapus */
        .delete-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 4px solid var(--danger);
        }
        
        /* Style untuk tampilan info Telegram */
        .telegram-info {
            margin-bottom: 16px;
            text-align: center;
        }
        
        .telegram-info div {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .telegram-info div {
                font-size: 0.7rem;
                padding: 6px 10px;
            }
        }

        /* !!! KODE CSS BARU UNTUK MODAL PANDUAN !!! */
        #guide-content {
            padding: 16px;
        }
        #guide-content h4 {
            margin-top: 15px;
            margin-bottom: 8px;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }
        #guide-content h4:first-child {
            margin-top: 0;
        }
        #guide-content ul {
            list-style-position: inside;
            padding-left: 5px;
        }
        #guide-content li {
            margin-bottom: 8px;
            color: var(--dark);
        }
        #guide-content li strong {
            font-weight: 600;
            color: var(--secondary);
        }
        /* !!! AKHIR DARI KODE CSS BARU !!! */
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <!-- Wizard Header -->
        <div class="wizard-steps">
            <div class="step-indicator active" id="indicator-1" data-step="1">
                <div class="step-icon"><i class="fas fa-file-alt"></i></div>Info
            </div>
            <div class="step-indicator" id="indicator-2" data-step="2">
                <div class="step-icon"><i class="fas fa-box"></i></div>Item
            </div>
            <div class="step-indicator" id="indicator-3" data-step="3">
                <div class="step-icon"><i class="fas fa-check"></i></div>Review
            </div>
            <div class="step-indicator" id="indicator-4" data-step="4">
                <div class="step-icon"><i class="fas fa-history"></i></div>History
            </div>
        </div>
        
        <!-- PAGE 1: INFO -->
        <div id="page-1" class="page active">
            <div class="card">
                <div class="card-header"><i class="fas fa-info-circle"></i> Informasi Pembelian</div>
                <div class="card-body">
                    <button id="load-draft-btn" class="btn btn-outline" style="margin-bottom: 20px;"><i class="fas fa-folder-open"></i> Ambil dari Draft PO</button>
                    <div class="form-group">
                        <label for="purchase-type" class="form-label required">Tipe Pembelian</label>
                        <select class="form-select" id="purchase-type" required>
                            <option value="purchase_order">Purchase Order</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="po-number" class="form-label">Nomor PO</label>
                        <input type="text" class="form-control" id="po-number" readonly>
                    </div>
                    <div class="form-group">
                        <label for="supplier" class="form-label required">Supplier</label>
                        <div class="input-group">
                            <select class="form-select" id="supplier" required>
                                <option value="" selected disabled>Memuat...</option>
                            </select>
                            <button id="manage-supplier-btn" class="btn-icon"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="purchase-date" class="form-label required">Tanggal</label>
                        <input type="date" class="form-control" id="purchase-date" required>
                    </div>
                </div>
            </div>

            <!-- !!! KODE BARU UNTUK TOMBOL PANDUAN !!! -->
            <div style="padding: 0 0 20px 0;">
                <button id="show-guide-btn" class="btn btn-outline" style="width: 100%; margin: 0 auto;">
                    <i class="fas fa-question-circle"></i> Lihat Panduan Penggunaan
                </button>
            </div>
            <!-- !!! AKHIR DARI KODE BARU !!! -->
        </div>
        
        <!-- PAGE 2: ITEM -->
        <div id="page-2" class="page">
            <div class="card">
                <div class="card-header"><i class="fas fa-search"></i> Cari & Tambah Item</div>
                <div class="card-body">
                    <div class="form-group item-search-wrapper">
                        <label for="item-search" class="form-label">Cari Item Tunggal</label>
                        <input type="text" class="form-control" id="item-search" placeholder="Ketik untuk cari nama item...">
                        <div id="item-search-results" class="hidden"></div>
                    </div>
                    <button id="bulk-add-btn" class="btn btn-outline"><i class="fas fa-list-ul"></i> Pilih beberapa item dari Daftar (Bulk)</button>
                    
                    <!-- Add Item Button -->
                    <div class="add-item-container" id="add-item-btn">
                        <i class="fas fa-plus-circle" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                        <div class="add-item-text">Tambah Item Baru</div>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 4px;">Klik untuk menambahkan item yang tidak ada di daftar</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><i class="fas fa-shopping-cart"></i> Keranjang Item</div>
                <div class="card-body">
                    <div id="item-list-container"></div>
                    <div class="total-summary" id="total-summary-container">
                        <div class="summary-row total">Total: Rp 0</div>
                    </div>
                </div>
            </div>

            <!-- Shipping Section -->
            <div class="card">
                <div class="card-header"><i class="fas fa-truck"></i> Ongkos Kirim</div>
                <div class="card-body">
                    <div class="shipping-section">
                        <div class="shipping-toggle">
                            <span class="form-label">Aktifkan Ongkos Kirim</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="shipping-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="shipping-form" id="shipping-form">
                            <div class="form-group">
                                <label for="shipping-cost" class="form-label">Biaya Ongkos Kirim</label>
                                <input type="number" class="form-control" id="shipping-cost" placeholder="Masukkan biaya ongkos kirim" min="0">
                            </div>
                            <button id="add-shipping-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Tambah Ongkos Kirim</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PAGE 3: REVIEW -->
        <div id="page-3" class="page">
            <div class="card">
                <div class="card-header"><i class="fas fa-clipboard-check"></i> Ringkasan Pembelian</div>
                <div class="card-body review-section" id="review-container">
                    <!-- Review content will be generated here -->
                </div>
            </div>

            <!-- Payment Method Section -->
            <div class="card">
                <div class="card-header"><i class="fas fa-credit-card"></i> Metode Pembayaran *hanya ketika bukti pembelian sudah diterima</div>
                <div class="card-body">
                    <div class="payment-method-section">
                        <div class="form-group">
                            <label for="payment-date" class="form-label">Tanggal Pembayaran</label>
                            <input type="date" class="form-control" id="payment-date">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Metode Pembayaran</label>
                            <div class="payment-method-cards">
                                <div class="payment-method-card" data-method="tunai">
                                    <div class="payment-method-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="payment-method-name">Tunai</div>
                                </div>
                                <div class="payment-method-card" data-method="transfer">
                                    <div class="payment-method-icon">
                                        <i class="fas fa-exchange-alt"></i>
                                    </div>
                                    <div class="payment-method-name">Transfer</div>
                                </div>
                                <div class="payment-method-card" data-method="kredit">
                                    <div class="payment-method-icon">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="payment-method-name">Kredit</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-details">
                            <div class="form-group">
                                <label for="paid-amount" class="form-label">Nominal Pembayaran</label>
                                <input type="number" class="form-control" id="paid-amount" placeholder="Masukkan nominal pembayaran" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label for="payment-notes" class="form-label">Catatan Pembayaran</label>
                                <textarea class="form-control" id="payment-notes" rows="3" placeholder="Tambahkan catatan pembayaran (opsional)"></textarea>
                            </div>
                            
                            <div class="payment-status">
                                <div>
                                    <span class="payment-status-label">Status Pembayaran: </span>
                                    <span id="payment-status-text">Pending</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="payment-status">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="po-sheet-btn-container">
                        <button id="view-po-btn-review" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Lihat Lembar PO *screenshoot atau klik print*</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PAGE 4: HISTORY -->
        <div id="page-4" class="page">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-history"></i> Riwayat Pembelian
                    <button id="refresh-history-btn" class="btn-icon" style="margin-left: auto;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <div class="input-group">
                            <input type="text" class="form-control" id="history-search" placeholder="Cari berdasarkan nomor PO, supplier, atau item...">
                            <button id="search-history-btn" class="btn-icon">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div id="history-list-container">
                        <p style="text-align: center; padding: 20px; color: var(--gray);">Klik ikon refresh untuk memuat riwayat pembelian...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div id="nav-main" class="bottom-nav-main">
            <button id="back-btn" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Kembali</button>
            <button id="next-btn" class="btn btn-primary">Lanjut <i class="fas fa-arrow-right"></i></button>
        </div>
        <div id="nav-review" class="bottom-nav-review hidden">
            <button id="back-to-edit-btn" class="btn btn-outline"><i class="fas fa-edit"></i> Edit</button>
            <button id="save-draft-btn" class="btn btn-warning"><i class="fas fa-save"></i> Simpan Draft</button>
            <button id="submit-btn" class="btn btn-success"><i class="fas fa-paper-plane"></i> Simpan PO</button>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="bulk-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pilih Item</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body" id="bulk-item-list"></div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn"><i class="fas fa-times"></i> Batal</button>
                <button id="add-selected-items-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Tambah Terpilih</button>
            </div>
        </div>
    </div>
    
    <div id="draft-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pilih Draft</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body" id="draft-list-container"></div>
        </div>
    </div>
    
    <div id="supplier-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manajemen Supplier</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="supplier-id">
                <div class="form-group">
                    <label class="form-label required">ID Supplier</label>
                    <input type="text" id="supplier-id-input" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Nama Supplier</label>
                    <input type="text" id="supplier-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Nomor Kontak</label>
                    <input type="text" id="supplier-contact" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Alamat Email</label>
                    <input type="email" id="supplier-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Alamat Supplier</label>
                    <textarea id="supplier-address" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label required">Nama Rekening</label>
                    <input type="text" id="supplier-account-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Bank</label>
                    <input type="text" id="supplier-bank" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Nomor Rekening</label>
                    <input type="text" id="supplier-account-number" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn"><i class="fas fa-times"></i> Batal</button>
                <button id="save-supplier-btn" class="btn btn-success"><i class="fas fa-save"></i> Simpan</button>
            </div>
        </div>
    </div>
    
    <!-- PO Sheet Modal - PERBAIKAN UTAMA -->
    <div id="po-sheet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Lembar Purchase Order</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="po-sheet-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn"><i class="fas fa-times"></i> Tutup</button>
                <button id="print-po-btn" class="btn btn-primary"><i class="fas fa-print"></i> Print</button>
                <!-- TOMBOL WHATSAPP BARU -->
                <button id="share-whatsapp-btn" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> Bagikan ke WhatsApp</button>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Item *untuk saat ini gunakan/ubah satuan sesuai satuan pembelian</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form class="edit-item-form">
                    <input type="hidden" id="edit-item-sku">
                    
                    <div class="edit-item-grid">
                        <div class="form-group edit-item-full-width">
                            <label class="form-label required">Nama Item</label>
                            <input type="text" id="edit-item-name" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">SKU</label>
                            <input type="text" id="edit-item-sku-display" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kategori</label>
                            <input type="text" id="edit-item-category" class="form-control" placeholder="Masukkan kategori">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">Harga</label>
                            <input type="number" id="edit-item-price" class="form-control" required min="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Satuan</label>
                            <input type="text" id="edit-item-unit" class="form-control" placeholder="pcs, kg, etc">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">Jumlah</label>
                            <input type="number" id="edit-item-quantity" class="form-control" required min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Keterangan</label>
                        <textarea id="edit-item-description" class="form-control" rows="3" placeholder="Tambahkan keterangan item"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn"><i class="fas fa-times"></i> Batal</button>
                <button id="save-item-btn" class="btn btn-primary"><i class="fas fa-save"></i> Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="add-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Item Baru</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form class="add-item-form">
                    <div class="form-group">
                        <label class="form-label required">Nama Item</label>
                        <input type="text" id="add-item-name" class="form-control" placeholder="Masukkan nama item" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">SKU</label>
                        <input type="text" id="add-item-sku" class="form-control" placeholder="Masukkan SKU item" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategori</label>
                        <input type="text" id="add-item-category" class="form-control" placeholder="Masukkan kategori item">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Satuan</label>
                        <input type="text" id="add-item-unit" class="form-control" placeholder="Masukkan satuan item (pcs, kg, etc)">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Harga</label>
                        <input type="number" id="add-item-price" class="form-control" placeholder="Masukkan harga item" required min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Jumlah</label>
                        <input type="number" id="add-item-quantity" class="form-control" value="1" required min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Keterangan</label>
                        <textarea id="add-item-description" class="form-control" rows="3" placeholder="Tambahkan keterangan item (opsional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn"><i class="fas fa-times"></i> Batal</button>
                <button id="save-new-item-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Tambah Item</button>
            </div>
        </div>
    </div>
    
    <!-- Modal konfirmasi hapus -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Konfirmasi Hapus</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>Anda akan menghapus data pembelian dengan:</p>
                <div class="delete-info" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 12px 0;">
                    <strong>Nomor PO:</strong> <span id="delete-po-number"></span><br>
                    <strong>Supplier:</strong> <span id="delete-supplier"></span><br>
                    <strong>Tanggal:</strong> <span id="delete-date"></span>
                </div>
                <p style="color: var(--danger); font-weight: 600; margin-bottom: 8px;">Tindakan ini tidak dapat dibatalkan!</p>
                <div class="form-group">
                    <label for="delete-password" class="form-label">Ketik password untuk konfirmasi:</label>
                    <input type="password" class="form-control" id="delete-password" placeholder="Masukkan password 1234">
                    <small style="color: var(--gray); font-size: 0.8rem;">Password: 1234</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn"><i class="fas fa-times"></i> Batal</button>
                <button id="confirm-delete-btn" class="btn btn-danger" disabled><i class="fas fa-trash"></i> Hapus</button>
            </div>
        </div>
    </div>
    
    <!-- Modal konfirmasi hapus draft -->
    <div id="delete-draft-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Hapus Draft</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>Anda akan menghapus draft:</p>
                <div class="delete-info" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 12px 0;">
                    <strong>Nomor PO:</strong> <span id="delete-draft-po-number"></span><br>
                    <strong>Supplier:</strong> <span id="delete-draft-supplier"></span><br>
                    <strong>Tanggal:</strong> <span id="delete-draft-date"></span>
                </div>
                <p style="color: var(--danger); font-weight: 600; margin-bottom: 8px;">Tindakan ini tidak dapat dibatalkan!</p>
                <div class="form-group">
                    <label for="delete-draft-password" class="form-label">Ketik password untuk konfirmasi:</label>
                    <input type="password" class="form-control" id="delete-draft-password" placeholder="Masukkan password 1234">
                    <small style="color: var(--gray); font-size: 0.8rem;">Password: 1234</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-btn"><i class="fas fa-times"></i> Batal</button>
                <button id="confirm-delete-draft-btn" class="btn btn-danger" disabled><i class="fas fa-trash"></i> Hapus Draft</button>
            </div>
        </div>
    </div>
    
    <!-- !!! KODE BARU UNTUK MODAL PANDUAN !!! -->
    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-book"></i> Panduan Penggunaan</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body" id="guide-content">
                <h4>Langkah 1: Mengisi Informasi Pembelian</h4>
                <ul>
                    <li><strong>Ambil dari Draft:</strong> Klik tombol ini jika Anda ingin memuat data pembelian yang sudah disimpan sebelumnya sebagai draft.</li>
                    <li><strong>Tipe Pembelian:</strong> Pilih "Purchase Order" untuk pembelian resmi ke supplier atau "Offline" untuk pencatatan pembelian internal.</li>
                    <li><strong>Supplier:</strong> Pilih supplier dari daftar. Jika belum ada, klik ikon '+' untuk menambah supplier baru.</li>
                    <li><strong>Tanggal:</strong> Pilih tanggal transaksi pembelian. Nomor PO akan dibuat otomatis berdasarkan tanggal dan supplier.</li>
                </ul>

                <h4>Langkah 2: Menambah Item ke Keranjang</h4>
                <ul>
                    <li><strong>Cari Item Tunggal:</strong> Ketik nama atau SKU item untuk mencarinya, lalu klik untuk menambahkannya ke keranjang.</li>
                    <li><strong>Pilih Beberapa Item (Bulk):</strong> Klik tombol ini untuk melihat semua daftar item dan memilih beberapa sekaligus dengan mencentangnya.</li>
                    <li><strong>Tambah Item Baru:</strong> Jika item tidak ada di daftar, klik area ini untuk menambahkan item baru secara manual.</li>
                    <li><strong>Keranjang:</strong> Di sini Anda bisa mengubah jumlah (quantity) atau menghapus item. Klik pada nama item untuk mengedit detailnya (harga, nama, dll).</li>
                    <li><strong>Ongkos Kirim:</strong> Aktifkan toggle jika ada biaya ongkos kirim, lalu masukkan nominalnya.</li>
                </ul>

                <h4>Langkah 3: Review dan Pembayaran</h4>
                <ul>
                    <li>Halaman ini menampilkan ringkasan dari semua data yang telah Anda masukkan.</li>
                    <li><strong>Edit:</strong> Jika ada yang salah, klik tombol "Edit" untuk kembali ke halaman sebelumnya.</li>
                    <li><strong>Metode Pembayaran:</strong> Bagian ini diisi <em>hanya jika bukti pembayaran sudah diterima</em>. Pilih tanggal bayar, metode, dan masukkan nominalnya.</li>
                    <li><strong>Status Pembayaran:</strong> Aktifkan toggle ini jika pembelian sudah lunas terbayar.</li>
                    <li><strong>Lihat Lembar PO:</strong> Klik tombol ini untuk melihat pratinjau Purchase Order yang bisa Anda screenshot atau cetak.</li>
                    <li><strong>Draft:</strong> Simpan semua data sebagai draft untuk dilanjutkan nanti.</li>
                    <li><strong>Kirim:</strong> Klik tombol ini untuk menyelesaikan proses dan mengirim data pembelian ke sistem.</li>
                </ul>

                 <h4>Langkah 4: Riwayat Pembelian</h4>
                <ul>
                    <li>Halaman ini berisi daftar semua pembelian yang telah berhasil dikirim.</li>
                    <li><strong>Refresh:</strong> Klik ikon refresh untuk memuat data riwayat terbaru.</li>
                    <li><strong>Cari:</strong> Gunakan kolom pencarian untuk menemukan riwayat berdasarkan Nomor PO, supplier, atau nama item.</li>
                    <li><strong>Detail & Hapus:</strong> Anda dapat melihat detail atau menghapus data riwayat dari daftar.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary close-btn">Mengerti</button>
            </div>
        </div>
    </div>
    <!-- !!! AKHIR DARI KODE BARU !!! -->
 
    <script>
    // Self-executing anonymous function to encapsulate code 
    (function() {
        // Webhook URLs
        const WH_GET_ITEMS = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/ambildarisheet';
        const WH_SAVE_DRAFT = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/simpandraft_formpembelian';
        const WH_GET_DRAFTS = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/draft_po';
        const WH_GET_SUPPLIERS = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/ambil_data_supplier';
        const WH_SAVE_SUPPLIER = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/tambah_informasi_supplier';
        const WH_SUBMIT_FORM = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/hasilformpembelian';
        const WH_EDIT_ITEM = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/status_edit';
        const WH_GET_HISTORY = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/history-formpembelian';
        const WH_DELETE_HISTORY = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/delete-historyformpembelian';
        const WH_DELETE_DRAFT = 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/delete-draft'; 

        let state = {
            currentStep: 1, 
            allItems: [], 
            cart: [], 
            allSuppliers: [], 
            allDrafts: [],
            currentDraft: null,
            shippingEnabled: false,
            paymentMethod: null,
            paymentDate: '',
            paymentStatus: false,
            paidAmount: 0,
            paymentNotes: '',
            history: [],
            filteredHistory: [],
            currentDeleteItem: null,
            currentDeleteDraft: null
        };

        // Fungsi untuk mendapatkan parameter dari URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Fungsi untuk mendapatkan ID Telegram dari parameter URL
        function getTelegramId() {
            return getUrlParameter('id') || 'unknown';
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // DOM Elements Cache
        const D = document;
        const byId = id => D.getElementById(id);

        // Tambahkan fungsi untuk menampilkan info Telegram ID di UI
        function displayTelegramInfo() {
            const telegramId = getTelegramId();
            if (telegramId && telegramId !== 'unknown') {
                const telegramInfo = document.createElement('div');
                telegramInfo.className = 'telegram-info';
                telegramInfo.innerHTML = `
                    <div style="background: #0088cc; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; margin: 10px 0;">
                        <i class="fab fa-telegram"></i> Telegram ID: ${telegramId}
                    </div>
                `;
                
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(telegramInfo, container.firstChild);
                }
                
                console.log('Telegram ID detected:', telegramId);
            }
        }

        function initializeApp() {
            attachEventListeners();
            attachHistoryEventListeners();
            attachDraftDeleteEventListeners();
            Promise.all([fetchItems(), fetchSuppliers()]);
            byId('purchase-date').value = new Date().toISOString().split('T')[0];
            byId('payment-date').value = new Date().toISOString().split('T')[0];
            updateNavButtons();
            renderCart();
            
            // Tampilkan info Telegram ID jika ada
            displayTelegramInfo();
            
            showNotification('Aplikasi berhasil diinisialisasi', 'success');
        }

        function attachEventListeners() {
            // Navigation
            byId('next-btn').addEventListener('click', () => navigateStep('next'));
            byId('back-btn').addEventListener('click', () => navigateStep('back'));
            byId('back-to-edit-btn').addEventListener('click', () => navigateToStep(2));
            
            // PERBAIKAN: Tambahkan event listener untuk semua step indicator
            document.querySelectorAll('.step-indicator').forEach(indicator => {
                indicator.addEventListener('click', function() {
                    const step = parseInt(this.dataset.step);
                    navigateToStep(step);
                });
            });
            
            // Main actions
            byId('load-draft-btn').addEventListener('click', openDraftModal);
            byId('bulk-add-btn').addEventListener('click', openBulkItemModal);
            byId('manage-supplier-btn').addEventListener('click', () => openSupplierModal());
            byId('save-draft-btn').addEventListener('click', saveDraft);
            byId('view-po-btn-review').addEventListener('click', generatePOSheet);
            byId('submit-btn').addEventListener('click', submitPurchase);
            
            // Form inputs
            byId('purchase-date').addEventListener('change', generatePONumber);
            byId('supplier').addEventListener('change', generatePONumber);
            byId('item-search').addEventListener('input', handleItemSearch);

            // Shipping
            byId('shipping-toggle').addEventListener('change', toggleShipping);
            byId('add-shipping-btn').addEventListener('click', addShippingCost);

            // Payment Method
            byId('payment-date').addEventListener('change', function() {
                state.paymentDate = this.value;
            });
            
            byId('paid-amount').addEventListener('change', function() {
                state.paidAmount = parseFloat(this.value) || 0;
            });
            
            byId('payment-notes').addEventListener('change', function() {
                state.paymentNotes = this.value;
            });
            
            byId('payment-status').addEventListener('change', function() {
                state.paymentStatus = this.checked;
                updatePaymentStatusText();
            });
            
            // Payment Method Cards
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.addEventListener('click', function() {
                    // Remove selected class from all cards
                    document.querySelectorAll('.payment-method-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked card
                    this.classList.add('selected');
                    
                    // Set payment method
                    state.paymentMethod = this.dataset.method;
                });
            });

            // Edit Item
            byId('save-item-btn').addEventListener('click', saveItemChanges);

            // Add Item
            byId('add-item-btn').addEventListener('click', openAddItemModal);
            byId('save-new-item-btn').addEventListener('click', saveNewItem);

            // Print PO Sheet - PERBAIKAN: Tombol print dipindah ke modal footer
            byId('print-po-btn').addEventListener('click', printPOSheet);

            // !!! TOMBOL WHATSAPP BARU !!!
            byId('share-whatsapp-btn').addEventListener('click', shareToWhatsApp);

            // !!! PENAMBAHAN UNTUK TOMBOL PANDUAN !!!
            byId('show-guide-btn').addEventListener('click', () => {
                byId('guide-modal').classList.add('show');
            });
            
            // Modals
            setupModal('bulk-item-modal');
            setupModal('draft-list-modal');
            setupModal('supplier-modal');
            setupModal('po-sheet-modal');
            setupModal('edit-item-modal');
            setupModal('add-item-modal');
            
            // !!! PENAMBAHAN UNTUK MODAL PANDUAN !!!
            setupModal('guide-modal');
            
            byId('add-selected-items-btn').addEventListener('click', addSelectedItemsFromBulk);
            byId('save-supplier-btn').addEventListener('click', saveSupplier);
        }

        // Tambahkan event listeners untuk halaman history
        function attachHistoryEventListeners() {
            byId('refresh-history-btn').addEventListener('click', fetchHistory);
            byId('search-history-btn').addEventListener('click', searchHistory);
            byId('history-search').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchHistory();
                }
            });
            
            // Modal hapus
            setupModal('delete-confirm-modal');
            byId('delete-password').addEventListener('input', validateDeletePassword);
            byId('confirm-delete-btn').addEventListener('click', confirmDelete);
        }

        // Tambahkan event listeners untuk delete draft
        function attachDraftDeleteEventListeners() {
            setupModal('delete-draft-modal');
            byId('delete-draft-password').addEventListener('input', validateDeleteDraftPassword);
            byId('confirm-delete-draft-btn').addEventListener('click', confirmDeleteDraft);
        }

        function updatePaymentStatusText() {
            const statusText = byId('payment-status-text');
            statusText.textContent = state.paymentStatus ? 'Paid' : 'Pending';
            statusText.style.color = state.paymentStatus ? 'var(--success)' : 'var(--warning)';
            statusText.style.fontWeight = '600';
        }

        // --- Navigation ---
        function navigateStep(direction) {
            const nextStep = direction === 'next' ? state.currentStep + 1 : state.currentStep - 1;
            if (direction === 'next' && !validateStep(state.currentStep)) return;
            navigateToStep(nextStep);
        }

        function navigateToStep(step) {
            if (step < 1 || step > 4) return;
            if (step === 3) generateReview();
            
            D.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            byId(`page-${step}`).classList.add('active');
            
            // Update step indicators
            D.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 === step) {
                    indicator.classList.add('active');
                } else if (index + 1 < step) {
                    indicator.classList.add('completed');
                }
            });
            
            state.currentStep = step;
            updateNavButtons();
            
            showNotification(`Navigasi ke langkah ${step}`, 'info');
        }

        function updateNavButtons() {
            const navMain = byId('nav-main');
            const navReview = byId('nav-review');
            
            if (state.currentStep === 3) {
                navMain.classList.add('hidden');
                navReview.classList.remove('hidden');
            } else if (state.currentStep === 4) {
                // Untuk halaman history, sembunyikan kedua navigasi utama
                navMain.classList.add('hidden');
                navReview.classList.add('hidden');
            } else {
                navMain.classList.remove('hidden');
                navReview.classList.add('hidden');
                
                // Update button texts
                byId('back-btn').style.display = state.currentStep === 1 ? 'none' : 'flex';
                byId('next-btn').innerHTML = state.currentStep === 2 ? 'Review <i class="fas fa-arrow-right"></i>' : 'Lanjut <i class="fas fa-arrow-right"></i>';
            }
        }

        function validateStep(step) {
            if (step === 1 && (!byId('supplier').value || !byId('purchase-date').value)) {
                showNotification('Harap pilih Supplier dan Tanggal', 'error');
                return false;
            }
            if (step === 2 && state.cart.length === 0) {
                showNotification('Keranjang masih kosong', 'error');
                return false;
            }
            return true;
        }

        // --- Data Fetching ---
        async function fetchItems() {
            showNotification('Memuat data items...', 'info');
            try {
                const response = await fetchData(WH_GET_ITEMS);
                if (response && response.success) {
                    state.allItems = response.data.map(item => ({
                        sku: item.sku,
                        name: item.name,
                        category: item.category,
                        unit: item.unit,
                        price: parseFloat(item.price) || 0,
                        description: item.description || ''
                    }));
                    showNotification(`Berhasil memuat ${state.allItems.length} item`, 'success');
                } else {
                    showNotification('Gagal memuat data items', 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        async function fetchSuppliers() {
            showNotification('Memuat data supplier...', 'info');
            try {
                const suppliers = await fetchData(WH_GET_SUPPLIERS);
                if (suppliers) {
                    state.allSuppliers = suppliers;
                    populateSupplierDropdown();
                    showNotification(`Berhasil memuat ${suppliers.length} supplier`, 'success');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function populateSupplierDropdown() {
            const select = byId('supplier');
            select.innerHTML = '<option value="" disabled selected>Pilih Supplier</option>';
            state.allSuppliers.forEach(s => {
                const option = D.createElement('option');
                option.value = s.id_supplier;
                option.textContent = s.nama_supplier;
                select.appendChild(option);
            });
        }
        
        // --- PO Number Generation ---
        function generatePONumber() {
            const date = new Date(byId('purchase-date').value);
            const supplierId = byId('supplier').value;
            if (!supplierId || isNaN(date)) {
                byId('po-number').value = '';
                return;
            }
            const yyyymmdd = date.getFullYear() + ('0' + (date.getMonth() + 1)).slice(-2) + ('0' + date.getDate()).slice(-2);
            byId('po-number').value = `PO-${yyyymmdd}-${supplierId}`;
        }
        
        // --- Bulk Item Logic ---
        function openBulkItemModal() {
            const container = byId('bulk-item-list');
            container.innerHTML = state.allItems.map(item => `
                <label class="bulk-item-list-item">
                    <input type="checkbox" class="bulk-item-checkbox" value="${item.sku}">
                    <div>
                        <div class="item-card-name">${item.name}</div>
                        <div class="item-card-price">SKU: ${item.sku} - ${formatCurrency(item.price)}</div>
                    </div>
                </label>
            `).join('');
            byId('bulk-item-modal').classList.add('show');
        }

        function addSelectedItemsFromBulk() {
            const selectedItems = [];
            D.querySelectorAll('.bulk-item-checkbox:checked').forEach(checkbox => {
                const sku = checkbox.value;
                const item = state.allItems.find(i => i.sku === sku);
                if (item) {
                    const existing = state.cart.find(ci => ci.sku === sku);
                    if (!existing) {
                        state.cart.push({ ...item, quantity: 1 });
                        selectedItems.push(item.name);
                    }
                }
            });
            
            if (selectedItems.length > 0) {
                showNotification(`Menambahkan ${selectedItems.length} item ke keranjang`, 'success');
                renderCart();
            } else {
                showNotification('Tidak ada item yang dipilih untuk ditambahkan', 'warning');
            }
            
            closeModal('bulk-item-modal');
        }

        // --- Add Item Logic ---
        function openAddItemModal() {
            // Reset form
            byId('add-item-name').value = '';
            byId('add-item-sku').value = '';
            byId('add-item-category').value = '';
            byId('add-item-unit').value = '';
            byId('add-item-price').value = '';
            byId('add-item-quantity').value = '1';
            byId('add-item-description').value = '';
            
            byId('add-item-modal').classList.add('show');
        }

        async function saveNewItem() {
            const name = byId('add-item-name').value.trim();
            const sku = byId('add-item-sku').value.trim();
            const category = byId('add-item-category').value.trim();
            const unit = byId('add-item-unit').value.trim();
            const price = parseFloat(byId('add-item-price').value);
            const quantity = parseInt(byId('add-item-quantity').value);
            const description = byId('add-item-description').value.trim();
            
            // Validasi
            if (!name) {
                showNotification('Nama item harus diisi', 'error');
                return;
            }
            
            if (!sku) {
                showNotification('SKU item harus diisi', 'error');
                return;
            }
            
            if (!price || price <= 0) {
                showNotification('Harga harus lebih dari 0', 'error');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                showNotification('Jumlah harus lebih dari 0', 'error');
                return;
            }
            
            // Cek apakah SKU sudah ada
            const existingItem = state.allItems.find(item => item.sku === sku);
            if (existingItem) {
                showNotification('SKU sudah ada di daftar item', 'error');
                return;
            }
            
            // Buat item baru
            const newItem = {
                sku: sku,
                name: name,
                category: category || 'Lainnya',
                unit: unit || 'pcs',
                price: price,
                quantity: quantity,
                description: description
            };
            
            // Kirim ke webhook untuk menambahkan item baru
            try {
                const addItemData = {
                    action: 'add_item',
                    item: newItem,
                    telegramId: getTelegramId(),
                    timestamp: new Date().toISOString()
                };
                
                const result = await postData(WH_EDIT_ITEM, addItemData);
                if (result) {
                    showNotification('Item berhasil ditambahkan', 'success');
                    
                    // Tambahkan ke daftar item dan keranjang
                    state.allItems.push(newItem);
                    state.cart.push({ ...newItem, quantity: quantity });
                    
                    renderCart();
                    closeModal('add-item-modal');
                }
            } catch (error) {
                showNotification('Gagal menambahkan item', 'error');
            }
        }

        // --- Shipping Logic ---
        function toggleShipping() {
            state.shippingEnabled = byId('shipping-toggle').checked;
            const shippingForm = byId('shipping-form');
            
            if (state.shippingEnabled) {
                shippingForm.classList.add('active');
            } else {
                shippingForm.classList.remove('active');
                // Hapus item ongkos kirim jika ada
                state.cart = state.cart.filter(item => item.sku !== 'SHIPPING');
                renderCart();
            }
        }

        function addShippingCost() {
            const shippingCost = parseFloat(byId('shipping-cost').value);
            
            if (!shippingCost || shippingCost <= 0) {
                showNotification('Biaya ongkos kirim harus lebih dari 0', 'error');
                return;
            }
            
            // Hapus item ongkos kirim lama jika ada
            state.cart = state.cart.filter(item => item.sku !== 'SHIPPING');
            
            // Tambahkan item ongkos kirim baru
            state.cart.push({
                sku: 'SHIPPING',
                name: 'Ongkos Kirim',
                category: 'Biaya Pengiriman',
                unit: 'Pengiriman',
                price: shippingCost,
                quantity: 1,
                description: 'Biaya pengiriman barang'
            });
            
            renderCart();
            showNotification(`Ongkos kirim sebesar ${formatCurrency(shippingCost)} berhasil ditambahkan`, 'success');
            byId('shipping-cost').value = '';
        }

        // --- Edit Item Logic ---
        function openEditItemModal(sku) {
            const item = state.cart.find(i => i.sku === sku);
            if (!item) {
                showNotification('Item tidak ditemukan', 'error');
                return;
            }
            
            byId('edit-item-sku').value = item.sku;
            byId('edit-item-name').value = item.name;
            byId('edit-item-sku-display').value = item.sku;
            byId('edit-item-price').value = item.price;
            byId('edit-item-quantity').value = item.quantity;
            byId('edit-item-unit').value = item.unit || '';
            byId('edit-item-category').value = item.category || '';
            byId('edit-item-description').value = item.description || '';
            
            byId('edit-item-modal').classList.add('show');
        }

        async function saveItemChanges() {
            const sku = byId('edit-item-sku').value;
            const name = byId('edit-item-name').value.trim();
            const price = parseFloat(byId('edit-item-price').value);
            const quantity = parseInt(byId('edit-item-quantity').value);
            const unit = byId('edit-item-unit').value.trim();
            const category = byId('edit-item-category').value.trim();
            const description = byId('edit-item-description').value.trim();
            
            // Validasi
            if (!name) {
                showNotification('Nama item harus diisi', 'error');
                return;
            }
            
            if (!price || price <= 0) {
                showNotification('Harga harus lebih dari 0', 'error');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                showNotification('Jumlah harus lebih dari 0', 'error');
                return;
            }
            
            const itemIndex = state.cart.findIndex(i => i.sku === sku);
            if (itemIndex === -1) {
                showNotification('Item tidak ditemukan di keranjang', 'error');
                return;
            }
            
            // Update item di keranjang dengan semua field
            state.cart[itemIndex].name = name;
            state.cart[itemIndex].price = price;
            state.cart[itemIndex].quantity = quantity;
            state.cart[itemIndex].unit = unit;
            state.cart[itemIndex].category = category;
            state.cart[itemIndex].description = description;
            
            // Kirim perubahan ke webhook dengan data lengkap
            try {
                const editData = {
                    action: 'edit_item',
                    sku: sku,
                    name: name,
                    price: price,
                    quantity: quantity,
                    unit: unit,
                    category: category,
                    description: description,
                    telegramId: getTelegramId(),
                    timestamp: new Date().toISOString()
                };
                
                const result = await postData(WH_EDIT_ITEM, editData);
                if (result) {
                    showNotification('Perubahan item berhasil disimpan', 'success');
                }
            } catch (error) {
                showNotification('Gagal menyimpan perubahan', 'error');
            }
            
            renderCart();
            closeModal('edit-item-modal');
        }

        // --- Draft Logic ---
        async function saveDraft() {
            showNotification('Menyimpan draft...', 'info');
            const telegramId = getTelegramId();
            
            const draftData = {
                draftName: `Draft PO ${byId('po-number').value || new Date().toLocaleString()}`,
                formData: collectFormData(),
                telegramId: telegramId,
                timestamp: new Date().toISOString()
            };
            
            try {
                const result = await postData(WH_SAVE_DRAFT, draftData);
                if (result) {
                    showNotification('Draft berhasil disimpan!', 'success');
                    return true;
                }
            } catch (error) {
                showNotification('Gagal menyimpan draft', 'error');
                console.error('Error saving draft:', error);
            }
            return false;
        }

        async function openDraftModal() {
            showNotification('Memuat draft...', 'info');
            try {
                const drafts = await fetchData(WH_GET_DRAFTS);
                if (drafts) {
                    state.allDrafts = drafts;
                    renderDraftList();
                    byId('draft-list-modal').classList.add('show');
                    showNotification(`Berhasil memuat ${drafts.length} draft`, 'success');
                }
            } catch (error) {
                showNotification('Gagal memuat draft', 'error');
            }
        }
        
        function getSupplierName(supplierId) {
            const supplier = state.allSuppliers.find(s => s.id_supplier === supplierId);
            return supplier ? supplier.nama_supplier : supplierId;
        }
        
        // Perbaikan fungsi render draft list dengan tombol hapus
        function renderDraftList() {
            const container = byId('draft-list-container');
            
            if (!state.allDrafts || state.allDrafts.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">Tidak ada draft tersimpan</p>';
                return;
            }
            
            container.innerHTML = state.allDrafts.map((draft, index) => {
                const items = draft.items ? JSON.parse(draft.items) : [];
                const itemList = items.map(item => item.name).join(', ');
                
                return `
                    <div class="draft-item" data-index="${index}">
                        <div class="draft-item-header">
                            <div>
                                <div class="draft-po-number">${draft.poNumber || `Draft ${draft.row_number || index + 1}`}</div>
                                <div class="draft-supplier">Supplier: ${getSupplierName(draft.supplier)}</div>
                                <div class="draft-items">Items: ${itemList || 'Tidak ada item'}</div>
                            </div>
                            <div class="draft-actions">
                                <button class="draft-delete-btn" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Tambahkan event listeners untuk memuat draft
            container.querySelectorAll('.draft-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.draft-delete-btn')) {
                        loadDraft(e.currentTarget.dataset.index);
                    }
                });
            });
            
            // PERBAIKAN: Event listener untuk tombol hapus draft
            container.querySelectorAll('.draft-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    openDeleteDraftConfirm(index);
                });
            });
        }
        
        function loadDraft(index) {
            const draft = state.allDrafts[index];
            if (!draft) {
                showNotification('Draft tidak ditemukan', 'error');
                return;
            }
            
            // Simpan draft yang sedang aktif
            state.currentDraft = draft;
            
            // Populate form fields from draft data
            byId('purchase-type').value = draft.purchaseType || 'purchase_order';
            byId('po-number').value = draft.poNumber || '';
            byId('supplier').value = draft.supplier || '';
            byId('purchase-date').value = draft.purchaseDate || '';
            
            // Populate payment data if available
            if (draft.paymentDate) {
                byId('payment-date').value = draft.paymentDate;
                state.paymentDate = draft.paymentDate;
            }
            
            if (draft.paymentMethod) {
                state.paymentMethod = draft.paymentMethod;
                // Select the payment method card
                document.querySelectorAll('.payment-method-card').forEach(card => {
                    card.classList.remove('selected');
                    if (card.dataset.method === draft.paymentMethod) {
                        card.classList.add('selected');
                    }
                });
            }
            
            if (draft.paymentStatus !== undefined) {
                state.paymentStatus = draft.paymentStatus === 'paid';
                byId('payment-status').checked = state.paymentStatus;
                updatePaymentStatusText();
            }
            
            if (draft.paidAmount) {
                state.paidAmount = draft.paidAmount;
                byId('paid-amount').value = draft.paidAmount;
            }
            
            if (draft.paymentNotes) {
                state.paymentNotes = draft.paymentNotes;
                byId('payment-notes').value = draft.paymentNotes;
            }
            
            // Parse items from draft (items is a JSON string)
            try {
                if (draft.items) {
                    const itemsData = JSON.parse(draft.items);
                    state.cart = itemsData.map(item => ({
                        sku: item.sku,
                        name: item.name,
                        category: item.category,
                        unit: item.unit,
                        price: parseFloat(item.price) || 0,
                        quantity: parseInt(item.quantity) || 1,
                        description: item.description || ''
                    }));
                } else {
                    state.cart = [];
                }
            } catch (error) {
                state.cart = [];
            }
            
            renderCart();
            generatePONumber();
            closeModal('draft-list-modal');
            
            // Langsung navigasi ke halaman item untuk editing
            navigateToStep(2);
            
            showNotification(`Draft "${draft.poNumber}" berhasil dimuat`, 'success');
        }

        // --- Supplier Management ---
        function openSupplierModal() {
            // Reset form
            byId('supplier-id').value = '';
            byId('supplier-id-input').value = '';
            byId('supplier-name').value = '';
            byId('supplier-contact').value = '';
            byId('supplier-email').value = '';
            byId('supplier-address').value = '';
            byId('supplier-account-name').value = '';
            byId('supplier-bank').value = '';
            byId('supplier-account-number').value = '';
            
            byId('supplier-modal').classList.add('show');
        }

        async function saveSupplier() {
            // Validasi form
            const requiredFields = [
                'supplier-id-input', 'supplier-name', 'supplier-contact', 
                'supplier-email', 'supplier-address', 'supplier-account-name',
                'supplier-bank', 'supplier-account-number'
            ];
            
            for (const fieldId of requiredFields) {
                if (!byId(fieldId).value.trim()) {
                    showNotification(`Field ${byId(fieldId).previousElementSibling.textContent} harus diisi`, 'error');
                    return;
                }
            }
            
            const supplierData = {
                id_supplier: byId('supplier-id-input').value,
                nama_supplier: byId('supplier-name').value,
                nomor_kontak_supplier: byId('supplier-contact').value,
                alamat_email: byId('supplier-email').value,
                alamat_supplier: byId('supplier-address').value,
                nama_rekening: byId('supplier-account-name').value,
                bank_rek: byId('supplier-bank').value,
                rekening_supplier: byId('supplier-account-number').value,
                telegramId: getTelegramId(),
                timestamp: new Date().toISOString()
            };
            
            try {
                const result = await postData(WH_SAVE_SUPPLIER, supplierData);
                if (result) {
                    showNotification('Supplier berhasil disimpan!', 'success');
                    closeModal('supplier-modal');
                    fetchSuppliers(); // Reload suppliers
                }
            } catch (error) {
                showNotification('Gagal menyimpan supplier', 'error');
            }
        }

        // --- PO Sheet Functions - PERBAIKAN UTAMA ---
        function generatePOSheet() {
            const supplier = state.allSuppliers.find(s => s.id_supplier === byId('supplier').value);
            if (!supplier) { 
                showNotification('Supplier tidak ditemukan', 'error');
                return; 
            }
            
            const myCompany = { 
                name: 'Masa Muda Coffee and Space', 
                address: 'Jl. Alternatif IPB, Cikarawang, Dramaga, Bogor', 
                contact: '085156973933 / masamuda.cs@gmail.com' 
            };
            
            const poDate = new Date(byId('purchase-date').value).toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });

            // PERBAIKAN: Buat baris tabel dengan struktur horizontal yang benar
            const itemsHtml = state.cart.map((item, index) => {
                // Potong nama item jika terlalu panjang
                const itemName = item.name.length > 50 ? item.name.substring(0, 50) + '...' : item.name;
                const quantityText = `${item.quantity} ${item.unit || ''}`.trim();
                
                // PERBAIKAN: Pastikan ini adalah satu baris tabel (tr) dengan beberapa kolom (td)
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${itemName}</td>
                        <td>${quantityText}</td>
                    </tr>
                `;
            }).join('');

            const poHtml = `
                <div class="po-sheet-body">
                    <div class="po-header">
                        <h2>PURCHASE ORDER</h2>
                        <p>${myCompany.name}</p>
                    </div>
                    
                    <div class="po-addresses">
                        <div>
                            <h4>KEPADA:</h4>
                            <p>
                                <strong>${supplier.nama_supplier || ''}</strong><br>
                                ${supplier.alamat_supplier || ''}<br>
                                ${supplier.nomor_kontak_supplier || ''}<br>
                                ${supplier.alamat_email || ''}
                            </p>
                        </div>
                        <div>
                            <h4>DARI:</h4>
                            <p>
                                <strong>${myCompany.name}</strong><br>
                                ${myCompany.address}<br>
                                ${myCompany.contact}
                            </p>
                        </div>
                    </div>
                    
                    <div class="po-meta">
                        <div><strong>No. PO:</strong> ${byId('po-number').value || 'Tidak tersedia'}</div>
                        <div><strong>Tanggal:</strong> ${poDate}</div>
                    </div>
                    
                    <div class="po-item-table-container">
                        <table class="po-item-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Barang</th>
                                    <th>Jumlah</th>
                                </tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                    </div>
                    
                    <div class="po-footer">
                        <p>Terima kasih atas kerja samanya.</p>
                        <p style="margin-top: 10px; font-size: 10px; color: #666;">
                            Dokumen ini dibuat secara otomatis pada ${new Date().toLocaleDateString('id-ID')}
                        </p>
                    </div>
                </div>
            `;
            
            byId('po-sheet-content').innerHTML = poHtml;
            byId('po-sheet-modal').classList.add('show');
            
            // Scroll ke atas ketika modal dibuka
            const modalBody = byId('po-sheet-modal').querySelector('.modal-body');
            if (modalBody) {
                modalBody.scrollTop = 0;
            }
            
            showNotification('Lembar PO berhasil dibuat', 'success');
        }

        // PERBAIKAN: Fungsi Print PO Sheet yang sudah diperbaiki
        function printPOSheet() {
            const printWindow = window.open('', '_blank');
            const poContent = byId('po-sheet-content').innerHTML;
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Purchase Order - ${byId('po-number').value}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            color: #000;
                            font-size: 14px;
                        }
                        .po-header { 
                            text-align: center; 
                            margin-bottom: 20px; 
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        .po-header h2 { 
                            margin: 0; 
                            font-size: 18px; 
                        }
                        .po-addresses { 
                            display: flex; 
                            justify-content: space-between; 
                            margin-bottom: 20px; 
                        }
                        .po-addresses > div { 
                            width: 48%; 
                        }
                        .po-addresses h4 { 
                            border-bottom: 1px solid #ccc; 
                            padding-bottom: 5px; 
                        }
                        .po-meta { 
                            display: flex; 
                            justify-content: space-between; 
                            margin-bottom: 20px; 
                        }
                        .po-item-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 20px; 
                        }
                        .po-item-table th, 
                        .po-item-table td { 
                            border: 1px solid #ccc; 
                            padding: 8px; 
                            text-align: left; 
                        }
                        .po-item-table th { 
                            background-color: #f2f2f2; 
                        }
                        .po-footer { 
                            text-align: center; 
                            margin-top: 30px; 
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${poContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        }
                    <\/script>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        // !!! FUNGSI BARU UNTUK SHARE KE WHATSAPP !!!
        function shareToWhatsApp() {
            const supplier = state.allSuppliers.find(s => s.id_supplier === byId('supplier').value);
            if (!supplier) { 
                showNotification('Supplier tidak ditemukan', 'error');
                return; 
            }
            
            const poDate = new Date(byId('purchase-date').value).toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Format pesan sesuai permintaan
            let message = `PURCHASE ORDER\n`;
            message += `Masa Muda Coffee and Space\n`;
            message += `No. PO: ${byId('po-number').value || 'Tidak tersedia'}\n`;
            message += `Tanggal: ${poDate}\n\n`;
            
            message += `Kepada:\n`;
            message += `${supplier.nama_supplier || ''}\n`;
            message += `${supplier.alamat_supplier || ''}\n\n`;
            
            message += `Daftar Item:\n`;
            state.cart.forEach((item, index) => {
                message += `${index + 1}. ${item.name} - ${item.quantity} ${item.unit || ''}\n`;
            });
            
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            message += `\nTotal: ${formatCurrency(total)}\n\n`;
            message += `Terima kasih atas kerja samanya.`;
            
            // Encode message untuk URL
            const encodedMessage = encodeURIComponent(message);
            
            // Buka WhatsApp dengan pesan yang sudah terisi
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            
            showNotification('Membuka WhatsApp...', 'info');
        }

        // --- Submit Purchase ---
        async function submitPurchase() {
            const telegramId = getTelegramId();
            showNotification('Mengirim data pembelian...', 'info');
            
            // Log untuk debugging
            console.log('Telegram ID dari URL:', telegramId);
            
            const formData = collectFormData();
            console.log('Data yang dikirim ke webhook:', formData);
            
            try {
                const result = await postData(WH_SUBMIT_FORM, formData);
                if (result) {
                    showNotification('Data pembelian berhasil dikirim!', 'success');
                    alert('Pembelian berhasil dikirim!');
                    // Reset form or redirect to success page
                    resetForm();
                }
            } catch (error) {
                showNotification('Gagal mengirim data pembelian', 'error');
                console.error('Error details:', error);
            }
        }

        function resetForm() {
            // Reset form to initial state
            byId('purchase-type').value = 'purchase_order';
            byId('po-number').value = '';
            byId('supplier').value = '';
            byId('purchase-date').value = new Date().toISOString().split('T')[0];
            byId('payment-date').value = new Date().toISOString().split('T')[0];
            state.cart = [];
            state.currentDraft = null;
            state.shippingEnabled = false;
            state.paymentMethod = null;
            state.paymentDate = '';
            state.paymentStatus = false;
            state.paidAmount = 0;
            state.paymentNotes = '';
            byId('shipping-toggle').checked = false;
            byId('shipping-form').classList.remove('active');
            byId('payment-status').checked = false;
            byId('paid-amount').value = '';
            byId('payment-notes').value = '';
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            updatePaymentStatusText();
            renderCart();
            navigateToStep(1);
        }

        // --- Helper & Utility functions ---
        function collectFormData() {
            const telegramId = getTelegramId();
            
            return {
                purchaseType: byId('purchase-type').value,
                poNumber: byId('po-number').value,
                supplier: byId('supplier').value,
                purchaseDate: byId('purchase-date').value,
                paymentDate: state.paymentDate,
                paymentMethod: state.paymentMethod,
                paymentStatus: state.paymentStatus ? 'paid' : 'pending',
                paidAmount: state.paidAmount,
                paymentNotes: state.paymentNotes,
                cart: state.cart,
                telegramId: telegramId,
                timestamp: new Date().toISOString()
            };
        }
        
        function renderCart() {
            const container = byId('item-list-container');
            if (state.cart.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">Keranjang masih kosong</p>';
                updateTotalSummary();
                return;
            }
            
            container.innerHTML = state.cart.map(item => `
                <div class="item-card" data-sku="${item.sku}">
                    <div class="item-card-info" onclick="openEditItemModal('${item.sku}')">
                        <div class="item-card-name">${item.name}</div>
                        <div class="item-card-price">${formatCurrency(item.price)} per ${item.unit || 'unit'}</div>
                        ${item.description ? `<div class="item-card-description" style="font-size: 0.8rem; color: var(--gray); margin-top: 4px;">${item.description}</div>` : ''}
                    </div>
                    <div class="item-card-actions">
                        <button class="quantity-btn minus" data-sku="${item.sku}">-</button>
                        <input type="text" class="quantity-input" value="${item.quantity}" data-sku="${item.sku}">
                        <button class="quantity-btn plus" data-sku="${item.sku}">+</button>
                        <button class="remove-item-btn" data-sku="${item.sku}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners for quantity buttons
            container.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sku = this.dataset.sku;
                    const item = state.cart.find(i => i.sku === sku);
                    if (item) {
                        if (this.classList.contains('plus')) {
                            item.quantity++;
                        } else if (this.classList.contains('minus') && item.quantity > 1) {
                            item.quantity--;
                        }
                        renderCart();
                    }
                });
            });
            
            // Add event listeners for remove buttons
            container.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sku = this.dataset.sku;
                    state.cart = state.cart.filter(i => i.sku !== sku);
                    showNotification('Item dihapus dari keranjang', 'info');
                    renderCart();
                });
            });
            
            updateTotalSummary();
        }
        
        function updateTotalSummary() {
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const summaryContainer = byId('total-summary-container');
            summaryContainer.innerHTML = `
                <div class="summary-row total">Total: ${formatCurrency(total)}</div>
            `;
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        function generateReview() {
            const container = byId('review-container');
            const supplier = state.allSuppliers.find(s => s.id_supplier === byId('supplier').value);
            
            let html = `
                <div class="review-info">
                    <h4>Informasi Pembelian</h4>
                    <p><strong>Tipe:</strong> ${byId('purchase-type').value === 'purchase_order' ? 'Purchase Order' : 'Offline'}</p>
                    <p><strong>No. PO:</strong> ${byId('po-number').value}</p>
                    <p><strong>Supplier:</strong> ${supplier ? supplier.nama_supplier : 'Tidak diketahui'}</p>
                    <p><strong>Tanggal:</strong> ${new Date(byId('purchase-date').value).toLocaleDateString('id-ID')}</p>
                </div>
                <div class="review-items">
                    <h4>Item Pembelian</h4>
            `;
            
            state.cart.forEach(item => {
                html += `
                    <div class="item-card">
                        <div class="item-card-info">
                            <div class="item-card-name">${item.name}</div>
                            <div class="item-card-price">${formatCurrency(item.price)} x ${item.quantity} ${item.unit || ''}</div>
                            ${item.description ? `<div class="item-card-description" style="font-size: 0.8rem; color: var(--gray); margin-top: 4px;">${item.description}</div>` : ''}
                        </div>
                        <div class="item-card-actions">
                            <span>${formatCurrency(item.price * item.quantity)}</span>
                        </div>
                    </div>
                `;
            });
            
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            html += `
                </div>
                <div class="review-total">
                    <h4>Ringkasan Total</h4>
                    <div class="summary-row total">Total: ${formatCurrency(total)}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function handleItemSearch() {
            const query = byId('item-search').value.toLowerCase();
            const resultsContainer = byId('item-search-results');
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const filteredItems = state.allItems.filter(item => 
                item.name.toLowerCase().includes(query) || 
                (item.sku && item.sku.toLowerCase().includes(query))
            );
            
            if (filteredItems.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">Tidak ada hasil</div>';
            } else {
                resultsContainer.innerHTML = filteredItems.map(item => `
                    <div class="search-result-item" data-sku="${item.sku}">
                        <div class="item-card-name">${item.name}</div>
                        <div class="item-card-price">SKU: ${item.sku} - ${formatCurrency(item.price)}</div>
                    </div>
                `).join('');
                
                // Add event listeners to search results
                resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const sku = this.dataset.sku;
                        const selectedItem = state.allItems.find(i => i.sku === sku);
                        if (selectedItem && !state.cart.find(i => i.sku === sku)) {
                            state.cart.push({ ...selectedItem, quantity: 1 });
                            renderCart();
                            showNotification(`"${selectedItem.name}" ditambahkan ke keranjang`, 'success');
                        } else if (state.cart.find(i => i.sku === sku)) {
                            showNotification(`"${selectedItem.name}" sudah ada di keranjang`, 'warning');
                        }
                        byId('item-search').value = '';
                        resultsContainer.classList.add('hidden');
                    });
                });
            }
            
            resultsContainer.classList.remove('hidden');
        }
        
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                throw error;
            }
        }
        
        async function postData(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                throw error;
            }
        }
        
        function setupModal(modalId) {
            const modal = byId(modalId);
            modal.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => closeModal(modalId));
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modalId);
                }
            });
        }
        
        function closeModal(modalId) {
            byId(modalId).classList.remove('show');
        }

        // --- History Functions ---
        // Fungsi untuk mengambil data history
        async function fetchHistory() {
            showNotification('Memuat riwayat pembelian...', 'info');
            
            try {
                const response = await fetchData(WH_GET_HISTORY);
                
                if (response && Array.isArray(response)) {
                    // PERBAIKAN: Urutkan history berdasarkan row_number (terbaru di atas)
                    state.history = response.sort((a, b) => {
                        const rowA = a.row_number || 0;
                        const rowB = b.row_number || 0;
                        return rowB - rowA; // Descending order (terbaru pertama)
                    });
                    state.filteredHistory = [...state.history];
                    renderHistory();
                    showNotification(`Berhasil memuat ${response.length} riwayat pembelian`, 'success');
                } else {
                    showNotification('Format data history tidak valid', 'error');
                    state.history = [];
                    state.filteredHistory = [];
                    renderHistory();
                }
            } catch (error) {
                showNotification('Gagal memuat riwayat pembelian', 'error');
                state.history = [];
                state.filteredHistory = [];
                renderHistory();
            }
        }

        // Fungsi untuk mencari history
        function searchHistory() {
            const query = byId('history-search').value.toLowerCase().trim();
            
            if (!query) {
                state.filteredHistory = [...state.history];
            } else {
                state.filteredHistory = state.history.filter(item => 
                    (item.poNumber && item.poNumber.toLowerCase().includes(query)) ||
                    (item.supplier && item.supplier.toLowerCase().includes(query)) ||
                    (item.items && JSON.stringify(item.items).toLowerCase().includes(query))
                );
            }
            
            renderHistory();
        }

        // Fungsi untuk render history
        function renderHistory() {
            const container = byId('history-list-container');
            
            if (state.filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="history-empty">
                        <i class="fas fa-inbox"></i>
                        <p>Tidak ada riwayat pembelian</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">${state.history.length === 0 ? 'Data history belum tersedia' : 'Tidak ada hasil pencarian'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.filteredHistory.map(item => {
                const items = item.items ? (typeof item.items === 'string' ? JSON.parse(item.items) : item.items) : [];
                const itemNames = items.slice(0, 3).map(i => i.name);
                const totalItems = items.length;
                
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-po-number">${item.poNumber || 'Tidak ada nomor PO'}</div>
                            <div class="history-status ${item.paymentStatus === 'paid' ? 'status-paid' : 'status-pending'}">
                                ${item.paymentStatus === 'paid' ? 'LUNAS' : 'PENDING'}
                            </div>
                        </div>
                        
                        <div class="history-details">
                            <div class="history-detail-item">
                                <span class="detail-label">Supplier</span>
                                <span>${item.supplier || 'Tidak diketahui'}</span>
                            </div>
                            <div class="history-detail-item">
                                <span class="detail-label">Tanggal</span>
                                <span>${item.purchaseDate ? new Date(item.purchaseDate).toLocaleDateString('id-ID') : 'Tidak diketahui'}</span>
                            </div>
                            <div class="history-detail-item">
                                <span class="detail-label">Metode Bayar</span>
                                <span>${getPaymentMethodText(item.paymentMethod)}</span>
                            </div>
                            <div class="history-detail-item">
                                <span class="detail-label">Total</span>
                                <span>${formatCurrency(calculateTotal(items))}</span>
                            </div>
                        </div>
                        
                        ${items.length > 0 ? `
                        <div class="history-items-preview">
                            <div class="items-preview-title">Item Pembelian (${totalItems})</div>
                            <div class="items-preview-list">
                                ${itemNames.map(name => `<span class="item-preview-tag">${name}</span>`).join('')}
                                ${totalItems > 3 ? `<span class="item-preview-tag">+${totalItems - 3} lainnya</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="history-actions">
                            <button class="btn btn-outline btn-sm view-detail-btn" data-po="${item.poNumber}">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                            <button class="btn btn-danger btn-sm delete-history-btn" data-po="${item.poNumber}">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // PERBAIKAN: Event listener untuk tombol detail history
            container.querySelectorAll('.view-detail-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const poNumber = this.dataset.po;
                    viewHistoryDetail(poNumber);
                });
            });
            
            // PERBAIKAN: Event listener untuk tombol hapus history
            container.querySelectorAll('.delete-history-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const poNumber = this.dataset.po;
                    openDeleteConfirm(poNumber);
                });
            });
        }

        // Fungsi helper untuk teks metode pembayaran
        function getPaymentMethodText(method) {
            const methods = {
                'tunai': 'Tunai',
                'transfer': 'Transfer',
                'kredit': 'Kredit'
            };
            return methods[method] || method || 'Tidak diketahui';
        }

        // Fungsi untuk menghitung total
        function calculateTotal(items) {
            return items.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        // Fungsi untuk membuka modal konfirmasi hapus
        function openDeleteConfirm(poNumber) {
            const item = state.history.find(h => h.poNumber === poNumber);
            if (!item) {
                showNotification('Data tidak ditemukan', 'error');
                return;
            }
            
            state.currentDeleteItem = item;
            
            byId('delete-po-number').textContent = item.poNumber || 'Tidak ada nomor PO';
            byId('delete-supplier').textContent = item.supplier || 'Tidak diketahui';
            byId('delete-date').textContent = item.purchaseDate ? new Date(item.purchaseDate).toLocaleDateString('id-ID') : 'Tidak diketahui';
            byId('delete-password').value = '';
            byId('confirm-delete-btn').disabled = true;
            
            byId('delete-confirm-modal').classList.add('show');
        }

        // Fungsi untuk validasi password hapus
        function validateDeletePassword() {
            const password = byId('delete-password').value;
            byId('confirm-delete-btn').disabled = password !== '1234';
        }

        // PERBAIKAN: Fungsi untuk konfirmasi hapus dengan POST method
        async function confirmDelete() {
            if (!state.currentDeleteItem) {
                showNotification('Tidak ada data yang dipilih untuk dihapus', 'error');
                return;
            }
            
            const poNumber = state.currentDeleteItem.poNumber;
            if (!poNumber) {
                showNotification('Nomor PO tidak valid', 'error');
                return;
            }
            
            showNotification('Menghapus data...', 'info');
            
            try {
                const deleteData = {
                    poNumber: poNumber,
                    telegramId: getTelegramId(),
                    timestamp: new Date().toISOString()
                };
                
                const result = await postData(WH_DELETE_HISTORY, deleteData);
                
                if (result && result.success) {
                    showNotification('Data berhasil dihapus', 'success');
                    closeModal('delete-confirm-modal');
                    fetchHistory(); // Refresh data history
                } else {
                    showNotification('Gagal menghapus data', 'error');
                    console.error('Delete failed:', result);
                }
            } catch (error) {
                showNotification('Gagal menghapus data: ' + error.message, 'error');
                console.error('Delete error:', error);
            }
        }

        // Fungsi untuk membuka modal konfirmasi hapus draft
        function openDeleteDraftConfirm(draftIndex) {
            const draft = state.allDrafts[draftIndex];
            if (!draft) {
                showNotification('Draft tidak ditemukan', 'error');
                return;
            }
            
            state.currentDeleteDraft = { index: draftIndex, draft: draft };
            
            byId('delete-draft-po-number').textContent = draft.poNumber || `Draft ${draft.row_number || draftIndex + 1}`;
            byId('delete-draft-supplier').textContent = getSupplierName(draft.supplier);
            byId('delete-draft-date').textContent = draft.purchaseDate ? new Date(draft.purchaseDate).toLocaleDateString('id-ID') : 'Tidak diketahui';
            byId('delete-draft-password').value = '';
            byId('confirm-delete-draft-btn').disabled = true;
            
            byId('delete-draft-modal').classList.add('show');
        }

        // Fungsi untuk validasi password hapus draft
        function validateDeleteDraftPassword() {
            const password = byId('delete-draft-password').value;
            byId('confirm-delete-draft-btn').disabled = password !== '1234';
        }

        // PERBAIKAN: Fungsi untuk konfirmasi hapus draft dengan POST method
        async function confirmDeleteDraft() {
            if (!state.currentDeleteDraft) {
                showNotification('Tidak ada draft yang dipilih untuk dihapus', 'error');
                return;
            }
            
            const { index, draft } = state.currentDeleteDraft;
            const draftName = draft.poNumber || `Draft ${draft.row_number || index + 1}`;
            
            showNotification('Menghapus draft...', 'info');
            
            try {
                const deleteData = {
                    namaDraft: draftName,
                    telegramId: getTelegramId(),
                    timestamp: new Date().toISOString()
                };
                
                const result = await postData(WH_DELETE_DRAFT, deleteData);
                
                if (result && result.success) {
                    showNotification('Draft berhasil dihapus', 'success');
                    closeModal('delete-draft-modal');
                    
                    // Hapus draft dari state dan refresh tampilan
                    state.allDrafts.splice(index, 1);
                    renderDraftList();
                } else {
                    showNotification('Gagal menghapus draft', 'error');
                    console.error('Delete draft failed:', result);
                }
            } catch (error) {
                showNotification('Gagal menghapus draft: ' + error.message, 'error');
                console.error('Delete draft error:', error);
            }
        }

        // PERBAIKAN: Fungsi untuk melihat detail history
        function viewHistoryDetail(poNumber) {
            const item = state.history.find(h => h.poNumber === poNumber);
            if (!item) {
                showNotification('Data tidak ditemukan', 'error');
                return;
            }
            
            // Tampilkan detail dalam modal atau alert
            const items = item.items ? (typeof item.items === 'string' ? JSON.parse(item.items) : item.items) : [];
            const itemsList = items.map(item => ` ${item.name} (${item.quantity} ${item.unit || ''}) - ${formatCurrency(item.price)}`).join('\n');
            
            const detailMessage = `
Nomor PO: ${item.poNumber || 'Tidak ada'}
Supplier: ${item.supplier || 'Tidak diketahui'}
Tanggal: ${item.purchaseDate ? new Date(item.purchaseDate).toLocaleDateString('id-ID') : 'Tidak diketahui'}
Metode Bayar: ${getPaymentMethodText(item.paymentMethod)}
Status: ${item.paymentStatus === 'paid' ? 'LUNAS' : 'PENDING'}

Items:
${itemsList} 

Total: ${formatCurrency(calculateTotal(items))}
            `;
            
            alert(detailMessage);
            showNotification(`Detail untuk PO: ${poNumber}`, 'info');
        }

        // Optimasi untuk touch devices
        document.addEventListener('DOMContentLoaded', function() {
            const poModal = byId('po-sheet-modal');
            
            // Prevent background scroll ketika modal PO terbuka
            poModal.addEventListener('show', function() {
                document.body.style.overflow = 'hidden';
            });
            
            poModal.addEventListener('hide', function() {
                document.body.style.overflow = '';
            });
            
            // Close modal dengan tap di luar konten (untuk mobile)
            poModal.addEventListener('click', function(e) {
                if (e.target === poModal) {
                    closeModal('po-sheet-modal');
                }
            });
        });

        // Fungsi untuk detect mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   window.innerWidth <= 768;
        }

        // Make openEditItemModal globally accessible
        window.openEditItemModal = openEditItemModal;

        // Run the app
        document.addEventListener('DOMContentLoaded', initializeApp);
    })();
    </script>
</body>
</html>
