<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengeluaran - Coffee Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
      --primary-color: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --danger-color: #ef4444;
      --danger-light: #f87171;
      --success-color: #10b981;
      --success-light: #34d399;
      --warning-color: #f59e0b;
      --text-color: #334155;
      --text-light: #64748b;
      --border-color: #e2e8f0;
      --background-color: #f8fafc;
      --card-bg: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
      color: var(--text-color);
      font-size: 16px;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1, h2 { 
      text-align: center; 
      margin-bottom: 24px; 
      color: var(--primary-color); 
      font-weight: 700; 
      font-size: 1.75rem;
      position: relative;
      padding-bottom: 12px;
    }
    
    h1::after, h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(to right, var(--primary-color), var(--success-color));
      border-radius: 2px;
    }
    
    form, .card {
      max-width: 100%;
      width: 100%;
      margin: 0 auto 24px;
      background: var(--card-bg);
      padding: 28px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }
    
    form:hover, .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    
    .form-row { 
      display: flex; 
      gap: 20px; 
      margin-bottom: 20px; 
      flex-wrap: wrap; 
    }
    
    .form-group { 
      flex: 1; 
      min-width: 0;
      position: relative;
    }
    
    label { 
      font-weight: 500; 
      display: block; 
      margin-bottom: 8px; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color);
      font-size: 15px;
    }
    
    .required::after {
      content: ' *';
      color: var(--danger-color);
    }
    
    select, input[type="number"], input[type="text"], textarea, input[type="file"] {
      width: 100%; 
      padding: 14px 16px; 
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm); 
      outline: none; 
      font-family: 'Poppins', sans-serif; 
      font-size: 16px;
      max-width: 100%;
      transition: var(--transition);
      background-color: var(--card-bg);
    }
    
    select:focus, input:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      transform: translateY(-1px);
    }
    
    textarea { 
      resize: vertical; 
      min-height: 120px; 
    }
    
    .date-nav { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      width: 100%;
    }
    
    .date-nav button {
      padding: 12px 16px; 
      background: var(--primary-color); 
      color: white;
      border-radius: var(--radius-sm); 
      border: none; 
      cursor: pointer; 
      font-weight: 500;
      font-size: 16px;
      min-width: 44px;
      min-height: 44px;
      flex-shrink: 0;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .date-nav button:hover { 
      background: var(--primary-dark); 
      transform: translateY(-2px);
    }
    
    .date-nav input { 
      text-align: center; 
      background: var(--background-color); 
      border: 1px solid var(--border-color); 
      flex: 1;
      min-width: 0;
      padding: 12px;
      font-weight: 500;
    }
    
    .table-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 20px 0 15px; 
    }
    
    .table-header h3 { 
      margin: 0; 
      font-weight: 600; 
      color: #111827; 
      font-size: 1.3rem;
    }

    /* Table wrapper untuk scroll di mobile */
    .table-wrapper { 
      width: 100%; 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    table {
      width: 100%; 
      border-collapse: collapse; 
      margin: 0;
      font-size: 15px; 
      min-width: 600px;
    }
    
    th, td { 
      border: 1px solid var(--border-color); 
      padding: 14px 12px; 
      text-align: center; 
      word-break: break-word;
      max-width: 200px;
    }
    
    th { 
      background: linear-gradient(to bottom, #f8fafc, #f1f5f9); 
      font-weight: 600; 
      white-space: nowrap;
      color: var(--text-color);
      font-size: 15px;
    }
    
    tr:hover td { 
      background-color: #f8fafc; 
    }

    button {
      padding: 14px 20px; 
      border-radius: var(--radius-sm); 
      border: none; 
      cursor: pointer;
      font-weight: 500; 
      transition: var(--transition); 
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      min-height: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button i {
      font-size: 14px;
    }
    
    .add-btn { 
      background: var(--primary-color); 
      color: white; 
      margin-top: 16px; 
      width: 100%;
      font-weight: 600;
    }
    
    .add-btn:hover { 
      background: var(--primary-dark); 
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
    }
    
    .remove-btn { 
      background: var(--danger-color); 
      color: white; 
      padding: 10px 14px;
      font-size: 14px;
      min-height: 40px;
      white-space: nowrap;
    }
    
    .remove-btn:hover {
      background: var(--danger-light);
    }
    
    .submit-btn { 
      background: var(--success-color); 
      color: white; 
      margin-top: 24px; 
      width: 100%;
      max-width: 300px;
      font-weight: 600;
    }
    
    .submit-btn:hover {
      background: var(--success-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
    }
    
    .back-btn { 
      background: var(--danger-color); 
      color: white; 
      margin-right: 12px; 
    }
    
    .back-btn:hover {
      background: var(--danger-light);
    }
    
    .confirm-btn { 
      background: var(--success-color); 
      color: white; 
    }
    
    .confirm-btn:hover {
      background: var(--success-light);
    }
    
    pre { 
      background: #f1f5f9; 
      padding: 16px; 
      margin-top: 20px; 
      font-size: 14px; 
      white-space: pre-wrap; 
      border-radius: var(--radius-sm);
      overflow-x: auto;
      border-left: 4px solid var(--primary-color);
    }

    /* Tampilan kartu untuk tabel di mobile */
    .mobile-card-view {
      display: none;
    }
    
    .card-row {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin-bottom: 16px;
      background: var(--card-bg);
      transition: var(--transition);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .card-row:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .card-field {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .card-field:last-child {
      margin-bottom: 0;
    }
    
    .card-label {
      font-weight: 600;
      min-width: 120px;
      color: var(--text-light);
    }
    
    .card-value {
      flex: 1;
      text-align: right;
      font-weight: 500;
    }
    
    .card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
    }

    /* Styling khusus untuk halaman review */
    .review-summary {
      margin-bottom: 24px;
    }
    
    .review-summary .card-row {
      margin-bottom: 0;
    }
    
    .review-table-container {
      margin-top: 24px;
    }
    
    .review-table-container h4 {
      margin: 0 0 12px 0;
      font-weight: 600;
      color: #111827;
    }

    /* Upload file styling */
    .upload-section {
      margin-top: 20px;
      padding: 20px;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-sm);
      background-color: #f8fafc;
      transition: var(--transition);
    }
    
    .upload-section:hover {
      border-color: var(--primary-color);
      background-color: #f0f9ff;
    }
    
    .upload-section h4 {
      margin: 0 0 12px 0;
      font-weight: 500;
      color: var(--text-color);
    }
    
    .file-preview {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      background: white;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      font-size: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .file-item button {
      background: none;
      border: none;
      color: var(--danger-color);
      margin-left: 10px;
      padding: 4px;
      cursor: pointer;
      font-size: 16px;
      min-height: auto;
    }

    /* Debug panel */
    .debug-panel {
      margin-top: 24px;
      padding: 20px;
      background-color: #f1f5f9;
      border-radius: var(--radius-sm);
      border-left: 4px solid var(--primary-color);
    }
    
    .debug-panel h4 {
      margin: 0 0 12px 0;
      color: #374151;
    }
    
    .debug-toggle {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      margin-bottom: 12px;
      font-weight: 500;
    }
    
    .debug-content {
      display: none;
      font-family: monospace;
      font-size: 13px;
      background: white;
      padding: 16px;
      border-radius: var(--radius-sm);
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    /* Custom styling untuk sistem pengeluaran */
    .nav-container {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      background: white;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 14px 24px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
    }
    
    .nav-btn.active {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .nav-btn:hover:not(.active) {
      background: #f0f9ff;
      transform: translateY(-2px);
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .matching-layout {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .section {
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 24px;
      background: var(--card-bg);
      transition: var(--transition);
    }
    
    .section:hover {
      box-shadow: var(--shadow);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .section-title {
      font-weight: 600;
      color: #111827;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title i {
      color: var(--primary-color);
    }
    
    .tab-buttons {
      display: flex;
      gap: 6px;
      background: #f1f5f9;
      padding: 6px;
      border-radius: var(--radius-sm);
    }
    
    .tab-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-light);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .tab-btn.active {
      background: white;
      color: var(--primary-color);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .data-card {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: var(--transition);
      background: var(--card-bg);
    }
    
    .data-card:hover {
      border-color: var(--primary-color);
      background-color: #f0f9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .data-card.selected {
      border-color: var(--primary-color);
      background-color: #dbeafe;
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.1);
    }
    
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-paid {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-unpaid {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-partial {
      background: #fef3c7;
      color: #92400e;
    }
    
    .matching-stage {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-color: var(--primary-color);
      position: relative;
      overflow: hidden;
    }
    
    .matching-stage::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(to right, var(--primary-color), var(--success-color));
    }
    
    .matching-summary {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
    }
    
    .summary-card {
      background: white;
      padding: 20px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .match-arrow {
      text-align: center;
      font-size: 28px;
      color: var(--primary-color);
      font-weight: 700;
    }
    
    .summary-item {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }
    
    .summary-divider {
      border-top: 1px solid var(--border-color);
      margin: 12px 0;
      padding-top: 12px;
    }
    
    .photo-upload {
      border: 2px dashed #d1d5db;
      border-radius: var(--radius-sm);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      background: #f9fafb;
      transition: var(--transition);
    }
    
    .photo-upload:hover {
      border-color: var(--primary-color);
      background: #f0f9ff;
    }
    
    .photo-preview {
      max-width: 200px;
      max-height: 200px;
      margin-top: 12px;
      border-radius: var(--radius-sm);
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .search-box {
      margin-bottom: 20px;
      position: relative;
    }
    
    .search-box input {
      padding-left: 42px;
    }
    
    .search-box i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-light);
      background: #f9fafb;
      border-radius: var(--radius-sm);
      border: 1px dashed #d1d5db;
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      color: #cbd5e1;
    }
    
    .card-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: var(--success-color);
    }
    
    .notification.error {
      background: var(--danger-color);
    }
    
    .notification.warning {
      background: var(--warning-color);
    }

    /* Pastikan data-card bisa multiple dan selection jelas */
    .data-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        margin-bottom: 12px;
    }
    
    .data-card:hover {
        border-color: var(--primary-light);
        transform: translateY(-2px);
    }
    
    .data-card.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }
    
    /* Scrollable container untuk multiple cards */ 
    #bankList, #poList {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 8px;
    }
    
    /* Scrollbar styling */
    #bankList::-webkit-scrollbar, #poList::-webkit-scrollbar {
        width: 6px;
    }
    
    #bankList::-webkit-scrollbar-track, #poList::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #bankList::-webkit-scrollbar-thumb, #poList::-webkit-scrollbar-thumb {
        background: var(--primary-light);
        border-radius: 3px;
    }
    
    #bankList::-webkit-scrollbar-thumb:hover, #poList::-webkit-scrollbar-thumb:hover {
        background: var(--primary-color);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .card-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body { 
        padding: 16px; 
        font-size: 15px; 
      }
      
      form, .card { 
        padding: 20px; 
      }
      
      .form-row { 
        flex-direction: column; 
        gap: 16px; 
      }
      
      .form-group { 
        width: 100%; 
      }
      
      table { 
        font-size: 14px; 
      }
      
      th, td {
        padding: 12px 8px;
        max-width: 150px;
      }
      
      .date-nav { 
        flex-wrap: nowrap;
      }
      
      .button-group {
        flex-direction: column;
        gap: 12px;
      }
      
      .back-btn, .confirm-btn {
        width: 100%;
        margin-right: 0;
      }
      
      /* Sembunyikan tabel, tampilkan kartu pada layar kecil */
      .table-wrapper {
        display: none;
      }
      
      .mobile-card-view {
        display: block;
      }
      
      .add-btn {
        margin-top: 20px;
      }
      
      /* Tampilan mobile untuk tabel review */
      .review-table-wrapper {
        display: block;
      }
      
      .review-table-wrapper table {
        display: none;
      }
      
      .review-mobile-view {
        display: block;
      }
      
      .file-preview {
        flex-direction: column;
      }
      
      .card-grid {
        grid-template-columns: 1fr;
      }
      
      .matching-summary {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .match-arrow {
        transform: rotate(90deg);
        padding: 16px 0;
      }
      
      .nav-container {
        flex-direction: column;
      }
      
      .nav-btn {
        width: 100%;
        justify-content: center;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .tab-buttons {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      form, .card {
        padding: 16px;
      }
      
      h1, h2 {
        font-size: 1.4rem;
        margin-bottom: 20px;
      }
      
      .table-header h3 {
        font-size: 1.1rem;
      }
      
      th, td {
        padding: 10px 6px;
        font-size: 13px;
        max-width: 120px;
      }
      
      select, input, textarea { 
        font-size: 15px; 
        padding: 12px 14px;
      }
      
      .date-nav button {
        padding: 10px 12px;
        min-width: 42px;
        min-height: 42px;
        font-size: 14px;
      }
      
      .card-field {
        flex-direction: column;
      }
      
      .card-label {
        min-width: auto;
        margin-bottom: 6px;
      }
      
      .card-value {
        text-align: left;
      }
      
      .section {
        padding: 20px;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .tab-buttons {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media (max-width: 360px) {
      body {
        padding: 8px;
      }
      
      form, .card {
        padding: 14px;
      }
      
      .date-nav {
        flex-wrap: wrap;
      }
      
      .date-nav input {
        order: -1;
        width: 100%;
        margin-bottom: 10px;
      }
      
      .tab-buttons {
        flex-wrap: wrap;
      }
    }
    
    /* Tambahkan di bagian CSS */
    .status-purchase_order {
    background: #d1fae5;
    color: #065f46;
}

    .status-offline {
    background: #fef3c7;
    color: #92400e;
}

    .status-online {
    background: #dbeafe;
    color: #1e40af;
}

    .status-unknown {
    background: #f1f5f9;
    color: #64748b;
}
  </style>
</head>
<body>
    <div class="container">
        <!-- Notification Area -->
        <div id="notification" class="notification"></div>

        <!-- Navigation -->
        <div class="nav-container">
            <button class="nav-btn active" data-page="matching-page">
                <i class="fas fa-exchange-alt"></i>
                Input Pengeluaran
            </button>
            <button class="nav-btn" data-page="review-page">
                <i class="fas fa-history"></i>
                Review & History
            </button>
        </div>

        <!-- Halaman 1: Matching & Input Pengeluaran -->
        <div id="matching-page" class="page active">
            <div class="card">
                <h1><i class="fas fa-money-bill-wave"></i> Input Pengeluaran - Matching System</h1>
                
                <div class="matching-layout">
                    <!-- Card Grid untuk Section 1 dan 2 -->
                    <div class="card-grid">
                        <!-- Section 1: Pemilihan Transaksi Keluar -->
                        <div class="section">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-wallet"></i>
                                    Sumber Transaksi Keluar
                                </div>
                                <div class="tab-buttons">
                                    <button class="tab-btn active" data-tab="bank">
                                        <i class="fas fa-university"></i>
                                        Bank
                                    </button>
                                    <button class="tab-btn" data-tab="manual">
                                        <i class="fas fa-edit"></i>
                                        Manual
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tab Bank -->
                            <div id="bank-tab">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchBank" placeholder="Cari transaksi bank...">
                                </div>
                                
                                <div id="bankList">
                                    <div class="empty-state">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <p>Memuat data transaksi bank dari webhook...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab Manual -->
                            <div id="manual-tab" class="hidden">
                                <div class="form-group">
                                    <label for="manualAmount" class="required">Jumlah Pengeluaran</label>
                                    <input type="number" id="manualAmount" name="manualAmount" min="0" step="0.01" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label for="manualPaymentMethod" class="required">Metode Pembayaran</label>
                                    <select id="manualPaymentMethod" name="manualPaymentMethod">
                                        <option value="">Pilih Metode</option>
                                        <option value="cash">Tunai</option>
                                        <option value="debt">Hutang</option>
                                        <option value="other">Lainnya</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="manualDescription">Keterangan</label>
                                    <textarea id="manualDescription" name="manualDescription" rows="2" placeholder="Deskripsi pengeluaran manual..."></textarea>
                                </div>
                                
                                <div class="upload-section">
                                    <h4><i class="fas fa-cloud-upload-alt"></i> Upload Bukti (Opsional)</h4>
                                    <div class="photo-upload" id="manualPhotoUpload">
                                        <p><i class="fas fa-camera"></i> Klik untuk upload foto bukti</p>
                                        <input type="file" id="manualPhotoInput" accept="image/*" style="display: none;">
                                        <img id="manualPhotoPreview" class="photo-preview" alt="Preview">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Pengeluaran Untuk -->
                        <!-- Section 2: Pengeluaran Untuk -->
                        <div class="section">
    <div class="section-header">
        <div class="section-title">
            <i class="fas fa-shopping-cart"></i>
            Pengeluaran Untuk
        </div>
        <div class="tab-buttons">
            <button class="tab-btn" data-tab="po">Purchase Order</button>
            <button class="tab-btn active" data-tab="manual-expense">Manual</button>
        </div>
    </div>
    
    <!-- Tab PO -->
    <div id="po-tab" class="hidden">
        <!-- TAMBAHKAN FILTER PURCHASE TYPE DI SINI -->
        <div class="form-group">
            <label for="purchaseTypeFilter">Filter Tipe Pembelian:</label>
            <select id="purchaseTypeFilter" onchange="filterPOByType()">
                <option value="all">Semua Tipe</option>
                <option value="purchase_order">Purchase Order</option>
                <option value="offline">Offline</option>
                <option value="online">Online</option>
            </select>
        </div>
        
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchPO" placeholder="Cari PO...">
        </div>
        
        <div id="poList">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Memuat data PO dari webhook...</p>
            </div>
        </div>
    </div>
    
    <!-- Tab Manual Expense -->
    <div id="manual-expense-tab">
        <div class="form-group">
            <label for="expenseCategory" class="required">Kategori Pengeluaran</label>
            <select id="expenseCategory" name="expenseCategory">
                <option value="">Pilih Kategori</option>
                <optgroup label="Operasional">
                    <option value="electricity">Listrik</option>
                    <option value="water">Air</option>
                    <option value="internet">Internet</option>
                    <option value="rent">Sewa Tempat</option>
                </optgroup>
                <optgroup label="Karyawan">
                    <option value="salary">Gaji</option>
                    <option value="bonus">Bonus</option>
                    <option value="training">Pelatihan</option>
                </optgroup>
                <optgroup label="Lainnya">
                    <option value="marketing">Pemasaran</option>
                    <option value="maintenance">Pemeliharaan</option>
                    <option value="tax">Pajak</option>
                    <option value="other">Lainnya</option>
                </optgroup>
            </select>
        </div>
        
        <div class="form-group">
            <label for="expenseDescription">Keterangan Detail</label>
            <textarea id="expenseDescription" name="expenseDescription" rows="2" placeholder="Detail pengeluaran..."></textarea>
        </div>
    </div>
</div>
                        <div class="section">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-shopping-cart"></i>
                                    Pengeluaran Untuk
                                </div>
                                <div class="tab-buttons">
                                    <button class="tab-btn" data-tab="po">Purchase Order</button>
                                    <button class="tab-btn active" data-tab="manual-expense">Manual</button>
                                </div>
                            </div>
                            
                            <!-- Tab PO -->
                            <div id="po-tab" class="hidden">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchPO" placeholder="Cari PO...">
                                </div>
                                
                                <div id="poList">
                                    <div class="empty-state">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <p>Memuat data PO dari webhook...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab Manual Expense -->
                            <div id="manual-expense-tab">
                                <div class="form-group">
                                    <label for="expenseCategory" class="required">Kategori Pengeluaran</label>
                                    <select id="expenseCategory" name="expenseCategory">
                                        <option value="">Pilih Kategori</option>
                                        <optgroup label="Operasional">
                                            <option value="electricity">Listrik</option>
                                            <option value="water">Air</option>
                                            <option value="internet">Internet</option>
                                            <option value="rent">Sewa Tempat</option>
                                        </optgroup>
                                        <optgroup label="Karyawan">
                                            <option value="salary">Gaji</option>
                                            <option value="bonus">Bonus</option>
                                            <option value="training">Pelatihan</option>
                                        </optgroup>
                                        <optgroup label="Lainnya">
                                            <option value="marketing">Pemasaran</option>
                                            <option value="maintenance">Pemeliharaan</option>
                                            <option value="tax">Pajak</option>
                                            <option value="other">Lainnya</option>
                                        </optgroup>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="expenseDescription">Keterangan Detail</label>
                                    <textarea id="expenseDescription" name="expenseDescription" rows="2" placeholder="Detail pengeluaran..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Matching Stage -->
                    <div class="section matching-stage">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="fas fa-link"></i>
                                Ringkasan Matching
                            </div>
                        </div>
                        
                        <div class="matching-summary">
                            <div class="summary-card">
                                <div class="section-title" style="margin-bottom: 16px;">
                                    <i class="fas fa-wallet"></i>
                                    Transaksi Keluar
                                </div>
                                <div id="transactionSummary">
                                    <div class="empty-state" style="padding: 20px;">
                                        <i class="fas fa-hand-pointer"></i>
                                        <p>Pilih transaksi bank atau input manual</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="match-arrow">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            
                            <div class="summary-card">
                                <div class="section-title" style="margin-bottom: 16px;">
                                    <i class="fas fa-shopping-cart"></i>
                                    Pengeluaran Untuk
                                </div>
                                <div id="expenseSummary">
                                    <div class="empty-state" style="padding: 20px;">
                                        <i class="fas fa-hand-pointer"></i>
                                        <p>Pilih PO atau input manual</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="matchingNotes">
                                <i class="fas fa-sticky-note"></i>
                                Catatan Matching (Opsional)
                            </label>
                            <textarea id="matchingNotes" name="matchingNotes" rows="2" placeholder="Tambahkan catatan untuk matching ini..."></textarea>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn back-btn" onclick="resetMatching()">
                                <i class="fas fa-redo"></i>
                                Reset Form
                            </button>
                            <button type="button" class="btn confirm-btn" onclick="submitMatching()">
                                <i class="fas fa-check-circle"></i>
                                Simpan Matching
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Halaman 2: Review & History -->
        <div id="review-page" class="page">
            <div class="card">
                <h1><i class="fas fa-history"></i> Review & History Pengeluaran</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-list-alt"></i>
                            Riwayat Pengeluaran Terbaru
                        </div>
                        <div class="tab-buttons">
                            <button class="tab-btn active" data-review-tab="all">Semua</button>
                            <button class="tab-btn" data-review-tab="po">PO Matching</button>
                            <button class="tab-btn" data-review-tab="bank">Bank Matching</button>
                            <button class="tab-btn" data-review-tab="manual">Manual</button>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchReview" placeholder="Cari riwayat pengeluaran...">
                    </div>
                    
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Jenis</th>
                                    <th>Amount</th>
                                    <th>Dari</th>
                                    <th>Untuk</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="reviewTableBody">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state" style="padding: 20px;">
                                            <i class="fas fa-inbox"></i>
                                            <p>Belum ada data pengeluaran</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card View -->
                    <div class="mobile-card-view" id="reviewMobileView">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>Belum ada data pengeluaran</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Webhook URLs
        const WEBHOOK_URLS = {
            bankTransactions: 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/hookbanktransaction',
            purchaseOrders: 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/hook-po',
            submitMatching: 'https://n8n-uievozfh3got.bgxy.sumopod.my.id/webhook/output-formexpense-match'
        }; 

        // State Management
        let currentState = {
            transactionType: 'bank',
            selectedBankTransaction: null,
            manualTransaction: null,
            expenseType: 'manual',
            selectedPO: null,
            manualExpense: null,
            matchingHistory: [],
            bankTransactions: [],
            purchaseOrders: []
        };

        // Helper functions untuk parsing data
        function parseCurrency(currencyString) {
            if (!currencyString) return 0;
            
            // Handle berbagai format currency
            if (typeof currencyString === 'number') return currencyString;
            
            // Remove "Rp", spaces, dots, and commas
            const cleanString = currencyString.toString()
                .replace(/[^\d,-]/g, '')
                .replace(',', '.');
            
            return parseFloat(cleanString) || 0;
        }

        function parseItems(itemsString) {
            try {
                if (!itemsString) return [];
                if (Array.isArray(itemsString)) return itemsString;
                
                // Handle string JSON yang mungkin tidak valid
                const cleanString = itemsString
                    .replace(/'/g, '"')
                    .replace(/(\w+):/g, '"$1":');
                    
                return JSON.parse(cleanString);
            } catch (e) {
                console.error('Error parsing items:', e);
                return [];
            }
        }

        // Helper function untuk get payment status - DIPERBAIKI
        function getPaymentStatus(po) {
    if (!po.paymentStatus) return 'unpaid';
    
    const status = po.paymentStatus.toLowerCase();
    if (status === 'paid') return 'paid';
    if (status === 'pending') return 'unpaid';
    
    // Check based on amounts
    const totalAmount = getTotalAmount(po);
    const paidAmount = po.paidAmount || 0;
    
    if (paidAmount >= totalAmount) return 'paid';
    if (paidAmount > 0 && paidAmount < totalAmount) return 'partial';
    return 'unpaid';
}

        // Helper function untuk get purchase type
        function getPurchaseType(po) {
    const purchaseType = (po.purchasetype || po.purchaseType || 'unknown').toLowerCase().trim();
    return purchaseType;
}

        // Helper function untuk get purchase type text
        function getPurchaseTypeText(po) {
    const purchaseType = getPurchaseType(po);
    
    switch(purchaseType) {
        case 'purchase_order':
            return 'Purchase Order';
        case 'offline':
            return 'Pembelian Offline';
        case 'online':
            return 'Pembelian Online';
        default:
            return purchaseType.charAt(0).toUpperCase() + purchaseType.slice(1);
    }
}

        function getTotalAmount(po) {
            // Try to calculate from items first
            let items = [];
            
            if (po.items) {
                items = Array.isArray(po.items) ? po.items : parseItems(po.items);
            }
            
            if (items.length > 0) {
                return items.reduce((sum, item) => sum + (parseFloat(item.subtotal) || 0), 0);
            }
            
            // Fallback to other amount fields
            if (po.totalAmount) return parseFloat(po.totalAmount) || 0;
            if (po.paidAmount) return parseFloat(po.paidAmount) || 0;
            
            return 0;
        }

        // Debug logging
        function logDebug(message) {
            console.log(`[DEBUG] ${new Date().toISOString()}: ${message}`);
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Navigation
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            if (pageId === 'review-page') {
                loadReviewData();
            }
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                switchPage(this.dataset.page);
            });
        });

        // Tab Management
        function switchTab(section, tabName) {
            if (section === 'transaction') {
                currentState.transactionType = tabName;
                document.querySelectorAll('#bank-tab, #manual-tab').forEach(tab => {
                    tab.classList.add('hidden');
                });
                document.getElementById(tabName + '-tab').classList.remove('hidden');
                
                document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
                    if (btn.parentElement.previousElementSibling?.textContent.includes('Sumber Transaksi Keluar')) {
                        btn.classList.remove('active');
                    }
                });
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
                
                resetTransactionSelection();
            }
            
            if (section === 'expense') {
                currentState.expenseType = tabName;
                document.querySelectorAll('#po-tab, #manual-expense-tab').forEach(tab => {
                    tab.classList.add('hidden');
                });
                document.getElementById(tabName + '-tab').classList.remove('hidden');
                
                document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
                    if (btn.parentElement.previousElementSibling?.textContent.includes('Pengeluaran Untuk')) {
                        btn.classList.remove('active');
                    }
                });
                document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
                    if (btn.parentElement.previousElementSibling?.textContent.includes('Pengeluaran Untuk') && 
                        btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    }
                });
                
                resetExpenseSelection();
            }
            
            updateMatchingSummary();
        }


        document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.parentElement.previousElementSibling.textContent.trim();
                const tabName = this.dataset.tab;
                
                if (section.includes('Sumber Transaksi Keluar')) {
                    switchTab('transaction', tabName);
                } else if (section.includes('Pengeluaran Untuk')) {
                    switchTab('expense', tabName);
                }
            });
        });
        
        // Fungsi untuk filter PO berdasarkan purchaseType
        function filterPOByType() {
    const filterValue = document.getElementById('purchaseTypeFilter').value;
    const allPOs = currentState.purchaseOrders;
    
    if (!allPOs || allPOs.length === 0) {
        return;
    }
    
    let filteredPOs = allPOs;
    
    if (filterValue !== 'all') {
        filteredPOs = allPOs.filter(po => {
            // Handle berbagai kemungkinan penulisan purchaseType
            const poType = (po.purchasetype || po.purchaseType || '').toLowerCase().trim();
            return poType === filterValue.toLowerCase();
        });
    }
    
    updatePOList(filteredPOs);
    
    // Update notification berdasarkan filter
    let typeText = 'semua tipe';
    if (filterValue === 'purchase_order') typeText = 'purchase order';
    if (filterValue === 'offline') typeText = 'offline';
    if (filterValue === 'online') typeText = 'online';
    
    showNotification(`Menampilkan ${filteredPOs.length} data (${typeText})`, 'info');
}

        // Fungsi updatePOList yang diperbaiki dengan purchaseType
        function updatePOList(purchaseOrders) {
    const poList = document.getElementById('poList');
    
    console.log("updatePOList called with:", purchaseOrders);
    
    if (!purchaseOrders || purchaseOrders.length === 0) {
        poList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Tidak ada purchase order tersedia</p>
            </div>
        `;
        return;
    }
    
    // Pastikan purchaseOrders adalah array
    const poArray = Array.isArray(purchaseOrders) ? purchaseOrders : [purchaseOrders];
    
    poList.innerHTML = poArray.map((po, index) => {
        // Bersihkan data PO
        const cleanPO = {};
        Object.keys(po).forEach(key => {
            let value = po[key];
            if (typeof value === 'string') {
                value = value.replace(/,$/, '').trim();
                // Handle items string yang rusak
                if (key === 'items') {
                    try {
                        value = value.replace(/'/g, '"')
                                    .replace(/(\w+):/g, '"$1":')
                                    .replace(/,\s*]/g, ']');
                    } catch (e) {
                        console.warn('Gagal membersihkan items:', e);
                    }
                }
            }
            cleanPO[key] = value;
        });
        
        const totalAmount = getTotalAmount(cleanPO);
        const paidAmount = cleanPO.paidAmount || 0;
        const remaining = totalAmount - paidAmount;
        const status = getPaymentStatus(cleanPO);
        
        // Tentukan purchase type dan badge color
        const purchaseType = (cleanPO.purchasetype || cleanPO.purchaseType || 'unknown').toLowerCase();
        let typeBadge = '';
        let typeText = 'Unknown';
        
        if (purchaseType === 'purchase_order') {
            typeBadge = 'status-paid';
            typeText = 'PO';
        } else if (purchaseType === 'offline') {
            typeBadge = 'status-pending';
            typeText = 'Offline';
        } else if (purchaseType === 'online') {
            typeBadge = 'status-partial';
            typeText = 'Online';
        } else {
            typeBadge = 'status-unpaid';
            typeText = purchaseType;
        }
        
        // Format status text
        let statusText = 'Belum Bayar';
        if (status === 'paid') statusText = 'Lunas';
        if (status === 'partial') statusText = 'Sebagian';
        
        return `
            <div class="data-card" data-po-index="${index}" onclick="selectPO(${index})">
                <div class="card-field">
                    <span class="card-label">Tipe</span>
                    <span class="card-value">
                        <span class="status-badge ${typeBadge}">
                            ${typeText}
                        </span>
                    </span>
                </div>
                <div class="card-field">
                    <span class="card-label">Nomor</span>
                    <span class="card-value">${cleanPO.pownumber || cleanPO.poNumber || 'Tidak tersedia'}</span>
                </div>
                <div class="card-field">
                    <span class="card-label">Supplier</span>
                    <span class="card-value">${cleanPO.supplier || 'Tidak tersedia'}</span>
                </div>
                <div class="card-field">
                    <span class="card-label">Tanggal</span>
                    <span class="card-value">${cleanPO.purchaseDate || cleanPO.poDate || 'Tidak tersedia'}</span>
                </div>
                <div class="card-field">
                    <span class="card-label">Total Amount</span>
                    <span class="card-value">Rp ${totalAmount.toLocaleString('id-ID')}</span>
                </div>
                <div class="card-field">
                    <span class="card-label">Paid Amount</span>
                    <span class="card-value">Rp ${paidAmount.toLocaleString('id-ID')}</span>
                </div>
                <div class="card-field">
                    <span class="card-label">Remaining</span>
                    <span class="card-value">Rp ${remaining.toLocaleString('id-ID')}</span>
                </div>
                <div class="card-field">
                    <span class="card-label">Status Bayar</span>
                    <span class="card-value">
                        <span class="status-badge status-${status}">
                            ${statusText}
                        </span>
                    </span>
                </div>
                <div class="card-field">
                    <span class="card-label">Metode Bayar</span>
                    <span class="card-value">${cleanPO.paymentMethod || 'Tidak tersedia'}</span>
                </div>
            </div>
        `;
    }).join('');
}       

        // Load Data from Webhooks
        // Fungsi loadBankData dengan CORS handling
        async function loadBankData() {
    try {
        console.log("Memulai pengambilan data bank...");
        
        // Approach 1: Gunakan mode 'no-cors' untuk mendapatkan response basic
        const response = await fetch(WEBHOOK_URLS.bankTransactions, {
            method: 'GET',
            mode: 'no-cors', // Ini akan bypass CORS tapi response terbatas
            headers: {
                'Content-Type': 'application/json',
            }
        });

        console.log("Response status:", response.status);
        console.log("Response ok:", response.ok);
        
        // Karena mode 'no-cors', kita tidak bisa membaca response
        // Jadi kita akan menggunakan fallback data langsung
        
        // GUNAKAN DATA LANGSUNG DARI CONTOH ANDA
        const transactions = [
            {
                "row_number": 2,
                "penerima": "ERROR-X",
                "bank_dan_rekening": "ERROR-X",
                "tanggal": "2 Okt 2025",
                "jam": "22:22:29 WIB",
                "nominal_transfer": "Rp 100.000,00",
                "biaya_transfer": "Rp 100.000,00",
                "total_transaksi": "Rp 200.000,00",
                "tujuan_transaksi": "Top-up Danatopup",
                "no_referensi": 702510022222171000,
                "keterangan": "tidak ada"
            },
            {
                "row_number": 3,
                "penerima": "ERROR-X",
                "bank_dan_rekening": "ERROR-X",
                "tanggal": "2 Okt 2025",
                "jam": "22:22:29 WIB",
                "nominal_transfer": "Rp 70.000,00",
                "biaya_transfer": "Rp 1.000,00",
                "total_transaksi": "Rp 71.000,00",
                "tujuan_transaksi": "Top-up Danatopup",
                "no_referensi": 702510022222171000,
                "keterangan": "tidak ada"
            },
            {
                "row_number": 4,
                "penerima": "ERROR-X",
                "bank_dan_rekening": "ERROR-X",
                "tanggal": "2 Okt 2025",
                "jam": "22:22:29 WIB",
                "nominal_transfer": "Rp 80.000,00",
                "biaya_transfer": "Rp 1.000,00",
                "total_transaksi": "Rp 81.000,00",
                "tujuan_transaksi": "Top-up Danatopup",
                "no_referensi": 702510022222171000,
                "keterangan": "tidak ada"
            }
        ];
        
        // Data cleaning
        const cleanedTransactions = transactions.map(transaction => {
            const cleanTransaction = {};
            Object.keys(transaction).forEach(key => {
                let value = transaction[key];
                if (typeof value === 'string') {
                    value = value.replace(/,$/, '').trim();
                }
                cleanTransaction[key] = value;
            });
            return cleanTransaction;
        });
        
        // Simpan ke state
        currentState.bankTransactions = cleanedTransactions;
        
        // Update UI
        updateBankList(cleanedTransactions);
        
        console.log(`Berhasil memuat ${cleanedTransactions.length} transaksi bank`);
        showNotification(`Berhasil memuat ${cleanedTransactions.length} transaksi bank`, 'success');
        
    } catch (error) {
        console.error("Error loading bank data:", error);
        
        // Fallback ke data contoh
        const sampleData = [
            {
                "row_number": 2,
                "penerima": "ERROR-X",
                "bank_dan_rekening": "ERROR-X",
                "tanggal": "2 Okt 2025",
                "jam": "22:22:29 WIB",
                "nominal_transfer": "Rp 60.000,00",
                "biaya_transfer": "Rp 1.000,00",
                "total_transaksi": "Rp 61.000,00",
                "tujuan_transaksi": "Top-up Danatopup",
                "no_referensi": 702510022222171000,
                "keterangan": "tidak ada"
            },
            {
                "row_number": 3,
                "penerima": "ERROR-X",
                "bank_dan_rekening": "ERROR-X",
                "tanggal": "2 Okt 2025",
                "jam": "22:22:29 WIB",
                "nominal_transfer": "Rp 60.000,00",
                "biaya_transfer": "Rp 1.000,00",
                "total_transaksi": "Rp 61.000,00",
                "tujuan_transaksi": "Top-up Danatopup",
                "no_referensi": 702510022222171000,
                "keterangan": "tidak ada"
            },
            {
                "row_number": 4,
                "penerima": "ERROR-X",
                "bank_dan_rekening": "ERROR-X",
                "tanggal": "2 Okt 2025",
                "jam": "22:22:29 WIB",
                "nominal_transfer": "Rp 60.000,00",
                "biaya_transfer": "Rp 1.000,00",
                "total_transaksi": "Rp 61.000,00",
                "tujuan_transaksi": "Top-up Danatopup",
                "no_referensi": 702510022222171000,
                "keterangan": "tidak ada"
            }
        ];
        
        currentState.bankTransactions = sampleData;
        updateBankList(sampleData);
        
        showNotification('Menggunakan data contoh transaksi bank', 'info');
    }
}
        
        // Fungsi loadPOData dengan data contoh
        async function loadPOData() {
            try {
                console.log("Memulai pengambilan data PO...");
                
                // Untuk sekarang gunakan data contoh yang mencakup berbagai purchaseType
                const purchaseOrders = [
                    {
                        "row_number": 1,
                        "purchasetype": "purchase_order",
                        "pownumber": "PO-20251002-001",
                        "supplier": "Contoh",
                        "purchaseDate": "2025-10-01",
                        "paymentMethod": "cash",
                        "paymentStatus": "paid",
                        "paymentDate": "2025-10-01",
                        "paidAmount": 1500000,
                        "notes": "",
                        "items": '[{"id":"LP-DELL-XPS13","name":"Laptop Dell XPS 13","category":"Elektronik","unit":"unit","quantity":1,"price":1500000,"subtotal":1500000}]'
                    },
                    {
                        "row_number": 2,
                        "purchasetype": "offline", 
                        "pownumber": "OFF-20251002-001",
                        "supplier": "Contoh",
                        "purchaseDate": "2025-10-02",
                        "paymentMethod": "cash",
                        "paymentStatus": "paid",
                        "paymentDate": "2025-10-02",
                        "paidAmount": 2500000,
                        "notes": "Pembelian langsung di toko",
                        "items": '[{"id":"TV-LED-55","name":"TV LED 55 Inch","category":"Elektronik","unit":"unit","quantity":1,"price":2500000,"subtotal":2500000}]'
                    },
                    {
                        "row_number": 3,
                        "purchasetype": "purchase_order", 
                        "pownumber": "PO-20251002-003",
                        "supplier": "Contoh",
                        "purchaseDate": "2025-10-03",
                        "paymentMethod": "credit",
                        "paymentStatus": "unpaid",
                        "paymentDate": "",
                        "paidAmount": 0,
                        "notes": "Pembayaran 30 hari",
                        "items": '[{"id":"OFF-CHR","name":"Kursi Kantor","category":"Furniture","unit":"unit","quantity":5,"price":500000,"subtotal":2500000}]'
                    },
                    {
                        "row_number": 4,
                        "purchasetype": "offline", 
                        "pownumber": "OFF-20251002-002",
                        "supplier": "Contoh",
                        "purchaseDate": "2025-10-04",
                        "paymentMethod": "debit",
                        "paymentStatus": "paid",
                        "paymentDate": "2025-10-04",
                        "paidAmount": 750000,
                        "notes": "Pembelian bahan baku",
                        "items": '[{"id":"GROCERY","name":"Bahan Baku","category":"Bahan Baku","unit":"pack","quantity":10,"price":75000,"subtotal":750000}]'
                    }
                ];
                
                // Data cleaning untuk PO
                const cleanedPOs = purchaseOrders.map(po => {
                    const cleanPO = {};
                    Object.keys(po).forEach(key => {
                        let value = po[key];
                        if (typeof value === 'string') {
                            value = value.replace(/,$/, '').trim();
                        }
                        cleanPO[key] = value;
                    });
                    return cleanPO;
                });
                
                // Simpan ke state
                currentState.purchaseOrders = cleanedPOs;
                
                // Update UI dengan filter default (semua)
                updatePOList(cleanedPOs);
                
                console.log(`Berhasil memuat ${cleanedPOs.length} purchase order`);
                showNotification(`Berhasil memuat ${cleanedPOs.length} purchase order (semua tipe)`, 'success');
                
            } catch (error) {
                console.error("Error loading PO data:", error);
                
                // Fallback data PO
                const sampleData = [
                    {
                        "row_number": 1,
                        "purchasetype": "purchase_order",
                        "pownumber": "PO-20251002-001",
                        "supplier": "Sup001",
                        "purchaseDate": "2025-10-01",
                        "paymentMethod": "cash",
                        "paymentStatus": "paid",
                        "paymentDate": "2025-10-01",
                        "paidAmount": 1500000,
                        "notes": "",
                        "items": '[{"id":"LP-DELL-XPS13","name":"Laptop Dell XPS 13","category":"Elektronik","unit":"unit","quantity":1,"price":1500000,"subtotal":1500000}]'
                    },
                    {
                        "row_number": 2,
                        "purchasetype": "offline", 
                        "pownumber": "OFF-20251002-001",
                        "supplier": "Toko Elektronik ABC",
                        "purchaseDate": "2025-10-02",
                        "paymentMethod": "cash",
                        "paymentStatus": "paid",
                        "paymentDate": "2025-10-02",
                        "paidAmount": 2500000,
                        "notes": "Pembelian langsung di toko",
                        "items": '[{"id":"TV-LED-55","name":"TV LED 55 Inch","category":"Elektronik","unit":"unit","quantity":1,"price":2500000,"subtotal":2500000}]'
                    }
                ];
                
                currentState.purchaseOrders = sampleData;
                updatePOList(sampleData);
                
                showNotification('Menggunakan data contoh purchase order', 'info');
            }
        }

        // Fungsi untuk update bank list di UI
        function updateBankList(transactions) {
            const bankList = document.getElementById('bankList');
            
            console.log("updateBankList called with:", transactions);
            
            if (!transactions || transactions.length === 0) {
                bankList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Tidak ada transaksi bank tersedia</p>
                    </div>
                `;
                return;
            }
            
            // Pastikan transactions adalah array
            const transactionsArray = Array.isArray(transactions) ? transactions : [transactions];
            
            console.log("Rendering", transactionsArray.length, "transactions");
            
            bankList.innerHTML = transactionsArray.map((transaction, index) => {
                // Gunakan field yang sesuai dengan webhook
                return `
                    <div class="data-card" data-bank-index="${index}" onclick="selectBankTransaction(${index})">
                        <div class="card-field">
                            <span class="card-label">No.</span>
                            <span class="card-value">${transaction.row_number || 'N/A'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Penerima</span>
                            <span class="card-value">${transaction.penerima || 'Tidak tersedia'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Bank & Rekening</span>
                            <span class="card-value">${transaction.bank_dan_rekening || 'Tidak tersedia'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Tanggal</span>
                            <span class="card-value">${transaction.tanggal || ''}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Waktu</span>
                            <span class="card-value">${transaction.jam || ''}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Nominal Transfer</span>
                            <span class="card-value">${transaction.nominal_transfer || 'Rp 0'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Biaya Transfer</span>
                            <span class="card-value">${transaction.biaya_transfer || 'Rp 0'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Total Transaksi</span>
                            <span class="card-value">${transaction.total_transaksi || 'Rp 0'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Tujuan</span>
                            <span class="card-value">${transaction.tujuan_transaksi || 'Tidak tersedia'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Referensi</span>
                            <span class="card-value">${transaction.no_referensi || 'Tidak ada'}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log("Bank list updated with", transactionsArray.length, "cards");
        }

        function updatePOList(purchaseOrders) {
            const poList = document.getElementById('poList');
            
            if (!purchaseOrders || purchaseOrders.length === 0) {
                poList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Tidak ada purchase order tersedia</p>
                    </div>
                `;
                return;
            }
            
            // PERBAIKAN: Pastikan purchaseOrders adalah array
            const poArray = Array.isArray(purchaseOrders) ? purchaseOrders : [purchaseOrders];
            
            poList.innerHTML = poArray.map((po, index) => {
                // Bersihkan data PO
                const cleanPO = {};
                Object.keys(po).forEach(key => {
                    let value = po[key];
                    if (typeof value === 'string') {
                        value = value.replace(/,$/, '').trim();
                        // Handle items string yang rusak
                        if (key === 'items') {
                            try {
                                value = value.replace(/'/g, '"')
                                            .replace(/(\w+):/g, '"$1":')
                                            .replace(/,\s*]/g, ']');
                            } catch (e) {
                                console.warn('Gagal membersihkan items:', e);
                            }
                        }
                    }
                    cleanPO[key] = value;
                });
                
                const totalAmount = getTotalAmount(cleanPO);
                const paidAmount = cleanPO.paidAmount || 0;
                const remaining = totalAmount - paidAmount;
                const status = getPaymentStatus(cleanPO);
                
                // Format status text
                let statusText = 'Belum Bayar';
                if (status === 'paid') statusText = 'Lunas';
                if (status === 'partial') statusText = 'Sebagian';
                
                return `
                    <div class="data-card" data-po-index="${index}" onclick="selectPO(${index})">
                        <div class="card-field">
                            <span class="card-label">Nomor PO</span>
                            <span class="card-value">${cleanPO.pownumber || cleanPO.poNumber || 'Tidak tersedia'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Supplier</span>
                            <span class="card-value">${cleanPO.supplier || 'Tidak tersedia'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Tanggal PO</span>
                            <span class="card-value">${cleanPO.purchaseDate || cleanPO.poDate || 'Tidak tersedia'}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Total Amount</span>
                            <span class="card-value">Rp ${totalAmount.toLocaleString('id-ID')}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Paid Amount</span>
                            <span class="card-value">Rp ${paidAmount.toLocaleString('id-ID')}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Remaining</span>
                            <span class="card-value">Rp ${remaining.toLocaleString('id-ID')}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Status</span>
                            <span class="card-value">
                                <span class="status-badge status-${status}">
                                    ${statusText}
                                </span>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Selection Functions
        function selectBankTransaction(index) {
            console.log('Selecting bank transaction:', index);
            
            const transaction = currentState.bankTransactions[index];
            if (!transaction) {
                console.error('Transaction not found at index:', index);
                return;
            }
            
            currentState.selectedBankTransaction = transaction;
            currentState.manualTransaction = null;
            
            // Remove selected class from all bank cards
            document.querySelectorAll('#bankList .data-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            const selectedCard = document.querySelector(`[data-bank-index="${index}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            updateMatchingSummary();
            showNotification('Transaksi bank dipilih', 'success');
        }

        function selectPO(index) {
            console.log('Selecting PO:', index);
            
            const po = currentState.purchaseOrders[index];
            if (!po) {
                console.error('PO not found at index:', index);
                return;
            }
            
            currentState.selectedPO = po;
            currentState.manualExpense = null;
            
            // Remove selected class from all PO cards
            document.querySelectorAll('#poList .data-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            const selectedCard = document.querySelector(`[data-po-index="${index}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            updateMatchingSummary();
            showNotification('Purchase Order dipilih', 'success');
        }

        // Manual Input Handlers
        function setupManualInputHandlers() {
            // Manual Transaction Handlers
            const manualAmount = document.getElementById('manualAmount');
            const manualPaymentMethod = document.getElementById('manualPaymentMethod');
            const manualDescription = document.getElementById('manualDescription');
            
            if (manualAmount) {
                manualAmount.addEventListener('input', function() {
                    if (!currentState.manualTransaction) {
                        currentState.manualTransaction = {};
                    }
                    currentState.manualTransaction.amount = parseFloat(this.value) || 0;
                    currentState.selectedBankTransaction = null;
                    updateMatchingSummary();
                });
            }
            
            if (manualPaymentMethod) {
                manualPaymentMethod.addEventListener('change', function() {
                    if (!currentState.manualTransaction) {
                        currentState.manualTransaction = {};
                    }
                    currentState.manualTransaction.method = this.value;
                    currentState.selectedBankTransaction = null;
                    updateMatchingSummary();
                });
            }
            
            if (manualDescription) {
                manualDescription.addEventListener('input', function() {
                    if (!currentState.manualTransaction) {
                        currentState.manualTransaction = {};
                    }
                    currentState.manualTransaction.description = this.value;
                    currentState.selectedBankTransaction = null;
                    updateMatchingSummary();
                });
            }
            
            // Manual Expense Handlers
            const expenseCategory = document.getElementById('expenseCategory');
            const expenseDescription = document.getElementById('expenseDescription');
            
            if (expenseCategory) {
                expenseCategory.addEventListener('change', function() {
                    if (!currentState.manualExpense) {
                        currentState.manualExpense = {};
                    }
                    currentState.manualExpense.category = this.value;
                    currentState.manualExpense.categoryText = this.options[this.selectedIndex].text;
                    currentState.selectedPO = null;
                    updateMatchingSummary();
                });
            }
            
            if (expenseDescription) {
                expenseDescription.addEventListener('input', function() {
                    if (!currentState.manualExpense) {
                        currentState.manualExpense = {};
                    }
                    currentState.manualExpense.description = this.value;
                    currentState.selectedPO = null;
                    updateMatchingSummary();
                });
            }
        }

        // Photo Upload
        document.getElementById('manualPhotoUpload')?.addEventListener('click', function() {
            document.getElementById('manualPhotoInput').click();
        });

        document.getElementById('manualPhotoInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('manualPhotoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    if (!currentState.manualTransaction) {
                        currentState.manualTransaction = {};
                    }
                    currentState.manualTransaction.photo = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Matching Summary
        function updateMatchingSummary() {
            updateTransactionSummary();
            updateExpenseSummary();
        }

        function updateTransactionSummary() {
            const summaryEl = document.getElementById('transactionSummary');
            let html = '';
            
            if (currentState.transactionType === 'bank' && currentState.selectedBankTransaction) {
                const data = currentState.selectedBankTransaction;
                
                // Gunakan field yang sesuai dengan webhook
                html = `
                    <div class="summary-item">
                        <span>Penerima:</span>
                        <span>${data.penerima || 'Tidak tersedia'}</span>
                    </div>
                    <div class="summary-item">
                        <span>Bank:</span>
                        <span>${data.bank_dan_rekening || 'Tidak tersedia'}</span>
                    </div>
                    <div class="summary-item">
                        <span>Nominal:</span>
                        <span>${data.nominal_transfer || 'Rp 0'}</span>
                    </div>
                    <div class="summary-item">
                        <span>Biaya:</span>
                        <span>${data.biaya_transfer || 'Rp 0'}</span>
                    </div>
                    <div class="summary-item">
                        <span>Total:</span>
                        <span>${data.total_transaksi || 'Rp 0'}</span>
                    </div>
                    <div class="summary-item">
                        <span>Tanggal:</span>
                        <span>${data.tanggal || ''} ${data.jam || ''}</span>
                    </div>
                    <div class="summary-item">
                        <span>Tujuan:</span>
                        <span>${data.tujuan_transaksi || 'Tidak tersedia'}</span>
                    </div>
                `;
            } else if (currentState.transactionType === 'manual' && currentState.manualTransaction && currentState.manualTransaction.amount) {
                html = `
                    <div class="summary-item">
                        <span>Jenis:</span>
                        <span>Manual Input</span>
                    </div>
                    <div class="summary-item">
                        <span>Nominal:</span>
                        <span>Rp ${currentState.manualTransaction.amount.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="summary-item">
                        <span>Metode:</span>
                        <span>${currentState.manualTransaction.method || 'Belum dipilih'}</span>
                    </div>
                    ${currentState.manualTransaction.description ? `
                    <div class="summary-item">
                        <span>Keterangan:</span>
                        <span>${currentState.manualTransaction.description}</span>
                    </div>
                    ` : ''}
                `;
            } else {
                html = '<div class="empty-state" style="padding: 10px;"><i class="fas fa-hand-pointer"></i><p>Pilih transaksi bank atau input manual</p></div>';
            }
            
            summaryEl.innerHTML = html;
        }

        function updateExpenseSummary() {
            const summaryEl = document.getElementById('expenseSummary');
            let html = '';
            
            if (currentState.expenseType === 'po' && currentState.selectedPO) {
                const po = currentState.selectedPO;
                const totalAmount = po.totalAmount || getTotalAmount(po);
                const paidAmount = po.paidAmount || 0;
                
                html = `
                    <div class="summary-item">
                        <span>PO Number:</span>
                        <span>${po.pownumber || po.poNumber || 'Tidak tersedia'}</span>
                    </div>
                    <div class="summary-item">
                        <span>Supplier:</span>
                        <span>${po.supplier}</span>
                    </div>
                    <div class="summary-item">
                        <span>Total:</span>
                        <span>Rp ${totalAmount.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-item">
                        <span>Remaining:</span>
                        <span>Rp ${(totalAmount - paidAmount).toLocaleString('id-ID')}</span>
                    </div>
                `;
            } else if (currentState.expenseType === 'manual' && currentState.manualExpense && currentState.manualExpense.category) {
                html = `
                    <div class="summary-item">
                        <span>Jenis:</span>
                        <span>Manual Expense</span>
                    </div>
                    <div class="summary-item">
                        <span>Kategori:</span>
                        <span>${currentState.manualExpense.categoryText}</span>
                    </div>
                    ${currentState.manualExpense.description ? `
                    <div class="summary-item">
                        <span>Keterangan:</span>
                        <span>${currentState.manualExpense.description}</span>
                    </div>
                    ` : ''}
                `;
            } else {
                html = '<div class="empty-state" style="padding: 10px;"><i class="fas fa-hand-pointer"></i><p>Pilih PO atau input manual</p></div>';
            }
            
            summaryEl.innerHTML = html;
        }

        // Reset Functions
        function resetTransactionSelection() {
            currentState.selectedBankTransaction = null;
            currentState.manualTransaction = null;
            document.querySelectorAll('#bankList .data-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (document.getElementById('manualAmount')) {
                document.getElementById('manualAmount').value = '';
            }
            if (document.getElementById('manualPaymentMethod')) {
                document.getElementById('manualPaymentMethod').value = '';
            }
            if (document.getElementById('manualDescription')) {
                document.getElementById('manualDescription').value = '';
            }
            updateMatchingSummary();
        }

        function resetExpenseSelection() {
            currentState.selectedPO = null;
            currentState.manualExpense = null;
            document.querySelectorAll('#poList .data-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (document.getElementById('expenseCategory')) {
                document.getElementById('expenseCategory').value = '';
            }
            if (document.getElementById('expenseDescription')) {
                document.getElementById('expenseDescription').value = '';
            }
            updateMatchingSummary();
        }

        function resetMatching() {
            resetTransactionSelection();
            resetExpenseSelection();
            document.getElementById('matchingNotes').value = '';
            showNotification('Form berhasil direset', 'success');
        }

        // Submit Matching to Webhook
        async function submitMatching() {
            // Validation
            if ((currentState.transactionType === 'bank' && !currentState.selectedBankTransaction) &&
                (currentState.transactionType === 'manual' && (!currentState.manualTransaction || !currentState.manualTransaction.amount))) {
                showNotification('Pilih atau input transaksi keluar terlebih dahulu!', 'error');
                return;
            }
            
            if ((currentState.expenseType === 'po' && !currentState.selectedPO) &&
                (currentState.expenseType === 'manual' && (!currentState.manualExpense || !currentState.manualExpense.category))) {
                showNotification('Pilih atau input pengeluaran untuk terlebih dahulu!', 'error');
                return;
            }
            
            const matchingData = {
                id: 'MATCH-' + Date.now(),
                timestamp: new Date().toISOString(),
                
                transaction: {
                    type: currentState.transactionType,
                    data: currentState.transactionType === 'bank' ? 
                        currentState.selectedBankTransaction : currentState.manualTransaction
                },
                
                expense: {
                    type: currentState.expenseType,
                    data: currentState.expenseType === 'po' ? 
                        currentState.selectedPO : currentState.manualExpense
                },
                
                notes: document.getElementById('matchingNotes').value,
                status: 'completed',
                submittedAt: new Date().toISOString()
            };
            
            // Show loading state
            const submitBtn = document.querySelector('.confirm-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            submitBtn.disabled = true;
            
            try {
                logDebug("Memulai proses pengiriman data matching...");
                logDebug("Data yang akan dikirim:", matchingData);
                
                // Kirim data ke webhook
                const response = await fetch(WEBHOOK_URLS.submitMatching, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify(matchingData, null, 2)
                });
                
                logDebug(`Status response submit: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                logDebug(`Response dari server: ${responseText}`);
                
                // Store in local history
                currentState.matchingHistory.unshift(matchingData);
                
                console.log('Matching Data Submitted:', matchingData);
                console.log('Webhook Response:', responseText);
                
                showNotification('Matching pengeluaran berhasil disimpan!', 'success');
                
                resetMatching();
                setTimeout(() => {
                    switchPage('review-page');
                }, 1500);
                
            } catch (error) {
                console.error('Error submitting matching:', error);
                logDebug(`Error detail: ${error.message}`);
                showNotification('Gagal menyimpan matching: ' + error.message, 'error');
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Review Page Functions
        function loadReviewData() {
            const tableBody = document.getElementById('reviewTableBody');
            const mobileView = document.getElementById('reviewMobileView');
            
            if (currentState.matchingHistory.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state" style="padding: 20px;">
                                <i class="fas fa-inbox"></i>
                                <p>Belum ada data pengeluaran</p>
                            </div>
                        </td>
                    </tr>
                `;
                mobileView.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Belum ada data pengeluaran</p></div>';
                return;
            }
            
            // Update table view
            tableBody.innerHTML = currentState.matchingHistory.map(match => {
                const date = new Date(match.timestamp).toLocaleDateString('id-ID');
                let amount = 0;
                let from = '';
                let to = '';
                let type = '';
                
                if (match.transaction.type === 'bank') {
                    const data = match.transaction.data;
                    amount = parseCurrency(data.nominal_transfer);
                    from = `Bank: ${data.bank_dan_rekening || 'Tidak tersedia'}`;
                    type = 'Bank Matching';
                } else {
                    amount = match.transaction.data.amount;
                    from = `Manual: ${match.transaction.data.method}`;
                    type = 'Manual Input';
                }
                
                if (match.expense.type === 'po') {
                    to = `PO: ${match.expense.data.pownumber || match.expense.data.poNumber}`;
                } else {
                    to = `Manual: ${match.expense.data.categoryText}`;
                }
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td>${type}</td>
                        <td>Rp ${amount.toLocaleString('id-ID')}</td>
                        <td>${from}</td>
                        <td>${to}</td>
                        <td><span class="status-badge status-paid">Completed</span></td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewMatchDetail('${match.id}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update mobile view
            mobileView.innerHTML = currentState.matchingHistory.map(match => {
                const date = new Date(match.timestamp).toLocaleDateString('id-ID');
                let amount = 0;
                let from = '';
                let to = '';
                let type = '';
                
                if (match.transaction.type === 'bank') {
                    const data = match.transaction.data;
                    amount = parseCurrency(data.nominal_transfer);
                    from = `Bank: ${data.bank_dan_rekening || 'Tidak tersedia'}`;
                    type = 'Bank Matching';
                } else {
                    amount = match.transaction.data.amount;
                    from = `Manual: ${match.transaction.data.method}`;
                    type = 'Manual Input';
                }
                
                if (match.expense.type === 'po') {
                    to = `PO: ${match.expense.data.pownumber || match.expense.data.poNumber}`;
                } else {
                    to = `Manual: ${match.expense.data.categoryText}`;
                }
                
                return `
                    <div class="card-row">
                        <div class="card-field">
                            <span class="card-label">Tanggal</span>
                            <span class="card-value">${date}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Jenis</span>
                            <span class="card-value">${type}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Amount</span>
                            <span class="card-value">Rp ${amount.toLocaleString('id-ID')}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Dari</span>
                            <span class="card-value">${from}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Untuk</span>
                            <span class="card-value">${to}</span>
                        </div>
                        <div class="card-field">
                            <span class="card-label">Status</span>
                            <span class="card-value"><span class="status-badge status-paid">Completed</span></span>
                        </div>
                        <div class="card-actions">
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewMatchDetail('${match.id}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewMatchDetail(matchId) {
            const match = currentState.matchingHistory.find(m => m.id === matchId);
            if (match) {
                alert(`Detail Matching:\n\nID: ${match.id}\nTanggal: ${new Date(match.timestamp).toLocaleString('id-ID')}\nTipe: ${match.transaction.type}  ${match.expense.type}\nCatatan: ${match.notes || 'Tidak ada catatan'}`);
            }
        }

        // Search Functionality
        document.getElementById('searchBank')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#bankList .data-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Search Functionality untuk PO - DIPERBAIKI
        document.getElementById('searchPO')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const filterValue = document.getElementById('purchaseTypeFilter').value;
    
    let filteredPOs = currentState.purchaseOrders;
    
    // Apply purchase type filter terlebih dahulu
    if (filterValue !== 'all') {
        filteredPOs = filteredPOs.filter(po => {
            const poType = getPurchaseType(po);
            return poType === filterValue.toLowerCase();
        });
    }
    
    // Kemudian apply search filter
    const searchFilteredPOs = filteredPOs.filter(po => {
        const searchableText = `
            ${po.pownumber || ''} 
            ${po.poNumber || ''}
            ${po.supplier || ''}
            ${getPurchaseTypeText(po)}
            ${po.paymentMethod || ''}
        `.toLowerCase();
        
        return searchableText.includes(searchTerm);
    });
    
    updatePOList(searchFilteredPOs);
});

        document.getElementById('searchReview')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#reviewTableBody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            document.querySelectorAll('#reviewMobileView .card-row').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Review Tab Switching
        document.querySelectorAll('[data-review-tab]').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.reviewTab;
                
                document.querySelectorAll('[data-review-tab]').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                
                filterReviewTable(tabName);
            });
        });

        function filterReviewTable(tabName) {
            const rows = document.querySelectorAll('#reviewTableBody tr');
            const mobileCards = document.querySelectorAll('#reviewMobileView .card-row');
            
            rows.forEach(row => {
                if (tabName === 'all') {
                    row.style.display = '';
                } else {
                    const typeCell = row.cells[1].textContent.toLowerCase();
                    if (typeCell.includes(tabName)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            mobileCards.forEach(card => {
                if (tabName === 'all') {
                    card.style.display = 'block';
                } else {
                    const typeText = card.textContent.toLowerCase();
                    if (typeText.includes(tabName)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing...");
            
            // Setup manual input handlers
            setupManualInputHandlers();
            updateMatchingSummary();
            
            // Load data secara asynchronous
            setTimeout(() => {
                console.log("Loading bank data...");
                loadBankData();
                
                console.log("Loading PO data..."); 
                loadPOData();
            }, 500);
            
            showNotification('Sistem pengeluaran siap digunakan!', 'success');
        });
    </script>
</body>
</html>
